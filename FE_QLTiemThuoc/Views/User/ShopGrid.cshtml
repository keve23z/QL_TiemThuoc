@{
    Layout = "~/Views/Shared/UserSH/_LayoutUser.cshtml";
    ViewData["Title"] = "Danh sách thuốc";
}

@model List<System.Text.Json.JsonElement>

<div class="shop-area bg py-90">
    <div class="container">
        <style>
            /* Clamp product title to 2 lines with ellipsis */
            .product-title a {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.2;
                max-height: 2.4em; /* 2 lines */
                color: inherit;
            }
            /* Fix double-arrow on select inside sort box: hide native arrow and draw a single caret */
            .shop-sort-box { position: relative; }
            .shop-sort-box .form-select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: none;
                padding-right: 2.2rem; /* space for custom caret */
            }
            .shop-sort-box::after {
                content: '\25BE'; /* small down-pointing triangle */
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
                color: rgba(0,0,0,0.6);
                font-size: 0.9rem;
            }
        </style>
        <div class="row">
            <!-- Sidebar trái -->
            <div class="col-lg-3 col-md-4">
                <div class="shop-sidebar">
                    <!-- Ô tìm kiếm -->
                    <div class="shop-widget">
                        <div class="shop-search-form">
                            <h4 class="shop-widget-title">Tìm kiếm</h4>
                            <form method="get" action="/User/ShopGrid">
                                <div class="form-group">
                                    <input type="text" id="shopSearchInput" name="search" value="@ViewBag.Search" class="form-control" placeholder="Nhập tên hoặc mã thuốc...">
                                    <button type="submit"><i class="far fa-search"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Danh mục thuốc -->
                    <div class="shop-widget">
                        <h4 class="shop-widget-title">Danh mục thuốc</h4>
                        <ul class="shop-category-list">
                            @if (ViewBag.Categories != null)
                            {
                                var categories = (List<System.Text.Json.JsonElement>)ViewBag.Categories;
                                foreach (var cat in categories)
                                {
                                    var tenLoai = cat.TryGetProperty("tenLoaiThuoc", out var ten) ? ten.GetString() : "Không rõ";
                                    var maLoai = cat.TryGetProperty("maLoaiThuoc", out var ma) ? ma.GetString() : "";
                                    var soLuong = cat.TryGetProperty("soLuongThuoc", out var sl) ? sl.GetInt32() : 0;

                                    var isActive = ViewBag.Category != null && ViewBag.Category.ToString() == maLoai;

                                    <li class="@(isActive ? "active" : "")">
                                        <a href="/User/ShopGrid?category=@maLoai">@tenLoai <span>(@soLuong)</span></a>
                                    </li>
                                }
                            }
                            else
                            {
                                <li>Không có dữ liệu</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Nội dung phải -->
            <div class="col-lg-9 col-md-8">
                <!-- Thanh sắp xếp (styled) -->
                <div class="shop-sort mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <form method="get" action="/User/ShopGrid" class="d-flex align-items-center shop-sort-box">
                            <input type="hidden" name="search" value="@ViewBag.Search" />
                            <input type="hidden" name="category" value="@ViewBag.Category" />
                            <div class="shop-sorty-label me-2">Sắp xếp:</div>
                            @{ var sort = ViewBag.Sort as string ?? ""; }
                            <select name="sort" class="form-select form-select-sm select" onchange="this.form.submit()">
                                @if (String.IsNullOrEmpty(sort)) {
                                    <option value="" selected>Mặc định</option>
                                } else {
                                    <option value="">Mặc định</option>
                                }

                                @if (sort == "price_asc") {
                                    <option value="price_asc" selected>Giá tăng dần</option>
                                } else {
                                    <option value="price_asc">Giá tăng dần</option>
                                }

                                @if (sort == "price_desc") {
                                    <option value="price_desc" selected>Giá giảm dần</option>
                                } else {
                                    <option value="price_desc">Giá giảm dần</option>
                                }
                            </select>
                            <div class="shop-sort-show ms-3">Hiển thị 1-@Math.Min(21, Model?.Count ?? 0) trong @(Model?.Count ?? 0) kết quả</div>
                        </form>

                        <div class="shop-sort-gl ms-3">
                            <a href="@Url.Action("ShopGrid", "User", new { view = "grid", search = ViewBag.Search, category = ViewBag.Category, sort = ViewBag.Sort })" class="shop-sort-grid @( (ViewBag.View == null || (string)ViewBag.View == "grid") ? "active" : "")"><i class="far fa-grid-round-2"></i></a>
                            <a href="@Url.Action("ShopGrid", "User", new { view = "list", search = ViewBag.Search, category = ViewBag.Category, sort = ViewBag.Sort })" class="shop-sort-list @(((string)ViewBag.View == "list") ? "active" : "")"><i class="far fa-list-ul"></i></a>
                        </div>
                    </div>
                </div>
                <!-- Danh sách thuốc -->
                <div class="shop-item-wrap item-4">
                    <div class="row g-4">
                        @if (Model != null && Model.Count > 0)
                        {
                            foreach (var item in Model)
                            {
                                var tenThuoc = item.GetProperty("tenThuoc").GetString();
                                var gia = item.GetProperty("donGiaSi").GetDecimal();
                                var maThuoc = item.GetProperty("maThuoc").GetString();
                                string urlAnh = (item.TryGetProperty("urlAnh", out var imgProp) ? imgProp.GetString() :
                                                 (item.TryGetProperty("UrlAnh", out var imgProp2) ? imgProp2.GetString() : null))
                                                 ?? "default.png";
                                var formattedPrice = gia.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN")) + " đ";

                                if ((ViewBag.View as string ?? "grid") == "grid")
                                {
                                    <div class="col-md-6 col-lg-4 shop-product-card">
                                        <div class="product-item d-flex flex-column h-100" style="min-height:320px; border-radius:12px; background:#fff; padding:18px; box-shadow:0 6px 18px rgba(12,37,64,0.06);">
                                            <div class="product-img" style="flex:0 0 180px; display:flex; align-items:center; justify-content:center;">
                                                <a href="#" style="display:block; width:100%; height:100%;">
                                                    <img src="~/assets_user/img/product/@urlAnh" alt="@tenThuoc" style="max-width:100%; max-height:100%; object-fit:contain; display:block; margin:auto;" />
                                                </a>
                                            </div>

                                            <div class="product-content d-flex flex-column mt-3" style="flex:1 1 auto;">
                                                <h3 class="product-title" style="font-size:1.05rem; margin-bottom:8px;"><a href="#" style="color:#0b3b52;">@tenThuoc</a></h3>
                                                <div style="margin-top:auto;">
                                                    <div class="product-price"><span style="color:#ff6b6b; font-weight:600;">@formattedPrice</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    var moTa = item.TryGetProperty("moTa", out var m) ? m.GetString() : (item.TryGetProperty("MoTa", out var m2) ? m2.GetString() : "Không có mô tả.");

                                    <div class="col-12 shop-product-card">
                                        <div class="product-list-item d-flex align-items-center" style="padding:18px; background:#fff; border-radius:12px;">
                                            <!-- Left: large image -->
                                            <div class="product-list-img me-4" style="flex:0 0 220px; max-width:220px;">
                                                <a href="#" style="display:block; width:100%; height:180px;">
                                                    <img src="~/assets_user/img/product/@urlAnh" alt="@tenThuoc" style="width:100%; height:100%; object-fit:contain; display:block; margin:auto;" />
                                                </a>
                                            </div>

                                            <!-- Middle: title, rating, short description -->
                                            <div class="product-list-content flex-grow-1">
                                                <h3 class="product-title" style="margin:0 0 6px; font-size:1.15rem;"><a href="#" style="color:#0b3b52;">@tenThuoc</a></h3>
                                                <p class="product-desc text-muted" style="margin:0 0 12px; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;">@moTa</p>
                                            </div>

                                            <!-- Right: price and CTA -->
                                            <div class="product-list-meta text-end ms-3" style="flex:0 0 120px; display:flex; flex-direction:column; align-items:flex-end; justify-content:space-between;">
                                                <div>   
                                                    <div class="product-price"><span style="color:#ff6b6b; font-weight:700; font-size:1.05rem;">@formattedPrice</span></div>
                                                </div>
                                                <div>
                                                    <a href="#" class="btn btn-success" style="width:52px; height:52px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(12,37,64,0.06);">
                                                        <i class="far fa-shopping-bag" style="color:#fff;"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <p>Không có sản phẩm cho loại này.</p>
                        }
                    </div>
                </div>
                <!-- Pagination controls -->
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul id="shopPagination" class="pagination pagination-sm"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const pageSize = 21;
    let currentPage = 1;

    function getProductItems() {
        return Array.from(document.querySelectorAll('.shop-item-wrap .shop-product-card'));
    }

    function updateVisibleByQuery(q) {
        const items = getProductItems();
        const query = (q || '').toLowerCase().trim();
        items.forEach(it => {
            const text = it.textContent.toLowerCase();
            it.dataset.visible = query === '' ? '1' : (text.indexOf(query) !== -1 ? '1' : '0');
        });
    }

    function renderPage(page) {
        const items = getProductItems();
        const visible = items.filter(it => (it.dataset.visible ?? '1') !== '0');
        const total = visible.length;
        const pageCount = Math.max(1, Math.ceil(total / pageSize));
        if (page < 1) page = 1;
        if (page > pageCount) page = pageCount;
        currentPage = page;

        // hide all
        items.forEach(it => it.style.display = 'none');

        // show slice
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        visible.slice(start, end).forEach(it => it.style.display = '');

        // render pagination
        const ul = document.getElementById('shopPagination');
        if (!ul) return;
        ul.innerHTML = '';

        const prev = document.createElement('li'); prev.className = 'page-item ' + (page === 1 ? 'disabled' : '');
        prev.innerHTML = '<a class="page-link" href="#">«</a>';
        prev.addEventListener('click', function (e) { e.preventDefault(); if (currentPage > 1) { renderPage(currentPage - 1); } });
        ul.appendChild(prev);

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement('li');
            li.className = 'page-item ' + (i === page ? 'active' : '');
            li.innerHTML = '<a class="page-link" href="#">' + i + '</a>';
            li.addEventListener('click', function (e) { e.preventDefault(); renderPage(i); });
            ul.appendChild(li);
        }

        const next = document.createElement('li'); next.className = 'page-item ' + (page === pageCount ? 'disabled' : '');
        next.innerHTML = '<a class="page-link" href="#">»</a>';
        next.addEventListener('click', function (e) { e.preventDefault(); if (currentPage < pageCount) { renderPage(currentPage + 1); } });
        ul.appendChild(next);

        // update showing text
        const showing = document.querySelector('.shop-sort-show');
        if (showing) {
            const from = total === 0 ? 0 : start + 1;
            const to = Math.min(end, total);
            showing.textContent = `Hiển thị ${from}-${to} trong ${total} kết quả`;
        }
    }

    // init
    renderPage(currentPage);

    // wire up live search (debounced)
    const searchInput = document.getElementById('shopSearchInput');
    if (searchInput) {
        let timer = null;
        searchInput.addEventListener('input', function () {
            clearTimeout(timer);
            timer = setTimeout(() => {
                updateVisibleByQuery(this.value);
                renderPage(1);
            }, 180);
        });
    }
});
</script>
