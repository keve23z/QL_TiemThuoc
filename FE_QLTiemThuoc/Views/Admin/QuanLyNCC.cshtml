@{
    ViewData["Title"] = "Quản lý nhà cung cấp";
    
    // Test data nếu không có data từ API
    if (ViewBag.NCCList == null || ViewBag.NCCList.Count == 0)
    {
        ViewBag.NCCList = new List<dynamic>
        {
            new { MaNCC = "NCC001", TenNCC = "Công ty A", DiaChi = "Hà Nội", DienThoai = "0123456789", Email = "a@example.com" },
            new { MaNCC = "NCC002", TenNCC = "Công ty B", DiaChi = "TP HCM", DienThoai = "0987654321", Email = "b@example.com" },
            new { MaNCC = "NCC003", TenNCC = "Công ty C", DiaChi = "Đà Nẵng", DienThoai = "0913456789", Email = "c@example.com" }
        };
    }
}

<div class="container-fluid mt-4">
    <style>
        /* Ensure table cells align vertically and action button centers with row content */
        .ncc-table th,
        .ncc-table td {
            vertical-align: middle !important;
            padding-top: 0.9rem;
            padding-bottom: 0.9rem;
        }

        /* Make action container take full cell height and center its children */
        .ncc-action {
            height: 100%;
            display: flex;
            align-items: center; /* vertical center */
            justify-content: flex-end; /* align to the right */
            gap: .5rem;
        }

        /* Make edit button's contents centered vertically */
        .ncc-action .btn {
            display: inline-flex;
            align-items: center;
        }
    </style>
    <div class="row">
        <div class="col-12">
            <!-- Filter Card -->
            <div class="card mb-3" style="box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 6px;">
                <div class="card-body" style="padding: 1rem;">
                    <div class="row align-items-end g-2">
                        <div class="col-md-6">
                            <label class="form-label small mb-1">Tìm kiếm theo tên hoặc mã:</label>
                            <input type="text" id="nccSearch" class="form-control form-control-sm" placeholder="Nhập tên hoặc mã nhà cung cấp..." />
                        </div>
                        <div class="col-md-3">
                            <button id="applySearchBtn" class="btn btn-outline-secondary w-100">Tìm kiếm</button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#nccAddModal">
                                <i class="bi bi-plus-circle"></i> Thêm mới
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table Card -->
            <div class="card" style="box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 6px;">
                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table id="nccTable" class="table table-hover table-striped mb-0 ncc-table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Mã NCC</th>
                                    <th>Tên nhà cung cấp</th>
                                    <th>Địa chỉ</th>
                                    <th>Điện thoại</th>
                                    <th>Email</th>
                                    <th class="text-center pe-3">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="nccTableBody">
                                @if (ViewBag.NCCList != null && ViewBag.NCCList.Count > 0)
                                {
                                    @foreach (var ncc in (List<FE_QLTiemThuoc.Models.NhaCungCap>)ViewBag.NCCList)
                                    {
                                        <tr data-mancc="@ncc.MaNCC">
                                            <td class="ps-3">
                                                <strong>@ncc.MaNCC</strong>
                                            </td>
                                            <td>@ncc.TenNCC</td>
                                            <td>@ncc.DiaChi</td>
                                            <td>@ncc.DienThoai</td>
                                            <td>@ncc.Email</td>
                                            <td class="text-end align-middle ncc-action-cell">
                                                <div class="ncc-action">
                                                    <button class="btn btn-sm btn-warning btn-edit px-2" style="min-width:56px;" data-mancc="@ncc.MaNCC">
                                                        <i class="bi bi-pencil-square d-inline-block me-1"></i>
                                                        <span>Sửa</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">Không có dữ liệu</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination controls -->
                    <div class="d-flex justify-content-between align-items-center p-2">
                        <div>
                            <small class="text-muted">Hiển thị <span id="nccShowingCount">0</span> mục</small>
                        </div>
                        <nav>
                            <ul id="nccPagination" class="pagination pagination-sm mb-0"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add NCC -->
<div class="modal fade" id="nccAddModal" tabindex="-1" aria-labelledby="nccAddModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nccAddModalLabel">Thêm nhà cung cấp mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="nccAddForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Mã NCC:</label>
                            <input type="text" class="form-control add-ncc-ma" readonly placeholder="Tự động sinh" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tên nhà cung cấp:</label>
                            <input type="text" class="form-control add-ncc-ten" required />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Địa chỉ:</label>
                            <input type="text" class="form-control add-ncc-diachi" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Điện thoại:</label>
                            <input type="tel" class="form-control add-ncc-dienthoai" pattern="[0-9\s\-\+\(\)]{10,}" placeholder="0xxxxxxxxx" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email:</label>
                            <input type="email" class="form-control add-ncc-email" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="nccAddSaveBtn" class="btn btn-primary">Lưu</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit NCC -->
<div class="modal fade" id="nccEditModal" tabindex="-1" aria-labelledby="nccEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nccEditModalLabel">Chỉnh sửa nhà cung cấp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="nccEditForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Mã NCC:</label>
                            <input type="text" class="form-control edit-ncc-ma" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tên nhà cung cấp:</label>
                            <input type="text" class="form-control edit-ncc-ten" required />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Địa chỉ:</label>
                            <input type="text" class="form-control edit-ncc-diachi" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Điện thoại:</label>
                            <input type="tel" class="form-control edit-ncc-dienthoai" pattern="[0-9\s\-\+\(\)]{10,}" placeholder="0xxxxxxxxx" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email:</label>
                            <input type="email" class="form-control edit-ncc-email" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="nccEditSaveBtn" class="btn btn-primary">Lưu</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function () {
    const API_URL = 'https://localhost:7283/api';

    // Mở modal Add
    var addModal = document.getElementById('nccAddModal');
    if (addModal) {
        addModal.addEventListener('show.bs.modal', function () {
            // Reset form trước, sau đó sinh mã
            setTimeout(function() {
                generateNextMaNCC();
            }, 100);
        });
    }

    // Sinh mã NCC tự động
    function generateNextMaNCC() {
        var maxNum = 0;
        
        // Lấy dữ liệu từ table hiện tại
        var tableBody = document.getElementById('nccTableBody');
        if (tableBody) {
            var rows = tableBody.querySelectorAll('tr[data-mancc]');
            rows.forEach(row => {
                var maNCC = row.getAttribute('data-mancc');
                var numPart = parseInt(maNCC.replace(/\D/g, '')) || 0;
                if (numPart > maxNum) maxNum = numPart;
            });
        }
        
        console.log('Table maxNum:', maxNum);
        
        // Nếu chưa có dữ liệu từ table, thử fetch từ API
        if (maxNum === 0) {
            fetch(API_URL + '/NhaCungCap')
                .then(r => {
                    if (!r.ok) return Promise.reject('API error');
                    return r.json();
                })
                .then(json => {
                    console.log('API Response:', json);
                    var arr = [];
                    
                    // Xử lý response format: {status, message, data: [...]}
                    if (json.data && Array.isArray(json.data)) {
                        arr = json.data;
                    } else if (Array.isArray(json)) {
                        arr = json;
                    }
                    
                    var apiMaxNum = 0;
                    arr.forEach(ncc => {
                        // Xử lý cả uppercase và lowercase key names
                        var code = ncc.MaNCC || ncc.maNCC || '';
                        var numPart = parseInt(code.replace(/\D/g, '')) || 0;
                        if (numPart > apiMaxNum) apiMaxNum = numPart;
                    });
                    
                    console.log('API maxNum:', apiMaxNum);
                    var nextMa = 'NCC' + String(apiMaxNum + 1).padStart(3, '0');
                    console.log('Next MaNCC:', nextMa);
                    
                    var input = document.querySelector('#nccAddModal .add-ncc-ma');
                    if (input) {
                        input.value = nextMa;
                        console.log('Set value to:', input.value);
                    } else {
                        console.error('Input not found');
                    }
                })
                .catch(e => {
                    console.error('Error generating MaNCC:', e);
                    var input = document.querySelector('#nccAddModal .add-ncc-ma');
                    if (input) input.value = 'NCC001';
                });
        } else {
            var nextMa = 'NCC' + String(maxNum + 1).padStart(3, '0');
            console.log('Using table data, next MaNCC:', nextMa);
            var input = document.querySelector('#nccAddModal .add-ncc-ma');
            if (input) {
                input.value = nextMa;
                console.log('Set value to:', input.value);
            }
        }
    }

    // Save Add
    var addSaveBtn = document.getElementById('nccAddSaveBtn');
    if (addSaveBtn) {
        addSaveBtn.addEventListener('click', function () {
            var modal = document.getElementById('nccAddModal');
            var maNCC = modal.querySelector('.add-ncc-ma').value || '';
            var tenNCC = modal.querySelector('.add-ncc-ten').value || '';
            var diaChi = modal.querySelector('.add-ncc-diachi').value || '';
            var dienThoai = modal.querySelector('.add-ncc-dienthoai').value || '';
            var email = modal.querySelector('.add-ncc-email').value || '';

            if (!tenNCC.trim()) {
                alert('Tên nhà cung cấp không được để trống');
                return;
            }

            var payload = {
                maNCC: maNCC,
                tenNCC: tenNCC,
                diaChi: diaChi,
                dienThoai: dienThoai,
                email: email
            };

            fetch(API_URL + '/NhaCungCap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.ok ? r.json() : Promise.reject('Save failed'))
            .then(result => {
                alert('Thêm nhà cung cấp thành công');
                bootstrap.Modal.getInstance(modal).hide();
                location.reload();
            })
            .catch(e => {
                alert('Lỗi: ' + e);
            });
        });
    }

    // Xử lý Edit
    var tableBody = document.getElementById('nccTableBody');
    if (tableBody) {
        tableBody.addEventListener('click', function (e) {
            var editBtn = e.target.closest('.btn-edit');

            if (editBtn) {
                var maNCC = editBtn.getAttribute('data-mancc');
                console.log('Edit clicked for:', maNCC);
                openEditModal(maNCC);
            }
        });
    }

    function openEditModal(maNCC) {
        console.log('Fetching NCC:', maNCC);
        fetch(API_URL + '/NhaCungCap/' + maNCC)
            .then(r => {
                if (!r.ok) return Promise.reject('HTTP ' + r.status);
                return r.json();
            })
            .then(json => {
                console.log('API Response:', json);
                // Xử lý response format: {status, message, data: {...}} hoặc {status, data: {...}} hoặc trực tiếp {...}
                var ncc = json.data || json;
                console.log('NCC Data:', ncc);
                
                var modal = document.getElementById('nccEditModal');
                if (!modal) {
                    alert('Modal không tìm thấy');
                    return;
                }
                
                // Set tất cả field
                modal.querySelector('.edit-ncc-ma').value = ncc.MaNCC || ncc.maNCC || '';
                modal.querySelector('.edit-ncc-ten').value = ncc.TenNCC || ncc.tenNCC || '';
                modal.querySelector('.edit-ncc-diachi').value = ncc.DiaChi || ncc.diaChi || '';
                modal.querySelector('.edit-ncc-dienthoai').value = ncc.DienThoai || ncc.dienThoai || '';
                modal.querySelector('.edit-ncc-email').value = ncc.Email || ncc.email || '';
                
                console.log('Modal fields set successfully');
                bootstrap.Modal.getOrCreateInstance(modal).show();
            })
            .catch(e => {
                console.error('Error:', e);
                alert('Lỗi khi tải dữ liệu: ' + e);
            });
    }

    // Save Edit
    var editSaveBtn = document.getElementById('nccEditSaveBtn');
    if (editSaveBtn) {
        editSaveBtn.addEventListener('click', function () {
            var modal = document.getElementById('nccEditModal');
            var maNCC = modal.querySelector('.edit-ncc-ma').value || '';
            var payload = {
                maNCC: maNCC,
                tenNCC: modal.querySelector('.edit-ncc-ten').value || '',
                diaChi: modal.querySelector('.edit-ncc-diachi').value || '',
                dienThoai: modal.querySelector('.edit-ncc-dienthoai').value || '',
                email: modal.querySelector('.edit-ncc-email').value || ''
            };

            fetch(API_URL + '/NhaCungCap/' + maNCC, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.ok ? r.json() : Promise.reject('Update failed'))
            .then(result => {
                alert('Cập nhật thành công');
                bootstrap.Modal.getInstance(modal).hide();
                location.reload();
            })
            .catch(e => alert('Lỗi: ' + e));
        });
    }

    // Search
    var searchInput = document.getElementById('nccSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function () {
            filterTable();
        });
    }

    function filterTable() {
        var query = (document.getElementById('nccSearch').value || '').toLowerCase();
        // Apply filter and rebuild pagination
        var rows = Array.from(document.querySelectorAll('#nccTableBody tr'));
        rows.forEach(row => {
            var text = row.textContent.toLowerCase();
            row.dataset.visible = text.includes(query) ? '1' : '0';
        });
        currentPage = 1;
        renderPagination();
    }

    // --- Pagination ---
    var pageSize = 10;
    var currentPage = 1;

    function getVisibleRows() {
        return Array.from(document.querySelectorAll('#nccTableBody tr')).filter(r => r.dataset.visible !== '0');
    }

    function renderPage(page) {
        var rows = Array.from(document.querySelectorAll('#nccTableBody tr'));
        var visible = rows.filter(r => r.dataset.visible !== '0');
        var total = visible.length;
        var start = (page - 1) * pageSize;
        var end = start + pageSize;

        // hide all first
        rows.forEach(r => r.style.display = 'none');

        // show slice
        visible.slice(start, end).forEach(r => r.style.display = '');

        // update showing count
        document.getElementById('nccShowingCount').textContent = total;
    }

    function renderPagination() {
        var visible = getVisibleRows();
        var total = visible.length;
        var pageCount = Math.max(1, Math.ceil(total / pageSize));
        var ul = document.getElementById('nccPagination');
        ul.innerHTML = '';

        // prev
        var prevLi = document.createElement('li');
        prevLi.className = 'page-item ' + (currentPage === 1 ? 'disabled' : '');
        prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous">&laquo;</a>';
        prevLi.addEventListener('click', function (e) { e.preventDefault(); if (currentPage > 1) { currentPage--; renderPagination(); } });
        ul.appendChild(prevLi);

        // pages
        for (var i = 1; i <= pageCount; i++) {
            (function(p){
                var li = document.createElement('li');
                li.className = 'page-item ' + (p === currentPage ? 'active' : '');
                li.innerHTML = '<a class="page-link" href="#">' + p + '</a>';
                li.addEventListener('click', function (e) { e.preventDefault(); currentPage = p; renderPagination(); });
                ul.appendChild(li);
            })(i);
        }

        // next
        var nextLi = document.createElement('li');
        nextLi.className = 'page-item ' + (currentPage === pageCount ? 'disabled' : '');
        nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next">&raquo;</a>';
        nextLi.addEventListener('click', function (e) { e.preventDefault(); if (currentPage < pageCount) { currentPage++; renderPagination(); } });
        ul.appendChild(nextLi);

        renderPage(currentPage);
    }

    // Initialize pagination and default visible flags
    (function initPagination(){
        var rows = Array.from(document.querySelectorAll('#nccTableBody tr'));
        rows.forEach(r => { r.dataset.visible = (r.style.display !== 'none' ? '1' : '1'); });
        renderPagination();
    })();
});
</script>
}
