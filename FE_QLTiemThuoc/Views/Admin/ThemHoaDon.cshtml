@{
    ViewData["Title"] = "Thêm Hoá đơn";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Thêm hoá đơn</h2>
        <a class="btn btn-secondary" href="@Url.Action("HoaDonList", "Admin")">Quay lại</a>
    </div>

    <style>
        /* Fixed column sizing for items table to keep layout stable */
        #itemsTable { table-layout: fixed; width: 100%; }
        #itemsTable th, #itemsTable td { vertical-align: middle; }
        #itemsTable .col-index { width: 40px; }
        #itemsTable .col-medicine { width: 720px; }
        #itemsTable .col-qty { width: 90px; }
        #itemsTable .col-price { width: 110px; }
        #itemsTable .col-amount { width: 130px; }
        /* make select/inputs fill their cell nicely */
        #itemsTable .select-lot, #itemsTable input.qty, #itemsTable input.price { width: 100%; box-sizing: border-box; }
        /* small input tweaks */
        #itemsTable input.qty { padding: .25rem .5rem; }
        #itemsTable input.price { padding: .25rem .5rem; }
    </style>

    <form id="invoiceForm">
        <div class="row g-3">
            <div class="col-12 position-relative">
                <label class="form-label">Khách hàng</label>
                <input id="khSearch" class="form-control" placeholder="Nhập tên khách hoặc mã..." autocomplete="off" />
                <input type="hidden" id="maKH" />
                <div id="khSuggestions" class="list-group position-absolute" style="z-index:1000; width:100%; max-height:200px; overflow:auto; display:none;"></div>
            </div>
            <div class="col-md-6">
                <label class="form-label">Nhân viên</label>
                <input type="hidden" id="maNV" value="@ViewBag.MaNV" />
                <input id="tenNV" class="form-control" value="@ViewBag.TenNV" readonly />
            </div>
            <div class="col-md-6">
                <label class="form-label">Ngày lập</label>
                <input id="ngayLap" type="datetime-local" class="form-control" value="@ViewBag.DefaultNgayLap" />
            </div>
            <div class="col-12">
                <label class="form-label">Ghi chú</label>
                <textarea id="ghiChu" class="form-control" rows="2"></textarea>
            </div>
        </div>

        <hr />

        <h5>Danh sách hàng</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered" id="itemsTable">
                <thead>
                        <tr>
                            <th class="col-index">#</th>
                            <th class="col-medicine">Thuốc</th>
                            <th class="col-qty">Số lượng</th>
                            <th class="col-price">Đơn giá</th>
                            <th class="col-amount">Thành tiền</th>
                            <th style="width:60px;"></th>
                        </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button type="button" id="addItemBtn" class="btn btn-outline-primary btn-sm">Thêm hàng</button>
            </div>
            <div class="text-end">
                <div>Tổng: <span id="totalView">0 ₫</span></div>
                <button type="button" id="submitInvoice" class="btn btn-success mt-2">Tạo hoá đơn</button>
            </div>
        </div>
    </form>
</div>

<script>
    (function () {
        const apiBase = '@(ViewBag.ApiBase ?? "/api")';
    const lotListChua = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.LotListChua ?? new List<object>()));
    const lotListDa = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.LotListDa ?? new List<object>()));
    let currentLotList = Array.isArray(lotListChua) ? lotListChua : [];

        function toNumber(v){ if(v===null||v===undefined) return 0; const n=Number(String(v).replace(/[^0-9,.-]/g,'').replace(',','.') ); return Number.isFinite(n)?n:0; }
        function formatCurrency(v){ return toNumber(v).toLocaleString('vi-VN') + ' ₫'; }

        // --- Customer autocomplete ---
        let khCache = null;
        async function fetchCustomersOnce(){
            if (khCache !== null) return khCache;
            try{
                const res = await fetch(apiBase.replace(/\/$/, '') + '/KhachHang');
                if(!res.ok) { khCache = []; return khCache; }
                const data = await res.json();
                // API may return array directly or { data: [...] }
                const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                khCache = list.map(k=>({
                    makh: k.makh ?? k.MaKH ?? k.maKH ?? k.MAKH ?? '',
                    hoTen: k.hoTen ?? k.HoTen ?? k.hoten ?? '',
                    diaChi: k.diaChi ?? k.DiaChi ?? '',
                    dienThoai: k.dienThoai ?? k.DienThoai ?? ''
                }));
                return khCache;
            }catch(e){ khCache = []; return khCache; }
        }

        function showKhSuggestions(filtered){
            const box = document.getElementById('khSuggestions');
            if(!box) return; box.innerHTML = '';
            if(!filtered || filtered.length===0){ box.style.display='none'; return; }
            filtered.forEach(k=>{
                const item = document.createElement('button');
                item.type = 'button'; item.className = 'list-group-item list-group-item-action';
                item.textContent = `${k.hoTen} (${k.makh})`;
                item.addEventListener('click', ()=>{
                    document.getElementById('khSearch').value = `${k.hoTen} (${k.makh})`;
                    document.getElementById('maKH').value = k.makh;
                    box.style.display='none';
                });
                box.appendChild(item);
            });
            box.style.display = 'block';
        }

        (function initCustomerAutocomplete(){
            const input = document.getElementById('khSearch');
            const hidden = document.getElementById('maKH');
            if(!input) return;
            let timer = null;
            input.addEventListener('input', async function(){
                hidden.value = '';
                const q = input.value.trim();
                if(timer) clearTimeout(timer);
                timer = setTimeout(async ()=>{
                    const list = await fetchCustomersOnce();
                    if(!q){ showKhSuggestions(list.slice(0,20)); return; }
                    const lower = q.toLowerCase();
                    const filtered = list.filter(k => (k.hoTen || '').toLowerCase().includes(lower) || (k.makh || '').toLowerCase().includes(lower));
                    showKhSuggestions(filtered.slice(0,50));
                }, 200);
            });
            // hide on outside click
            document.addEventListener('click', function(e){ const box = document.getElementById('khSuggestions'); if(!box) return; if(!box.contains(e.target) && e.target !== input) box.style.display='none'; });
        })();

    // purchase type selector (chua = mua sỉ / da = mua kê đơn)
    const purchaseSelectHtml = ['<div class="d-flex justify-content-start mb-2">', '<div class="me-3">', '<label class="form-label mb-0">Loại mua</label>', '<select id="purchaseType" class="form-select form-select-sm">', '<option value="chua">Mua sỉ (chưa tách lẻ)</option>', '<option value="da">Mua kê đơn (đã tách lẻ)</option>', '</select>', '</div>', '</div>'].join('');
    const container = document.querySelector('.container');
    const insertBefore = document.querySelector('#itemsTable');
    if(container && insertBefore){ insertBefore.insertAdjacentHTML('beforebegin', purchaseSelectHtml); }

    const purchaseTypeEl = document.getElementById('purchaseType');
    if(purchaseTypeEl){ purchaseTypeEl.addEventListener('change', function(){ currentLotList = this.value === 'da' ? lotListDa : lotListChua; // rebuild existing rows
        Array.from(tbody.children).forEach(tr => rebuildLotOptionsForRow(tr)); }); }

    const tbody = document.querySelector('#itemsTable tbody');
        function addRow(data){
            const idx = tbody.children.length + 1;
            const tr = document.createElement('tr');
            const selectHtml = ['<select class="form-select form-select-sm select-lot">', '<option value="">-- chọn lô (chọn 1) --</option>'];
            (currentLotList || []).forEach(t=>{
                const maLo = t.maLo ?? t.MaLo ?? t.maLo?.ToString?.() ?? '';
                const maThuoc = t.maThuoc ?? t.MaThuoc ?? '';
                const ten = t.tenThuoc ?? t.TenThuoc ?? '';
                const qty = t.soLuongCon ?? t.SoLuongCon ?? t.soLuong ?? t.SoLuong ?? 0;
                selectHtml.push(`<option value="${maLo}" data-mathuoc="${maThuoc}" data-ten="${ten}" data-qty="${qty}">${ten} [${maThuoc}] - ${maLo} (còn ${qty})</option>`);
            });
            selectHtml.push('</select>');
            tr.innerHTML = `
                <td class="text-center col-index">${idx}</td>
                <td class="col-medicine">${selectHtml.join('')}</td>
                <td class="col-qty"><input type="number" min="1" class="form-control form-control-sm qty" value="${data?.soLuong ?? 1}" /></td>
                <td class="col-price"><input type="number" min="0" class="form-control form-control-sm price" value="${data?.donGia ?? 0}" /></td>
                <td class="text-end col-amount amount">0 ₫</td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-row">×</button></td>
            `;
            tbody.appendChild(tr);
            bindRowEvents(tr);
            recalc();
        }

        function bindRowEvents(tr){
            const sel = tr.querySelector('.select-thuoc');
            const qty = tr.querySelector('.qty');
            const price = tr.querySelector('.price');
            const remove = tr.querySelector('.remove-row');
        sel && sel.addEventListener('change', function(){ const opt=sel.selectedOptions[0]; if(opt && opt.dataset){ if(opt.dataset.mathuoc) sel.setAttribute('data-selected-mathuoc', opt.dataset.mathuoc); if(opt.dataset.qty) sel.setAttribute('data-selected-qty', opt.dataset.qty); // set qty max according to selected lot
            const qEl = tr.querySelector('.qty'); if(qEl && opt.dataset.qty){ qEl.max = Number(opt.dataset.qty || 0); if(Number(qEl.value) > Number(qEl.max)) qEl.value = qEl.max; }
            recalc(); } });
            qty && qty.addEventListener('input', recalc);
            price && price.addEventListener('input', recalc);
            remove && remove.addEventListener('click', function(){ tr.remove(); renumber(); recalc(); });
        }

    function renumber(){ Array.from(tbody.children).forEach((r,i)=> r.querySelector('td').textContent = (i+1)); }
    function rebuildLotOptionsForRow(tr){ const sel = tr.querySelector('.select-lot'); if(!sel) return; const currentVal = sel.value; sel.innerHTML = '<option value="">-- chọn lô (chọn 1) --</option>'; (currentLotList||[]).forEach(t=>{ const maLo = t.maLo ?? t.MaLo ?? ''; const maThuoc = t.maThuoc ?? t.MaThuoc ?? ''; const ten = t.tenThuoc ?? t.TenThuoc ?? ''; const qty = t.soLuongCon ?? t.SoLuongCon ?? t.soLuong ?? t.SoLuong ?? 0; const opt = document.createElement('option'); opt.value = maLo; opt.dataset.mathuoc = maThuoc; opt.dataset.ten = ten; opt.dataset.qty = qty; opt.textContent = `${ten} [${maThuoc}] - ${maLo} (còn ${qty})`; sel.appendChild(opt); }); if(currentVal) sel.value = currentVal; }
        function recalc(){ let total=0; Array.from(tbody.children).forEach(r=>{ const q=toNumber(r.querySelector('.qty').value); const p=toNumber(r.querySelector('.price').value); const amt=q*p; total+=amt; r.querySelector('.amount').textContent = amt.toLocaleString('vi-VN') + ' ₫'; }); document.getElementById('totalView').textContent = total.toLocaleString('vi-VN') + ' ₫'; }

        document.getElementById('addItemBtn').addEventListener('click', ()=> addRow({}));
        // add initial row
        addRow({});

        document.getElementById('submitInvoice').addEventListener('click', async function(){
            const maKH = document.getElementById('maKH').value || null;
            const maNV = document.getElementById('maNV').value || null;
            const ghiChu = document.getElementById('ghiChu').value || null;
            const items = [];
            Array.from(tbody.children).forEach(r=>{
                const sel = r.querySelector('.select-lot');
                const soLuong = Number(r.querySelector('.qty').value) || 0;
                const donGia = Number(r.querySelector('.price').value) || 0;
                const maLo = sel ? sel.value : null;
                const maThuoc = sel ? (sel.selectedOptions[0].dataset.mathuoc || null) : null;
                if(!maLo || !maThuoc) return; // skip empty
                items.push({ maLo: maLo, maThuoc: maThuoc, tenThuoc: sel.selectedOptions[0].dataset.ten || null, soLuong: soLuong, donGia: donGia, trangThaiSeal: 1, donVi: null, maLD: null });
            });
            if(items.length===0){ alert('Vui lòng thêm ít nhất 1 mặt hàng có thuốc.'); return; }

            const tongTien = items.reduce((s,it)=> s + (Number(it.donGia||0)*Number(it.soLuong||0)), 0);
            const payload = { maKH: maKH, maNV: maNV, ghiChu: ghiChu, tongTien: tongTien, items: items };

            try{
                const res = await fetch(apiBase + '/HoaDon/Create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok){ const txt = await res.text(); throw new Error('HTTP ' + res.status + ' ' + txt); }
                const data = await res.json();
                alert('Tạo hoá đơn thành công');
                window.location.href = '@Url.Action("HoaDonList", "Admin")';
            }catch(err){ alert('Lỗi khi tạo hoá đơn: ' + (err.message || err)); }
        });

    })();
</script>