@{
	ViewData["Title"] = "Danh Sách phiếu nhập";
	var today = DateTime.Now.Date;
	var firstOfMonth = new DateTime(today.Year, today.Month, 1);
	var defaultFrom = ViewBag.DefaultFrom as string ?? firstOfMonth.ToString("yyyy-MM-dd");
	var defaultTo = ViewBag.DefaultTo as string ?? today.ToString("yyyy-MM-dd");
}

<div class="container-fluid mt-3">
	<div class="card mb-3">
		<div class="card-body">
			<div class="row align-items-end gx-2">
				<div class="col-auto">
					<label class="form-label small mb-1">Từ ngày</label>
					<input type="date" id="filterFrom" class="form-control form-control-sm" value="@defaultFrom" />
				</div>
				<div class="col-auto">
					<label class="form-label small mb-1">Đến ngày</label>
					<input type="date" id="filterTo" class="form-control form-control-sm" value="@defaultTo" />
				</div>
				<div class="col-md-4">
					<label class="form-label small mb-1">Tìm kiếm</label>
					<input type="text" id="filterSearch" class="form-control form-control-sm" placeholder="Số CT / Ghi chú / từ khóa" />
				</div>

				<div class="col text-end">
					<div class="btn-group" role="group" aria-label="Actions">
						<a href="/Admin/AddPhieuNhap" class="btn btn-success btn-sm">Thêm mới</a>
						<button id="btnPrint" class="btn btn-outline-secondary btn-sm" type="button">In</button>
						<button id="btnExport" class="btn btn-outline-primary btn-sm" type="button">Xuất Excel</button>
					</div>
				</div>
			</div>

			<!-- Inline Add PhieuNhap removed: Add button now redirects to separate Add page -->
		</div>
	</div>

	<!-- placeholder for results / table -->
	<div class="card">
		<div class="card-header">
			<strong>Danh sách phiếu nhập</strong>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-hover">
					<thead>
						<tr>
							<th style="width:120px">Mã PN</th>
							<th>Ngày</th>
							<th>Nhà cung cấp</th>
							<th>Ghi chú</th>
							<th style="width:120px" class="text-end">Tổng tiền</th>
							<th style="width:120px">Thao tác</th>
						</tr>
					</thead>
					<tbody id="nhapThuocTableBody">
						<tr><td colspan="6" class="text-center text-muted">Chưa có dữ liệu — chọn khoảng thời gian và nhấn Tìm kiếm</td></tr>
					</tbody>
				</table>
			</div>
			<div class="d-flex justify-content-between align-items-center mt-2" id="paginationContainer" style="display:none">
				<div class="small text-muted" id="paginationSummary"></div>
				<nav>
					<ul class="pagination pagination-sm mb-0" id="paginationControls"></ul>
				</nav>
			</div>
		</div>
	</div>
</div>

<!-- Modal for chi tiết -->
<div class="modal fade" id="chiTietModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Chi tiết phiếu nhập</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="chiTietContent">
				<!-- populated dynamically -->
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			let apiBase = '@(ViewBag.ApiBase ?? "/api/")';
			apiBase = apiBase.replace(/\/+$/, '');

			const filterFrom = document.getElementById('filterFrom');
			const filterTo = document.getElementById('filterTo');
			const filterSearch = document.getElementById('filterSearch');
			const tableBody = document.getElementById('nhapThuocTableBody');
			const btnPrint = document.getElementById('btnPrint');
			const btnExport = document.getElementById('btnExport');
			const paginationContainer = document.getElementById('paginationContainer');
			const paginationControls = document.getElementById('paginationControls');
			const paginationSummary = document.getElementById('paginationSummary');
			const PAGE_SIZE = 10;
			const currentStaffName = '@System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(ViewBag.TenNV as string ?? string.Empty)';

			const state = {
				rows: [],
				filteredRows: [],
				currentPage: 1
			};

			function numberToVietnameseWords(value) {
				let amount = Math.round(Number(value) || 0);
				if (amount === 0) return 'Không đồng';
				const digits = ['không', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
				const units = ['', ' nghìn', ' triệu', ' tỷ', ' nghìn tỷ', ' triệu tỷ', ' tỷ tỷ'];

				function readTriple(num, isFull) {
					let result = [];
					const hundred = Math.floor(num / 100);
					const ten = Math.floor((num % 100) / 10);
					const unit = num % 10;

					if (hundred > 0 || isFull) {
						result.push(`${digits[hundred]} trăm`);
					}

					if (ten > 1) {
						result.push(`${digits[ten]} mươi`);
						if (unit === 1) result.push('mốt');
						else if (unit === 4) result.push('tư');
						else if (unit === 5) result.push('lăm');
						else if (unit !== 0) result.push(digits[unit]);
					} else if (ten === 1) {
						result.push('mười');
						if (unit === 1) result.push('một');
						else if (unit === 4) result.push('bốn');
						else if (unit === 5) result.push('lăm');
						else if (unit !== 0) result.push(digits[unit]);
					} else if (ten === 0 && unit !== 0) {
						if (hundred > 0 || isFull) {
							result.push('linh');
							if (unit === 5) result.push('năm');
							else if (unit === 1) result.push('một');
							else result.push(digits[unit]);
						} else {
							result.push(digits[unit]);
						}
					}

					return result.join(' ').trim();
				}

				let parts = [];
				let unitIndex = 0;
				let full = false;
				while (amount > 0 && unitIndex < units.length) {
					const triple = amount % 1000;
					if (triple !== 0) {
						const prefix = readTriple(triple, full);
						if (prefix) {
							parts.unshift(`${prefix}${units[unitIndex]}`);
						}
						full = true;
					}
					amount = Math.floor(amount / 1000);
					unitIndex++;
				}

				const words = parts.join(' ').replace(/\s+/g, ' ').trim();
				if (!words) return 'Không đồng';
				return words.charAt(0).toUpperCase() + words.slice(1) + ' đồng';
			}

			function normalizeText(value) {
				if (!value) return '';
				try {
					return value.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
				} catch {
					return value.toString().toLowerCase();
				}
			}

			function renderRows() {
				const term = normalizeText(filterSearch?.value ?? '');
				const list = Array.isArray(state.rows) ? state.rows : [];
				const filtered = term
					? list.filter(item => {
						const composed = [item.maPN, item.ghiChu, item.tenNCC, item.tenNV].map(normalizeText).join(' ');
						return composed.includes(term);
					})
					: list;
				state.filteredRows = filtered;
				const totalItems = filtered.length;
				const totalPages = totalItems ? Math.ceil(totalItems / PAGE_SIZE) : 1;
				if (state.currentPage > totalPages) state.currentPage = totalPages;
				if (state.currentPage < 1) state.currentPage = 1;
				const startIdx = (state.currentPage - 1) * PAGE_SIZE;
				const pageItems = filtered.slice(startIdx, startIdx + PAGE_SIZE);

				if (!filtered.length) {
					tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Không có dữ liệu trong khoảng thời gian đã chọn.</td></tr>';
					renderPagination(0, 0, 0);
					return;
				}

				const formatter = new Intl.NumberFormat('vi-VN');
				tableBody.innerHTML = pageItems.map(item => {
					const dateDisplay = item.ngayNhap ? new Date(item.ngayNhap).toLocaleDateString('vi-VN') : '';
					const totalDisplay = formatter.format(item.tongTien ?? 0);
					return `
						<tr>
							<td>${item.maPN ?? ''}</td>
							<td>${dateDisplay}</td>
							<td>${item.tenNCC ?? ''}</td>
							<td>${item.ghiChu ?? ''}</td>
							<td class="text-end">${totalDisplay}</td>
							<td>
								<button class="btn btn-outline-primary btn-sm btn-detail" type="button" data-id="${item.maPN ?? ''}"><i class="bi bi-search"></i> Xem</button>
							</td>
						</tr>`;
				}).join('');
				renderPagination(state.currentPage, totalPages, totalItems);
			}

			function renderPagination(current, totalPages, totalItems) {
				if (!totalPages || totalPages <= 1) {
					paginationContainer.style.display = 'none';
					paginationControls.innerHTML = '';
					paginationSummary.textContent = '';
					return;
				}
				paginationContainer.style.display = '';
				const start = (current - 1) * PAGE_SIZE + 1;
				const end = Math.min(start + PAGE_SIZE - 1, totalItems);
				paginationSummary.textContent = `Hiển thị ${start}-${end} / ${totalItems}`;

				const createButton = (label, page, disabled = false, active = false) => {
					return `<li class="page-item${disabled ? ' disabled' : ''}${active ? ' active' : ''}"><button class="page-link" data-page="${page}" ${disabled ? 'tabindex="-1" aria-disabled="true"' : ''}>${label}</button></li>`;
				};

				let html = '';
				html += createButton('&laquo;', current - 1, current === 1);
				const windowSize = 5;
				let startPage = Math.max(1, current - Math.floor(windowSize / 2));
				let endPage = Math.min(totalPages, startPage + windowSize - 1);
				if (endPage - startPage + 1 < windowSize) {
					startPage = Math.max(1, endPage - windowSize + 1);
				}
				for (let page = startPage; page <= endPage; page++) {
					html += createButton(page, page, false, page === current);
				}
				html += createButton('&raquo;', current + 1, current === totalPages);
				paginationControls.innerHTML = html;
			}

			async function fetchPhieuNhap() {
				const start = filterFrom?.value;
				const end = filterTo?.value;
				if (!start || !end) {
					tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-warning">Vui lòng chọn đủ Từ ngày và Đến ngày.</td></tr>';
					return;
				}
				if (start > end) {
					tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-warning">"Từ ngày" phải nhỏ hơn hoặc bằng "Đến ngày".</td></tr>';
					return;
				}

				tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Đang tải dữ liệu...</td></tr>';
				try {
					const url = `${apiBase}/PhieuNhap/GetByDateRange?startDate=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}`;
					const res = await fetch(url, { cache: 'no-store' });
					if (!res.ok) throw new Error(`HTTP ${res.status}`);
					const json = await res.json();
					const data = json?.data ?? json ?? [];
					state.rows = Array.isArray(data) ? data : [];
					state.currentPage = 1;
					renderRows();
				} catch (err) {
					console.error('Fetch PhieuNhap failed', err);
					tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Không tải được dữ liệu: ${err.message}</td></tr>`;
					renderPagination(0, 0, 0);
				}
			}

			filterFrom?.addEventListener('change', () => { state.currentPage = 1; fetchPhieuNhap(); });
			filterTo?.addEventListener('change', () => { state.currentPage = 1; fetchPhieuNhap(); });
			filterSearch?.addEventListener('input', () => { state.currentPage = 1; renderRows(); });

			paginationControls?.addEventListener('click', (event) => {
				const button = event.target.closest('button[data-page]');
				if (!button || button.parentElement.classList.contains('disabled')) return;
				const targetPage = parseInt(button.getAttribute('data-page'), 10);
				if (!Number.isFinite(targetPage)) return;
				state.currentPage = targetPage;
				renderRows();
			});

			btnAddNew?.addEventListener('click', () => {
				window.location.href = '/Admin/AddPhieuNhap';
			});

			btnPrint?.addEventListener('click', () => {
				const source = state.filteredRows && state.filteredRows.length ? state.filteredRows : state.rows;
				if (!source.length) {
					alert('Không có dữ liệu để in.');
					return;
				}
				const printedAt = new Date();
				const printedAtDisplay = printedAt.toLocaleString('vi-VN');
				const formatter = new Intl.NumberFormat('vi-VN');
				const rowsHtml = source.map((item, index) => {
					const dateDisplay = item.ngayNhap ? new Date(item.ngayNhap).toLocaleDateString('vi-VN') : '';
					const totalDisplay = formatter.format(item.tongTien ?? 0);
					return `
					<tr>
						<td>${index + 1}</td>
						<td>${item.maPN ?? ''}</td>
						<td>${dateDisplay}</td>
						<td>${item.tenNCC ?? ''}</td>
						<td>${(item.ghiChu ?? '').replace(/\r?\n/g, ' ')}</td>
						<td style="text-align:right">${totalDisplay}</td>
					</tr>`;
				}).join('');
				const totalAmount = source.reduce((sum, item) => sum + (Number(item.tongTien) || 0), 0);
				const filterInfo = `Từ ngày: ${filterFrom?.value ?? ''} &nbsp;&nbsp; Đến ngày: ${filterTo?.value ?? ''}`;
				const searchInfo = filterSearch?.value ? `Từ khóa: ${filterSearch.value}` : '';
				const totalInWords = numberToVietnameseWords(totalAmount);
				const html = `
				<!DOCTYPE html>
				<html lang="vi">
				<head>
				<meta charset="utf-8" />
				<title>Phiếu Nhập Thuốc</title>
				<style>
				body { font-family: 'Courier New', monospace; margin: 0; padding: 10px; color: #000; font-size: 12px; line-height: 1.4; }
				.header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
				.header h1 { margin: 0; font-size: 18px; font-weight: bold; }
				.header p { margin: 2px 0; }
				.info { margin-bottom: 10px; }
				.info div { margin: 2px 0; }
				table { width: 100%; border-collapse: collapse; margin-top: 10px; }
				th, td { border: 1px solid #000; padding: 4px; text-align: left; }
				th { background: #f0f0f0; font-weight: bold; }
				.text-right { text-align: right; }
				.total { font-weight: bold; }
				.footer { margin-top: 20px; text-align: center; }
				.signatures { display: flex; justify-content: space-around; margin-top: 40px; }
				.signature { text-align: center; }
				.signature div { margin: 5px 0; }
				@@media print { body { margin: 0; } .no-print { display: none; } }
				</style>
				</head>
				<body>
				<div class="header">
					<h1>NHÀ THUỐC MELON</h1>
					<p>Địa chỉ: 140 Lê Trọng Tấn, Quận Tân Phú, TP.HCM</p>
					<p>Điện thoại: 0123-456-789 | Email: info@nhathuocmelon.com</p>
					<p>PHIẾU NHẬP THUỐC</p>
				</div>
				<div class="info">
					<div><strong>Thời gian in:</strong> ${printedAtDisplay}</div>
					<div><strong>Nhân viên in:</strong> ${currentStaffName || '(Chưa xác định)'}</div>
					<div><strong>Khoảng thời gian:</strong> Từ ${filterFrom?.value ?? ''} đến ${filterTo?.value ?? ''}</div>
					${searchInfo ? `<div><strong>Từ khóa:</strong> ${filterSearch.value}</div>` : ''}
				</div>
				<table>
					<thead>
						<tr>
							<th>STT</th>
							<th>Mã PN</th>
							<th>Ngày nhập</th>
							<th>Nhà cung cấp</th>
							<th>Ghi chú</th>
							<th class="text-right">Tổng tiền</th>
						</tr>
					</thead>
					<tbody>
						${rowsHtml}
					</tbody>
					<tfoot>
						<tr class="total">
							<td colspan="5">Tổng cộng</td>
							<td class="text-right">${formatter.format(totalAmount)}</td>
						</tr>
					</tfoot>
				</table>
				<div class="footer">
					<p><strong>Bằng chữ:</strong> ${totalInWords}</p>
				</div>
				<div class="signatures">
					<div class="signature">
						<div><strong>Người lập phiếu</strong></div>
						<div>(Ký, ghi rõ họ tên)</div>
						<div style="margin-top: 40px; border-top: 1px solid #000; width: 150px;">${currentStaffName || ''}</div>
					</div>
					<div class="signature">
						<div><strong>Người kiểm tra</strong></div>
						<div>(Ký, ghi rõ họ tên)</div>
						<div style="margin-top: 40px; border-top: 1px solid #000; width: 150px;"></div>
					</div>
					<div class="signature">
						<div><strong>Người nhận hàng</strong></div>
						<div>(Ký, ghi rõ họ tên)</div>
						<div style="margin-top: 40px; border-top: 1px solid #000; width: 150px;"></div>
					</div>
				</div>
				<div class="no-print" style="text-align: center; margin-top: 20px;">
					<button onclick="window.print()">In</button>
				</div>
				</body>
				</html>`;
				const win = window.open('', '_blank', 'width=1024,height=700');
				if (!win) {
					alert('Trình duyệt đã chặn cửa sổ in. Vui lòng cho phép popup.');
					return;
				}
				win.document.write(html);
				win.document.close();
				setTimeout(() => { try { win.focus(); win.print(); } catch { /* ignore */ } }, 500);
			});

			btnExport?.addEventListener('click', () => {
				if (!state.rows.length) {
					alert('Không có dữ liệu để xuất.');
					return;
				}
				const csvRows = [
					['MaPN', 'NgayNhap', 'NhaCungCap', 'GhiChu', 'TongTien', 'NhanVien']
				];
				state.rows.forEach(item => {
					csvRows.push([
						item.maPN ?? '',
						item.ngayNhap ?? '',
						item.tenNCC ?? '',
						(item.ghiChu ?? '').replace(/\r?\n/g, ' '),
						item.tongTien ?? 0,
						item.tenNV ?? ''
					]);
				});
				const csv = csvRows.map(row => row.map(col => `"${String(col).replace(/"/g, '""')}"`).join(',')).join('\n');
				const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
				const link = document.createElement('a');
				link.href = URL.createObjectURL(blob);
				link.download = `PhieuNhap_${filterFrom.value}_${filterTo.value}.csv`;
				link.click();
				URL.revokeObjectURL(link.href);
			});

			// Handle "Xem" (View) button click
			tableBody.addEventListener('click', async function (e) {
				const btn = e.target.closest('.btn-detail');
				if (!btn) return;
				const maPN = btn.getAttribute('data-id');
				if (!maPN) return;
				const modal = new bootstrap.Modal(document.getElementById('chiTietModal'));
				const content = document.getElementById('chiTietContent');
				content.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Đang tải chi tiết...</div>';
				try {
					const res = await fetch(`${apiBase}/PhieuNhap/GetChiTietPhieuNhapByMaPN?maPN=${encodeURIComponent(maPN)}`);
					if (!res.ok) throw new Error('Không thể tải chi tiết phiếu nhập');
					const json = await res.json();
					const data = json?.data ?? json;
					const phieu = data.PhieuNhap ?? data.phieuNhap ?? {};
					const maPhieu = phieu.MaPN ?? phieu.maPN ?? '';
					const ngayNhapRaw = phieu.NgayNhap ?? phieu.ngayNhap;
					const tenNCC = phieu.TenNCC ?? phieu.tenNCC ?? '';
					const tenNV = phieu.TenNV ?? phieu.tenNV ?? '';
					const ghiChuPhieu = phieu.GhiChu ?? phieu.ghiChu ?? '';
					const ngayNhapDisplay = ngayNhapRaw ? new Date(ngayNhapRaw).toLocaleString('vi-VN') : '';
					const chiTiet = data.ChiTiet ?? data.chiTiet ?? [];
					const rows = chiTiet.map((ct, i) => {
						const maThuoc = ct.MaThuoc ?? ct.maThuoc ?? '';
						const tenThuoc = ct.TenThuoc ?? ct.tenThuoc ?? '';
						const soLuong = ct.SoLuong ?? ct.soLuong ?? 0;
						const donGia = ct.DonGia ?? ct.donGia ?? 0;
						const thanhTien = ct.ThanhTien ?? ct.thanhTien ?? 0;
						const hanSuDungRaw = ct.HanSuDung ?? ct.hanSuDung;
						const hanSuDung = hanSuDungRaw ? new Date(hanSuDungRaw).toLocaleDateString('vi-VN') : '';
						const ghiChu = ct.GhiChu ?? ct.ghiChu ?? '';
						return `
						<tr>
							<td>${i + 1}</td>
							<td>${maThuoc}</td>
							<td>${tenThuoc}</td>
							<td>${soLuong}</td>
							<td>${Number(donGia).toLocaleString('vi-VN')}</td>
							<td>${Number(thanhTien).toLocaleString('vi-VN')}</td>
							<td>${hanSuDung}</td>
							<td>${ghiChu}</td>
						</tr>`;
					}).join('');
					content.innerHTML = `
						<div><strong>Mã phiếu:</strong> ${maPhieu}</div>
						<div><strong>Ngày nhập:</strong> ${ngayNhapDisplay}</div>
						<div><strong>Nhà cung cấp:</strong> ${tenNCC}</div>
						<div><strong>Nhân viên:</strong> ${tenNV}</div>
						<div><strong>Ghi chú:</strong> ${ghiChuPhieu}</div>
						<hr/>
						<table class="table table-bordered table-sm">
							<thead>
								<tr>
									<th>STT</th>
									<th>Mã thuốc</th>
									<th>Tên thuốc</th>
									<th>Số lượng</th>
									<th>Đơn giá</th>
									<th>Thành tiền</th>
									<th>Hạn dùng</th>
									<th>Ghi chú</th>
								</tr>
							</thead>
							<tbody>${rows || '<tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>'}</tbody>
						</table>`;
				} catch (err) {
					content.innerHTML = `<div class="text-danger">Lỗi: ${err.message}</div>`;
				}
				modal.show();
			});

			fetchPhieuNhap();
		});
	</script>
}