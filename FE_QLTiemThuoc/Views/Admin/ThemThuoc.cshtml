@{
    ViewData["Title"] = "Quản lý Thuốc";
    // Layout intentionally omitted here because this file is now used as a partial
    // The layout is provided by the parent view (Views/Admin/ThemThuoc.cshtml shim)
    var editThuoc = ViewBag.EditThuoc as FE_QLTiemThuoc.Models.ThuocViewModel;
    var thuocList = ViewBag.ThuocList as List<FE_QLTiemThuoc.Models.ThuocViewModel>;
    var loaiList = ViewBag.LoaiList as List<FE_QLTiemThuoc.Models.LoaiThuoc>;
}

<div class="container-fluid mt-4">
    <div class="row">
    <div class="col-12">
            <!-- Search / Filter card -->
            <style>
                /* page-scoped tweaks for the Thuốc filter row */
                /* unify typography and spacing */
                .thuoc-filter-card .form-label,
                .thuoc-filter-card .card-title {
                    font-size: 0.95rem;
                    line-height: 1.2;
                    color: #222;
                    margin-bottom: 0.35rem;
                    display: block;
                }
                .thuoc-filter-card form.row { align-items: center; }
                .thuoc-filter-card .form-select,
                .thuoc-filter-card .form-control,
                .thuoc-filter-card .btn {
                    height: 46px;
                    box-sizing: border-box;
                    width: 100%;
                    font-size: 0.95rem;
                    line-height: 1.2;
                    padding-top: .45rem;
                    padding-bottom: .45rem;
                }
                /* reduce left padding inside the card so it sits closer to sidebar */
                .thuoc-filter-card .card-body { padding: 0.75rem 0.9rem; }
                /* cap select column so it's narrower like the input area */
                .thuoc-filter-card .col-md-2 { max-width: 220px; }
                /* ensure select's label aligns visually with the search heading if a heading is present */
                .thuoc-filter-card .col-md-2 .form-label { padding-top: 0; margin-bottom: 0.35rem; }
                /* Reduce gap between action buttons in table rows */
                #thuocTable .d-flex.gap-2 { gap: 0.35rem !important; }
                #thuocTable .d-flex.gap-2 .btn { padding-left: .6rem; padding-right: .6rem; }
            </style>

            <!-- Fallback small script: expose run functions so buttons work even if main script failed to initialize -->
            <script>
                window._runFilter = function () {
                    try {
                        // If main applyFilters exists, use it
                        if (window.applyFilters) { window.applyFilters(); return; }
                        // Otherwise perform DOM-only filter here
                        var q = (document.getElementById('thuocSearch')?.value || '').trim().toLowerCase();
                        var loai = (document.getElementById('thuocLoaiFilter')?.value || '').trim();
                        var rows = document.querySelectorAll('#thuocTable tbody tr');
                        var matched = 0;
                        Array.from(rows).forEach(function (tr) {
                            var td0 = (tr.children[0] && tr.children[0].textContent || '').trim().toLowerCase();
                            var td2 = (tr.children[2] && tr.children[2].textContent || '').trim().toLowerCase();
                            var td5 = (tr.children[5] && tr.children[5].textContent || '').trim().toLowerCase();
                            var matchQ = false;
                            if (!q) matchQ = true;
                            else { if (td0.indexOf(q) !== -1) matchQ = true; if (td2.indexOf(q) !== -1) matchQ = true; if (td5.indexOf(q) !== -1) matchQ = true; }
                            var matchLoai = true;
                            if (loai) { var loaiText = (tr.children[1] && tr.children[1].textContent || '').trim(); matchLoai = loaiText === loai; }
                            var show = (matchQ && matchLoai);
                            tr.style.display = show ? '' : 'none';
                            if (show) matched++;
                        });
                        var panel = document.getElementById('thuocDebugPanel');
                        var out = document.getElementById('thuocDebugOutput');
                        if (panel) panel.style.display = 'none';
                        if (out) out.innerHTML = '<div>Matched: ' + matched + ' / ' + rows.length + '</div>';
                    } catch (e) { console && console.error && console.error(e); }
                };
                window._runDebug = function () {
                    try {
                        if (window.applyFilters) { window.applyFilters(); }
                        // build matched list
                        var rows = document.querySelectorAll('#thuocTable tbody tr');
                        var q = (document.getElementById('thuocSearch')?.value || '').trim().toLowerCase();
                        var loai = (document.getElementById('thuocLoaiFilter')?.value || '').trim();
                        var matched = [];
                        rows.forEach(function (tr) {
                            var text = (tr.textContent || '').toLowerCase();
                            var matchQ = (!q) || (text.indexOf(q) !== -1);
                            var matchLoai = true;
                            if (loai) { var loaiText = (tr.children[1] && tr.children[1].textContent || '').trim(); matchLoai = loaiText === loai; }
                            if (matchQ && matchLoai) matched.push({ Ma: tr.getAttribute('data-mathuoc') || (tr.children[0] && tr.children[0].textContent || '').trim(), Ten: (tr.children[2] && tr.children[2].textContent || '').trim() });
                        });
                        var panel = document.getElementById('thuocDebugPanel');
                        var out = document.getElementById('thuocDebugOutput');
                        if (panel) panel.style.display = matched.length ? 'block' : 'block';
                        if (out) out.innerHTML = matched.length ? '<pre>' + JSON.stringify(matched, null, 2) + '</pre>' : '<em>No matches</em>';
                    } catch (e) { console && console.error && console.error(e); }
                };
            </script>

            <div class="card mb-3 thuoc-filter-card">
                <div class="card-body">
                    <style>
                        /* Compact action buttons to save horizontal space */
                        .btn-action {
                            padding: .18rem .45rem; /* smaller tappable area to reduce row height */
                            font-size: .82rem;
                            line-height: 1;
                            border-radius: .35rem;
                        }
                        /* Column sizing: make image and name larger, actions smaller */
                        #thuocTable th:nth-child(1), #thuocTable td:nth-child(1) { width: 80px; }
                        #thuocTable th:nth-child(2), #thuocTable td:nth-child(2) { width: 120px; }
                        /* allow the Tên thuốc to take more space and wrap into multiple lines if needed */
                        #thuocTable th:nth-child(3), #thuocTable td:nth-child(3) {
                            min-width: 260px;
                            max-width: 1200px;
                            white-space: normal; /* allow wrap */
                        }
                        /* Giá sỉ smaller */
                        #thuocTable th:nth-child(4), #thuocTable td:nth-child(4) { width: 100px; }
                        /* Enlarge image column */
                        #thuocTable th:nth-child(5), #thuocTable td:nth-child(5) { width: 110px; }
                        /* Description column keep moderate width */
                        #thuocTable td:nth-child(6) { max-width: 340px; white-space: normal; overflow: hidden; text-overflow: ellipsis; }
                        /* Shrink actions column and make buttons share space so they never overlap */
                        #thuocTable th:nth-child(7), #thuocTable td:nth-child(7) { width: 90px; }

                        /* Larger image preview and containment (slightly reduced to shrink rows) */
                        #thuocTable td:nth-child(5) img { width: 56px; height: 56px; object-fit: contain; display: block; margin: 0 auto; }

                        /* Ensure buttons have spacing and don't overlap; each button flexes to fit */
                        #thuocTable .action-group { display: flex; gap: .35rem; justify-content: flex-end; }
                        #thuocTable .action-group .btn { flex: 1 1 auto; min-width: 42px; padding: .16rem .32rem; }

                        /* Responsive: stack buttons on very small screens */
                        @@media (max-width: 576px) {
                            #thuocTable .action-group { flex-direction: column; align-items: stretch; }
                            #thuocTable th:nth-child(7), #thuocTable td:nth-child(7) { width: auto; }
                        }
                        /* Compact table rows: even smaller padding and font-size to reduce height */
                        #thuocTable td, #thuocTable th { padding-top: .32rem; padding-bottom: .32rem; vertical-align: middle; }
                        #thuocTable td { font-size: .90rem; line-height: 1.05; }
                    </style>
                    <style>
                        /* Make the Loại select and search input visually identical */
                        #thuocFilterForm #thuocLoaiFilter, #thuocFilterForm #thuocSearch {
                            height: 46px;
                            padding: .45rem .75rem;
                            box-sizing: border-box;
                            line-height: 1.2;
                            font-size: 0.95rem;
                            border-radius: 6px;
                        }
                        /* On some browsers select uses different appearance; normalize */
                        #thuocFilterForm #thuocLoaiFilter { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
                    </style>
                    <form id="thuocFilterForm" class="row gx-2 align-items-center">
                            <div class="col-md-2">
                                <label class="form-label small mb-1" for="thuocLoaiFilter">Loại hàng</label>
                                <select id="thuocLoaiFilter" class="form-select">
                                    <option value="">Tất cả</option>
                                    @foreach (var l in loaiList ?? new List<FE_QLTiemThuoc.Models.LoaiThuoc>())
                                    {
                                        <option value="@l.MaLoaiThuoc">@l.TenLoaiThuoc</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small mb-1" for="thuocSearch">Tìm kiếm</label>
                                <input type="text" id="thuocSearch" class="form-control" placeholder="Tìm theo tên hoặc mã hoặc mô tả..." />
                            </div>
                            <div class="col-md-2 d-grid">
                                <button type="button" id="applySearchBtn" class="btn btn-primary" onclick="window._runFilter();">Tìm</button>
                            </div>
                            <div class="col-md-2 d-grid">
                                <button type="button" id="addThuocBtn" class="btn btn-primary">Thêm mới</button>
                            </div>
                            
                    </form>
                </div>
            </div>

            <!-- Debug panel removed in production -->

            <!-- List card (card grid style) -->
            <div class="card">
                <style>
                    /* Admin list thumbnail tweaks: make the image-column narrow and thumbnails small */
                    /* reduce the reserved width for the image column */
                    #thuocTable th.img-cell, #thuocTable td.img-cell { min-width:70px; width:80px; padding:0 8px !important; }
                    /* make the thumbnail a small centered square inside that column */
                    .product-thumb { width:100% !important; height:80px !important;  border-radius:6px; display:block; margin:6px auto !important; box-sizing:border-box; }
                    table.table td { vertical-align: middle; }
                </style>
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Danh sách thuốc</strong>
                    <small class="text-muted">Bảng danh sách</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="thuocTable" class="table w-100 thead-primary table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width:90px">Mã thuốc</th>
                                    <th style="width:140px">Loại</th>
                                    <th>Tên thuốc</th>
                                    <th style="width:120px">Giá sỉ</th>
                                    <th class="img-cell" style="width:80px">Ảnh</th>
                                    <th>Mô tả</th>
                                    <th style="width:110px">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in thuocList ?? new List<FE_QLTiemThuoc.Models.ThuocViewModel>())
                                {
                                    var tenLoai = loaiList?.FirstOrDefault(l => string.Equals((l.MaLoaiThuoc ?? "").Trim(), (item.MaLoaiThuoc ?? "").Trim(), StringComparison.OrdinalIgnoreCase))?.TenLoaiThuoc;
                                    <tr data-mathuoc="@item.MaThuoc" data-maloai="@item.MaLoaiThuoc">
                                        <td>@item.MaThuoc</td>
                                        <td>@(!string.IsNullOrEmpty(tenLoai) ? tenLoai : item.MaLoaiThuoc)</td>
                                        <td title="@item.TenThuoc">
                                            @{
                                                var fullName = (item.TenThuoc ?? "").Trim();
                                                if (string.IsNullOrEmpty(fullName)) {
                                                    @: 
                                                } else {
                                                    var words = fullName.Split(new[] { ' ', '\t', '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                                                    if (words.Length <= 15) {
                                                        @fullName
                                                    } else {
                                                        var sb = new System.Text.StringBuilder();
                                                        for (int wi = 0; wi < 15; wi++) {
                                                            if (wi > 0) sb.Append(' ');
                                                            sb.Append(words[wi]);
                                                        }
                                                        sb.Append("...");
                                                        @sb.ToString()
                                                    }
                                                }
                                            }
                                        </td>
                                        <td>@item.DonGiaSi.ToString("N0") đ</td>
                                        <td class="img-cell" style="vertical-align:middle;">
                                            @if (!string.IsNullOrEmpty(item.UrlAnh))
                                            {
                                                var isAbsolute = item.UrlAnh.StartsWith("http://") || item.UrlAnh.StartsWith("https://") || item.UrlAnh.StartsWith("/");
                                                var imgSrc = isAbsolute ? item.UrlAnh : Url.Content("~/assets_user/img/product/" + item.UrlAnh);
                                                <img data-filename="@item.UrlAnh" src="@imgSrc" alt="Ảnh" class="product-thumb" />
                                            }
                                        </td>
                                        <td class="text-truncate">@item.MoTa</td>
                                        <td>
                                            <div class="d-flex align-items-center action-group">
                                                <button class="btn btn-sm btn-warning btn-edit btn-action me-2" data-mathuoc="@item.MaThuoc">Sửa</button>
                                                <button class="btn btn-sm btn-info btn-details btn-action" data-mathuoc="@item.MaThuoc">Xem</button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <!-- Pagination controls inserted here -->
                        <nav id="thuocPagerNav" aria-label="Page navigation" class="mt-3">
                            <ul id="thuocPager" class="pagination pagination-sm justify-content-end mb-0"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Thuoc details (horizontal layout: image left, details right) -->
<div class="modal fade" id="thuocDetailModal" tabindex="-1" aria-labelledby="thuocDetailModalLabel" aria-hidden="true">
    <!-- widened modal: keep modal-xl and increase max-width for more horizontal space -->
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:1200px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="thuocDetailModalLabel">Chi tiết thuốc</h5>
                <!-- Use an explicit X so it always renders as expected -->
                <button type="button" class="modal-close-x" data-bs-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <style>
                    /* Simpler grid-based layout for reliability */
                    #thuocDetailModal .modal-body { font-size: 1rem; }
                    /* style explicit close X button to match look and be visible */
                    #thuocDetailModal .modal-close-x { background: transparent; border: 1px solid #444; border-radius: 3px; width: 28px; height: 18px; line-height: 14px; text-align: center; font-size: 14px; color: #222; }
                    #thuocDetailModal .modal-close-x:hover { background: #f8f9fa; }
                    /* ensure image stays contained and does not overlap form fields */
                    #thuocDetailModal .detail-img { max-width: 100%; height: auto; object-fit: contain; display: none; max-height: 360px; }
                    /* ensure injected inputs/selects fill their columns */
                    #thuocDetailModal .form-control, #thuocDetailModal .form-select, #thuocDetailModal .form-control-plaintext { width: 100% !important; }
                    #thuocDetailModal .form-control-sm, #thuocDetailModal .form-select-sm { width: 100% !important; }
                    #thuocDetailModal .detail-ten { font-size: 1.5rem; font-weight: 600; }
                    #thuocDetailModal .detail-meta { color: #6c757d; margin-bottom: 0.5rem; }
                    #thuocDetailModal .detail-row { margin-bottom: 0.5rem; color: #212529; }
                    #thuocDetailModal .detail-mota { white-space: pre-wrap; color: #212529; }
                    @@media (max-width: 767px) {
                        #thuocDetailModal .detail-ten { font-size: 1.2rem; }
                    }
                    /* add extra spacing on the right of supplier box so it doesn't touch modal border */
                    #thuocDetailModal .detail-ncc { padding-right: 1rem; }
                    #thuocDetailModal .detail-ncc .form-select, #thuocDetailModal .detail-ncc .edit-ncc { width: 100%; }
                    /* compact image controls */
                    #thuocDetailModal .import-external-btn, #thuocDetailModal .upload-file-btn { line-height: 1; }
                    #thuocDetailModal .edit-urlanh-file { padding: .25rem .5rem; }
                    #thuocDetailModal .detail-urlanh small { display: inline-block; margin-left: .4rem; }
                </style>

                <!-- Top section: image (left) + small fields (right) -->
                <div class="row mb-3 top-section align-items-start">
                    <div class="col-md-4 text-center">
                        <img class="detail-img img-fluid mb-2" src="" alt="Ảnh thuốc" />
                    </div>
                    <div class="col-md-8">
                        <h5 class="detail-ten mb-2">&nbsp;</h5>

                        <div class="row g-2 mb-2">
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Mã:</label>
                                <div class="detail-ma form-control-plaintext"></div>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Loại:</label>
                                <div class="detail-loai form-control-plaintext"></div>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Đơn vị (MaLoaiDonVi):</label>
                                <div class="detail-maloaidonvi form-control-plaintext"></div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Giá sỉ:</label>
                                <div class="detail-gia form-control-plaintext"></div>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Giá lẻ:</label>
                                <div class="detail-gia-le form-control-plaintext"></div>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Số lượng:</label>
                                <div class="detail-soluong form-control-plaintext"></div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-sm-6">
                                <label class="form-label small mb-1">Nhà cung cấp:</label>
                                <div class="detail-ncc form-control-plaintext"></div>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label small mb-1">Url ảnh:</label>
                                <div class="detail-urlanh form-control-plaintext"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom section: descriptive fields (starts below the top section) -->
                <div class="bottom-section">
                    <div class="row g-2 mb-2">
                        <div class="col-sm-6">
                            <label class="form-label small mb-1"><strong>Thành phần:</strong></label>
                            <div class="detail-thanhphan form-control-plaintext ms-2"></div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label small mb-1"><strong>Công dụng:</strong></label>
                            <div class="detail-congdung form-control-plaintext ms-2"></div>
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-sm-6">
                            <label class="form-label small mb-1"><strong>Cách dùng:</strong></label>
                            <div class="detail-cachdung form-control-plaintext ms-2"></div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label small mb-1"><strong>Lưu ý:</strong></label>
                            <div class="detail-luuy form-control-plaintext ms-2"></div>
                        </div>
                    </div>

                    <div class="row g-2 mb-2 align-items-start">
                        <div class="col-sm-6">
                            <label class="form-label small mb-1"><strong>Mô tả:</strong></label>
                            <div class="detail-mota form-control-plaintext ms-2"></div>
                        </div>
                        <div class="col-sm-6 d-flex justify-content-end align-items-start">
                            <div>
                                <button type="button" id="thuocSaveBtn" class="btn btn-primary" style="display:none; margin-right:.5rem">Lưu</button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding new medication -->
<div class="modal fade" id="thuocAddModal" tabindex="-1" aria-labelledby="thuocAddModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:1200px;">
        <div class="modal-content">
            <style>
                #thuocAddModal .modal-body { font-size: 1rem; }
                #thuocAddModal .form-control, #thuocAddModal .form-select { width: 100% !important; }
                #thuocAddModal .add-preview-img-container {
                    width: 100%;
                    display: none;                /* Default: hidden */
                    align-items: center;
                    justify-content: center;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    padding: 8px;
                    background-color: #f9f9f9;
                    margin: 0;
                }
                #thuocAddModal .add-preview-img-container.show {
                    display: flex;                /* Show when .show class added */
                }
                #thuocAddModal .add-preview-img {
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                }
            </style>
            <div class="modal-header">
                <h5 class="modal-title" id="thuocAddModalLabel">Thêm thuốc mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Top section: form fields (left) + image (right) -->
                <div class="row mb-3 top-section align-items-start">
                    <!-- Left column: Form fields -->
                    <div class="col-md-8" style="padding-right: 20px;">
                        <!-- Mã trên 1 hàng -->
                        <div class="row g-2 mb-2">
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Mã:</label>
                                <input type="text" class="form-control form-control-sm add-ma" readonly />
                            </div>
                            <div class="col-sm-8">
                                <label class="form-label small mb-1">Tên:</label>
                                <input type="text" class="form-control form-control-sm add-ten" />
                            </div>
                        </div>
                        
                        <!-- Loại, Đơn vị, Nhà cung cấp -->
                        <div class="row g-2 mb-2">
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Loại:</label>
                                <input type="text" class="form-control form-control-sm add-loai" list="loaiList" placeholder="Nhập hoặc chọn loại..." />
                                <datalist id="loaiList" class="add-loai-list"></datalist>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Đơn vị:</label>
                                <select class="form-select form-select-sm add-maloaidonvi">
                                    <option value="">-- Chọn đơn vị --</option>
                                </select>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Nhà cung cấp:</label>
                                <select class="form-select form-select-sm add-ncc">
                                    <option value="">-- Chọn NCC --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Giá sỉ, Giá lẻ, Số lượng -->
                        <div class="row g-2 mb-2">
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Giá sỉ:</label>
                                <input type="number" class="form-control form-control-sm add-gia" step="1" min="0" />
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Giá lẻ:</label>
                                <input type="number" class="form-control form-control-sm add-gia-le" step="1" min="0" />
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label small mb-1">Số lượng:</label>
                                <input type="number" class="form-control form-control-sm add-soluong" step="1" min="0" />
                            </div>
                        </div>
                    </div>

                    <!-- Right column: Image + Upload -->
                    <div class="col-md-4 text-center">
                        <div class="add-image-area w-100"></div>
                        <div class="add-preview-img-container" style="max-width: 90%; height: 140px; margin-bottom: 8px;">
                            <img class="add-preview-img" src="" alt="Ảnh thuốc" />
                        </div>
                    </div>
                </div>

                <!-- Bottom section: Thành phần, Công dụng, Cách dùng, Lưu ý, Mô tả -->
                <div class="row g-2 mb-2">
                    <div class="col-sm-6">
                        <label class="form-label small mb-1">Thành phần:</label>
                        <textarea class="form-control form-control-sm add-thanhphan" rows="2" style="font-size:0.875rem;"></textarea>
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label small mb-1">Công dụng:</label>
                        <textarea class="form-control form-control-sm add-congdung" rows="2" style="font-size:0.875rem;"></textarea>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-sm-6">
                        <label class="form-label small mb-1">Cách dùng:</label>
                        <textarea class="form-control form-control-sm add-cachdung" rows="2" style="font-size:0.875rem;"></textarea>
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label small mb-1">Lưu ý:</label>
                        <textarea class="form-control form-control-sm add-luuy" rows="2" style="font-size:0.875rem;"></textarea>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-sm-12">
                        <label class="form-label small mb-1">Mô tả:</label>
                        <textarea class="form-control form-control-sm add-mota" rows="2" style="font-size:0.875rem;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div style="width: 100%; display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button type="button" id="thuocAddSaveBtn" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function () {
    // indicate main script ran
    try { var badge = document.getElementById('jsStatusBadge'); if (badge) { badge.textContent = 'JS OK'; badge.style.background = '#28a745'; } } catch(e) {}
    // build LOAI_MAP (MaLoai -> TenLoai) for client-side lookups
    var LOAI_MAP = {};
    try {
        LOAI_MAP = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(loaiList?.ToDictionary(l => l.MaLoaiThuoc ?? "", l => l.TenLoaiThuoc ?? "") ?? new Dictionary<string,string>()));
    } catch (e) { LOAI_MAP = {}; }

    // Image URL helper: builds a local path for stored filename or returns absolute URLs unchanged.
    function sanitizeName(name) {
        if (!name) return '';
        return name.toString().replace(/[^A-Za-z0-9_\-]/g, '_');
    }
    function getImageUrl(fileNameOrUrl) {
        if (!fileNameOrUrl) return '';
        var s = fileNameOrUrl.toString().trim();
        // If it's already an absolute URL or starts with a slash, return as-is
        if (/^https?:\/\//i.test(s) || /^\//.test(s)) return s;
        // If it contains path segments, take only last segment
    if (s.indexOf('/') !== -1) s = s.split('/').pop();
    // Now s is a filename (like 'T013_12345.png') — return a local storage path
    // Use encodeURIComponent for the filename to handle non-ASCII characters safely in URLs
    return '/assets_user/img/product/' + encodeURIComponent(s);
    }

    var thuocTableEl = document.getElementById('thuocTable');
    var tableContainer = thuocTableEl ? (thuocTableEl.tBodies[0] || thuocTableEl) : document;

    // delegated click for Edit / View
    tableContainer.addEventListener('click', function (ev) {
        var btn = ev.target.closest('.btn-edit, .btn-details');
        if (!btn) return;
        ev.stopPropagation();
        var maThuoc = btn.getAttribute('data-mathuoc') || btn.closest('tr')?.getAttribute('data-mathuoc');
        if (!maThuoc) return;

        // If Edit button clicked, open modal in edit mode (inputs) and show Save button
        if (btn.classList.contains('btn-edit')) {
            console.log('Sửa thuốc: ' + maThuoc);
            fetch('https://localhost:7283/api/Thuoc/' + maThuoc)
                .then(function (res) {
                    console.log('Fetch Edit response status:', res.status, res.ok);
                    if (!res.ok) throw new Error(res.statusText || 'API error');
                    return res.json();
                })
                .then(function (response) {
                    console.log('Edit response:', response);
                    if (response.status === 1 && response.data) {
                        var t = response.data;
                        var modal = document.getElementById('thuocDetailModal');
                        if (!modal) return;

                        function setHtml(selector, html) { var el = modal.querySelector(selector); if (el) el.innerHTML = html; }

                        setHtml('.modal-title', 'Chỉnh sửa thuốc');
                        setHtml('.detail-ten', '<input class="form-control form-control-sm edit-ten" value="' + (t.tenThuoc || '') + '" />');
                        setHtml('.detail-ma', '<input class="form-control form-control-sm edit-ma" value="' + (t.maThuoc || '') + '" disabled />');
                        // build a select dropdown of Loại from LOAI_MAP for user to choose
                        (function(){
                            var sel = '<select class="form-select form-select-sm edit-loai">';
                            sel += '<option value="">-- Chọn loại --</option>';
                            try {
                                for (var code in LOAI_MAP) {
                                    if (!Object.prototype.hasOwnProperty.call(LOAI_MAP, code)) continue;
                                    var name = LOAI_MAP[code] || code;
                                    var selected = (code === (t.maLoaiThuoc || '')) ? ' selected' : '';
                                    sel += '<option value="' + code + '"' + selected + '>' + name + '</option>';
                                }
                            } catch (e) {
                                // fallback to simple input
                                sel = '<input class="form-control form-control-sm edit-loai" value="' + (t.maLoaiThuoc || '') + '" />';
                            }
                            sel += '</select>';
                            setHtml('.detail-loai', sel);
                        })();
                        setHtml('.detail-gia', '<input class="form-control form-control-sm edit-gia" value="' + (typeof t.donGiaSi !== 'undefined' ? t.donGiaSi : '') + '" />');
                        setHtml('.detail-gia-le', '<input class="form-control form-control-sm edit-gia-le" value="' + (typeof t.donGiaLe !== 'undefined' ? t.donGiaLe : '') + '" />');
                        setHtml('.detail-soluong', '<input class="form-control form-control-sm edit-soluong" value="' + (typeof t.soLuong !== 'undefined' ? t.soLuong : '') + '" />');
                        // build supplier select by fetching NCC list; fallback to input on error
                        (function () {
                            var placeholder = '<input class="form-control form-control-sm edit-ncc" value="' + (t.maNCC || '') + '" />';
                            try {
                                fetch('https://localhost:7283/api/NhaCungCap')
                                    .then(function (r) { if (!r.ok) throw new Error('NCC fetch failed'); return r.json(); })
                                    .then(function (json) {
                                        var arr = (json && json.data) ? json.data : json;
                                        if (!Array.isArray(arr) || arr.length === 0) {
                                            setHtml('.detail-ncc', placeholder);
                                            return;
                                        }
                                        var sel = '<select class="form-select form-select-sm edit-ncc">';
                                        sel += '<option value="">-- Chọn nhà cung cấp --</option>';
                                        for (var i = 0; i < arr.length; i++) {
                                            var n = arr[i];
                                            var code = n.MaNCC || n.maNCC || '';
                                            var name = n.TenNCC || n.tenNCC || code;
                                            var selAttr = (code === (t.maNCC || '')) ? ' selected' : '';
                                            sel += '<option value="' + code + '"' + selAttr + '>' + name + '</option>';
                                        }
                                        sel += '</select>';
                                        setHtml('.detail-ncc', sel);
                                    }).catch(function (e) { console.error(e); setHtml('.detail-ncc', placeholder); });
                            } catch (e) { console.error(e); setHtml('.detail-ncc', placeholder); }
                        })();
                        // Build unit select by fetching LoaiDonVi list; fallback to input on error
                        (function () {
                            var placeholder = '<input class="form-control form-control-sm edit-maloaidonvi" value="' + (t.maLoaiDonVi || '') + '" />';
                            try {
                                fetch('https://localhost:7283/api/Thuoc/LoaiDonVi')
                                    .then(function (r) { if (!r.ok) throw new Error('LoaiDonVi fetch failed'); return r.json(); })
                                    .then(function (json) {
                                        var arr = (json && json.data) ? json.data : json;
                                        if (!Array.isArray(arr) || arr.length === 0) {
                                            setHtml('.detail-maloaidonvi', placeholder);
                                            return;
                                        }
                                        var sel = '<select class="form-select form-select-sm edit-maloaidonvi">';
                                        sel += '<option value="">-- Chọn đơn vị --</option>';
                                        for (var i = 0; i < arr.length; i++) {
                                            var n = arr[i];
                                            var code = n.MaLoaiDonVi || n.maLoaiDonVi || '';
                                            var name = n.TenLoaiDonVi || n.tenLoaiDonVi || code;
                                            var selAttr = (code === (t.maLoaiDonVi || '')) ? ' selected' : '';
                                            sel += '<option value="' + code + '"' + selAttr + '>' + name + '</option>';
                                        }
                                        sel += '</select>';
                                        setHtml('.detail-maloaidonvi', sel);
                                    }).catch(function (e) { console.error(e); setHtml('.detail-maloaidonvi', placeholder); });
                            } catch (e) { console.error(e); setHtml('.detail-maloaidonvi', placeholder); }
                        })();
                        // Image chooser: choose existing image or upload a new one
                        var imageSelectorHtml = '';
                        imageSelectorHtml += '<div class="d-flex align-items-center gap-3 mb-2">';
                        imageSelectorHtml += '  <div class="form-check form-check-inline">';
                        imageSelectorHtml += '    <input class="form-check-input img-choice" type="radio" name="imgChoice" id="imgChoiceExisting" value="existing" checked />';
                        imageSelectorHtml += '    <label class="form-check-label small" for="imgChoiceExisting">Ảnh đã có</label>';
                        imageSelectorHtml += '  </div>';
                        imageSelectorHtml += '  <div class="form-check form-check-inline">';
                        imageSelectorHtml += '    <input class="form-check-input img-choice" type="radio" name="imgChoice" id="imgChoiceUpload" value="upload" />';
                        imageSelectorHtml += '    <label class="form-check-label small" for="imgChoiceUpload">Upload ảnh</label>';
                        imageSelectorHtml += '  </div>';
                        imageSelectorHtml += '  <div class="form-check form-check-inline">';
                        imageSelectorHtml += '    <input class="form-check-input img-choice" type="radio" name="imgChoice" id="imgChoiceUrl" value="url" />';
                        imageSelectorHtml += '    <label class="form-check-label small" for="imgChoiceUrl">Nhập URL ảnh</label>';
                        imageSelectorHtml += '  </div>';
                        imageSelectorHtml += '</div>';
                        imageSelectorHtml += '<div class="image-existing-area mb-1">';
                        imageSelectorHtml += '  <select class="form-select form-select-sm edit-urlanh-select" style="max-width:260px;">';
                        imageSelectorHtml += '    <option value="">(Chọn ảnh)</option>';
                        imageSelectorHtml += '  </select>';
                        imageSelectorHtml += '</div>';
                        imageSelectorHtml += '<div class="image-upload-area mb-1" style="display:none">';
                        imageSelectorHtml += '  <div class="d-flex align-items-center gap-2">';
                        imageSelectorHtml += '    <input type="file" accept="image/*" class="form-control form-control-sm edit-urlanh-file" style="max-width:260px; padding:.28rem .5rem;" />';
                        imageSelectorHtml += '    <small class="text-muted ms-2" style="font-size:.85rem">Kích thước tối ưu: 800x800</small>';
                        imageSelectorHtml += '  </div>';
                        imageSelectorHtml += '</div>';
                        imageSelectorHtml += '<div class="image-url-area mb-1" style="display:none">';
                        imageSelectorHtml += '  <input type="text" class="form-control form-control-sm edit-img-url" placeholder="Nhập đường link ảnh (http://... hoặc https://...)" style="max-width:100%;" />';
                        imageSelectorHtml += '</div>';
                        imageSelectorHtml += '<input type="hidden" class="edit-urlanh" value="' + (t.urlAnh || '') + '" />';
                        setHtml('.detail-urlanh', imageSelectorHtml);
                        setHtml('.detail-thanhphan', '<textarea class="form-control form-control-sm edit-thanhphan">' + (t.thanhPhan || '') + '</textarea>');
                        setHtml('.detail-congdung', '<textarea class="form-control form-control-sm edit-congdung">' + (t.congDung || '') + '</textarea>');
                        setHtml('.detail-cachdung', '<textarea class="form-control form-control-sm edit-cachdung">' + (t.cachDung || '') + '</textarea>');
                        setHtml('.detail-luuy', '<textarea class="form-control form-control-sm edit-luuy">' + (t.luuY || '') + '</textarea>');
                        setHtml('.detail-mota', '<textarea class="form-control form-control-sm edit-mota">' + (t.moTa || '') + '</textarea>');

                        var img = modal.querySelector('.detail-img');
                        if (img) {
                            if (t.urlAnh) { img.src = getImageUrl(t.urlAnh); img.style.display = 'block'; }
                            else { img.style.display = 'none'; }
                        }

                        // populate image select by calling API
                        (function populateImages() {
                            var select = modal.querySelector('.edit-urlanh-select');
                            var hidden = modal.querySelector('.edit-urlanh');
                            if (!select) return;
                            select.innerHTML = '<option value="">(Chọn ảnh có sẵn)</option>';
                            
                            // Define updateImageAreas in populateImages scope so it's accessible to both fetch and upload handler
                            var radios = modal.querySelectorAll('.img-choice');
                            var existingArea = modal.querySelector('.image-existing-area');
                            var uploadArea = modal.querySelector('.image-upload-area');
                            var urlArea = modal.querySelector('.image-url-area');
                            var urlInput = modal.querySelector('.edit-img-url');
                            function updateImageAreas() {
                                var val = modal.querySelector('.img-choice:checked')?.value || 'existing';
                                if (existingArea) existingArea.style.display = (val === 'existing') ? '' : 'none';
                                if (uploadArea) uploadArea.style.display = (val === 'upload') ? '' : 'none';
                                if (urlArea) urlArea.style.display = (val === 'url') ? '' : 'none';
                                if (val === 'existing') modal.dataset.uploadType = 'product';
                                else if (val === 'upload') modal.dataset.uploadType = 'temp';
                                else if (val === 'url') modal.dataset.uploadType = 'url';
                            }

                            // keep hidden input and preview in sync when user types a URL
                            if (urlInput) {
                                urlInput.addEventListener('input', function () {
                                    var v = (this.value || '').trim();
                                    if (hidden) hidden.value = v;
                                    if (v) { img.src = v; img.style.display = 'block'; }
                                    else { img.src = ''; img.style.display = 'none'; }
                                });
                            }
                            
                            function parseApiResponse(res) {
                                return res.text().then(function (txt) {
                                    if (!txt) return { ok: res.ok, body: null, text: '' };
                                    try { var j = JSON.parse(txt); return { ok: res.ok, body: j, text: null }; } catch (e) { return { ok: res.ok, body: null, text: txt }; }
                                });
                            }

                            fetch('https://localhost:7283/api/Images/List').then(function (r) { return parseApiResponse(r); })
                                .then(function (resp) {
                                    var res = resp.body || (resp.text ? resp.text : null);
                                    var arr = (resp.body && resp.body.data) ? resp.body.data : (Array.isArray(res) ? res : null) || (Array.isArray(resp.body) ? resp.body : null);
                                    if (!Array.isArray(arr)) return;
                                    arr.forEach(function (n) {
                                        var opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                                        if (n === (t.urlAnh || '')) opt.selected = true;
                                        select.appendChild(opt);
                                    });
                                    // when selecting, update hidden input and preview
                                    select.addEventListener('change', function () {
                                        hidden.value = select.value || '';
                                        if (hidden.value) { img.src = getImageUrl(hidden.value); img.style.display = 'block'; }
                                    });
                                    // wire up radio listeners
                                    radios.forEach(function (r) { r.addEventListener('change', updateImageAreas); });
                                    // initial set
                                    updateImageAreas();
                                }).catch(function (e) { console.error(e); });

                            // No explicit upload button in edit modal: uploading will happen when Save is clicked (auto-upload-to-product)
                        })();

                        var saveBtn = document.getElementById('thuocSaveBtn'); if (saveBtn) saveBtn.style.display = '';
                        try {
                            var modalObj = new bootstrap.Modal(modal);
                            modalObj.show();
                        } catch (e) {
                            console.error('Lỗi hiển thị modal Edit:', e);
                            alert('Lỗi: Không thể hiển thị modal. ' + e.message);
                        }
                    }
                }).catch(function (e) { console.error('Lỗi tải dữ liệu Edit:', e); alert('Lỗi tải dữ liệu: ' + (e && e.message ? e.message : e)); });

            return;
        }

        // Otherwise treat as details/view (read-only). Hide save button.
        var saveBtnHide = document.getElementById('thuocSaveBtn'); if (saveBtnHide) saveBtnHide.style.display = 'none';
        fetch('https://localhost:7283/api/Thuoc/' + maThuoc)
            .then(function (res) { if (!res.ok) throw new Error(res.statusText || 'API error'); return res.json(); })
            .then(function (response) {
                if (response.status === 1 && response.data) {
                    var t = response.data;
                    var modal = document.getElementById('thuocDetailModal');

                    function safeSetText(selector, value) {
                        if (!modal) return;
                        var el = modal.querySelector(selector);
                        if (!el) return;
                        el.textContent = (value === null || typeof value === 'undefined') ? '' : value;
                        el.style.display = '';
                    }

                    if (modal) {
                        safeSetText('.modal-title', t.tenThuoc || 'Chi tiết thuốc');
                        safeSetText('.detail-ten', t.tenThuoc || '');
                        safeSetText('.detail-ma', t.maThuoc || '');
                        safeSetText('.detail-loai', (t.maLoaiThuoc && LOAI_MAP[t.maLoaiThuoc]) ? LOAI_MAP[t.maLoaiThuoc] : (t.maLoaiThuoc || ''));
                        safeSetText('.detail-maloaidonvi', t.tenLoaiDonVi || t.maLoaiDonVi || '');
                        safeSetText('.detail-gia', (typeof t.donGiaSi !== 'undefined') ? (t.donGiaSi.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' đ') : '');
                        safeSetText('.detail-gia-le', (typeof t.donGiaLe !== 'undefined') ? (t.donGiaLe.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' đ') : '');
                        safeSetText('.detail-soluong', (typeof t.soLuong !== 'undefined') ? t.soLuong : '');
                        safeSetText('.detail-ncc', t.tenNCC || t.TenNCC || t.tenNcc || t.TenNcc || t.maNCC || '');
                        safeSetText('.detail-urlanh', t.urlAnh || '');
                        safeSetText('.detail-thanhphan', t.thanhPhan || '');
                        safeSetText('.detail-congdung', t.congDung || '');
                        safeSetText('.detail-cachdung', t.cachDung || '');
                        safeSetText('.detail-luuy', t.luuY || '');
                        safeSetText('.detail-mota', t.moTa || '');
                        var img = modal.querySelector('.detail-img');
                        if (img) {
                            if (t.urlAnh) { img.src = getImageUrl(t.urlAnh); img.style.display = 'block'; }
                            else { img.style.display = 'none'; }
                        }
                    }
                    var modalObj = new bootstrap.Modal(document.getElementById('thuocDetailModal'));
                    modalObj.show();
                }
            }).catch(function (e) { console.error('Lỗi tải dữ liệu View:', e); alert('Lỗi tải dữ liệu: ' + (e && e.message ? e.message : e)); });
    });

    // Save handler for inline modal edit
    var saveBtn = document.getElementById('thuocSaveBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function () {
            var modal = document.getElementById('thuocDetailModal');
            if (!modal) return;
            var ma = modal.querySelector('.edit-ma')?.value || modal.querySelector('.detail-ma')?.textContent;
            if (!ma) { alert('Không xác định mã thuốc'); return; }
            // determine chosen image source: existing / upload / url
            var imgChoice = modal.querySelector('.img-choice:checked')?.value || 'existing';
            var chosenUrlAnh = '';
            if (imgChoice === 'existing') {
                chosenUrlAnh = modal.querySelector('.edit-urlanh-select')?.value || modal.querySelector('.edit-urlanh')?.value || '';
            } else if (imgChoice === 'url') {
                chosenUrlAnh = modal.querySelector('.edit-img-url')?.value || modal.querySelector('.edit-urlanh')?.value || '';
            } else {
                // upload chosen: rely on hidden input set after a successful upload
                chosenUrlAnh = modal.querySelector('.edit-urlanh')?.value || '';
            }

            var payload = {
                maThuoc: ma,
                tenThuoc: modal.querySelector('.edit-ten')?.value || modal.querySelector('.detail-ten')?.textContent || '',
                maLoaiThuoc: modal.querySelector('.edit-loai')?.value || '',
                maLoaiDonVi: modal.querySelector('.edit-maloaidonvi')?.value || modal.querySelector('.detail-maloaidonvi')?.textContent || '',
                donGiaSi: parseFloat((modal.querySelector('.edit-gia')?.value || '0').toString().replace(/,/g, '')) || 0,
                donGiaLe: parseFloat((modal.querySelector('.edit-gia-le')?.value || '0').toString().replace(/,/g, '')) || 0,
                soLuong: parseInt(modal.querySelector('.edit-soluong')?.value || 0) || 0,
                maNCC: modal.querySelector('.edit-ncc')?.value || '',
                urlAnh: chosenUrlAnh || modal.querySelector('.edit-img-url')?.value || modal.querySelector('.detail-urlanh')?.textContent || '',
                thanhPhan: modal.querySelector('.edit-thanhphan')?.value || '',
                congDung: modal.querySelector('.edit-congdung')?.value || '',
                cachDung: modal.querySelector('.edit-cachdung')?.value || '',
                luuY: modal.querySelector('.edit-luuy')?.value || '',
                moTa: modal.querySelector('.edit-mota')?.value || ''
            };

            // client-side validation: ensure required fields (use camelCase keys from payload)
            if (!payload.tenThuoc || payload.tenThuoc.trim() === '') {
                alert('Tên thuốc là bắt buộc. Vui lòng nhập tên thuốc.');
                return;
            }
            if (!payload.maLoaiThuoc || payload.maLoaiThuoc.trim() === '') {
                alert('Mã loại thuốc (MaLoaiThuoc) là bắt buộc. Vui lòng chọn loại thuốc.');
                return;
            }
            if (!payload.maNCC || payload.maNCC.trim() === '') {
                alert('Nhà cung cấp (MaNCC) là bắt buộc. Vui lòng chọn NCC.');
                return;
            }
            if (!payload.maLoaiDonVi || payload.maLoaiDonVi.trim() === '') {
                alert('Mã loại đơn vị (MaLoaiDonVi) là bắt buộc. Vui lòng nhập.');
                return;
            }
            if (!payload.urlAnh || payload.urlAnh.trim() === '') {
                if (imgChoice === 'upload') {
                    // user chose upload mode — allow save if a new file is selected (we will auto-upload on Save)
                    var fileInputCheck = modal.querySelector('.edit-urlanh-file');
                    var fileCheck = fileInputCheck && fileInputCheck.files ? fileInputCheck.files[0] : null;
                    if (!fileCheck) {
                        alert('Bạn đã chọn upload nhưng chưa chọn file. Vui lòng chọn file trước khi lưu.');
                        return;
                    }
                    // otherwise continue; selected file will be uploaded automatically below
                } else if (imgChoice === 'url') {
                    alert('Bạn đã chọn nhập URL nhưng chưa nhập đường link ảnh. Vui lòng nhập URL hợp lệ.');
                    return;
                } else {
                    alert('Url ảnh là bắt buộc. Vui lòng chọn một ảnh từ danh sách.');
                    return;
                }
            }

            // If user uploaded a new image from temp folder, finalize it first
            var uploadedFileName = modal.querySelector('.edit-urlanh')?.value;
            var chosenMode = modal.querySelector('.img-choice:checked')?.value || 'existing';
            
            function proceedWithSave() {
                // Build FormData (backend expects form-data)
                var fd = new FormData();
                // Re-read the selected UrlAnh from the modal DOM right before sending (avoid stale payload)
                var finalUrl = '';
                try {
                    var modalEl = document.getElementById('thuocDetailModal');
                    if (modalEl) {
                        var currentChoice = modalEl.querySelector('.img-choice:checked')?.value || 'existing';
                        if (currentChoice === 'existing') {
                            finalUrl = modalEl.querySelector('.edit-urlanh-select')?.value || modalEl.querySelector('.edit-urlanh')?.value || '';
                        } else if (currentChoice === 'url') {
                            finalUrl = modalEl.querySelector('.edit-img-url')?.value || modalEl.querySelector('.edit-urlanh')?.value || '';
                        } else {
                            finalUrl = modalEl.querySelector('.edit-urlanh')?.value || '';
                        }
                    }
                } catch (e) { console.warn('Reading finalUrl from modal failed', e); }
                // Fallback to payload.urlAnh if DOM read failed
                if (!finalUrl) finalUrl = payload.urlAnh || '';
                // Append UrlAnh (backend will extract filename and will NOT upload to Cloudinary when no FileAnh present)
                fd.append('UrlAnh', finalUrl);

                // Append other fields matching ThuocDto names expected by backend ([FromForm])
                fd.append('MaThuoc', payload.maThuoc || '');
                fd.append('TenThuoc', payload.tenThuoc || '');
                fd.append('MaLoaiThuoc', payload.maLoaiThuoc || '');
                fd.append('MaLoaiDonVi', payload.maLoaiDonVi || '');
                fd.append('DonGiaSi', isFinite(payload.donGiaSi) ? payload.donGiaSi.toString() : '0');
                fd.append('DonGiaLe', isFinite(payload.donGiaLe) ? payload.donGiaLe.toString() : '0');
                fd.append('SoLuong', isFinite(payload.soLuong) ? payload.soLuong.toString() : '0');
                fd.append('MaNCC', payload.maNCC || '');
                fd.append('ThanhPhan', payload.thanhPhan || '');
                fd.append('CongDung', payload.congDung || '');
                fd.append('CachDung', payload.cachDung || '');
                fd.append('LuuY', payload.luuY || '');
                fd.append('MoTa', payload.moTa || '');

                // Do NOT append FileAnh here — that would instruct backend to upload to Cloudinary.
                // If you want backend to upload the raw file to Cloudinary, append FileAnh with a File object.

                // Debug: log what will be sent so we can confirm UrlAnh is included
                try {
                    console.log('PUT /api/Thuoc payload UrlAnh =', finalUrl);
                    // enumerate FormData entries for debugging
                    for (var pair of fd.entries()) {
                        console.log('FormData entry:', pair[0], '=', pair[1]);
                    }
                } catch (e) { console.warn('FormData debug failed', e); }

                fetch('https://localhost:7283/api/Thuoc/' + encodeURIComponent(ma), {
                    method: 'PUT',
                    body: fd
                }).then(function (res) {
                    if (res.ok) return res.json().then(function (json) { return { ok: true, body: json }; });
                    return res.text().then(function (txt) {
                        try { var j = JSON.parse(txt); return { ok: false, body: j, text: null }; } catch (e) { return { ok: false, body: null, text: txt }; }
                    });
                }).then(function (result) {
                    if (result.ok && result.body && result.body.status === 1) {
                        // successful save — fetch the updated Thuoc to get the canonical UrlAnh
                        fetch('https://localhost:7283/api/Thuoc/' + encodeURIComponent(ma))
                            .then(function (r) { if (!r.ok) throw new Error('Fetch updated Thuoc failed'); return r.json(); })
                            .then(function (resp) {
                                if (resp && resp.status === 1 && resp.data) {
                                    var updated = resp.data;
                                    try {
                                        // update table row image if present
                                        var row = document.querySelector('#thuocTable tbody tr[data-mathuoc="' + ma + '"]');
                                        if (row) {
                                            var img = row.querySelector('img.product-thumb');
                                            if (img) {
                                                var newUrl = getImageUrl(updated.urlAnh || updated.UrlAnh || updated.UrlAnhString || '');
                                                img.src = newUrl;
                                                // keep data-filename in sync
                                                if (updated.urlAnh || updated.UrlAnh) img.setAttribute('data-filename', updated.urlAnh || updated.UrlAnh);
                                            }
                                        }
                                        // update modal display fields
                                        var modal = document.getElementById('thuocDetailModal');
                                        if (modal) {
                                            var detailUrlEl = modal.querySelector('.detail-urlanh');
                                            if (detailUrlEl) detailUrlEl.textContent = updated.urlAnh || updated.UrlAnh || '';
                                            var imgEl = modal.querySelector('.detail-img');
                                            if (imgEl) {
                                                if (updated.urlAnh || updated.UrlAnh) { imgEl.src = getImageUrl(updated.urlAnh || updated.UrlAnh); imgEl.style.display = 'block'; }
                                                else imgEl.style.display = 'none';
                                            }
                                        }
                                    } catch (e) { console.warn('Updating UI after save failed', e); }
                                }
                                // finally hide modal and show success
                                var m = document.getElementById('thuocDetailModal');
                                var bs = m ? bootstrap.Modal.getInstance(m) : null;
                                if (bs) bs.hide();
                                alert('Lưu thành công!');
                            }).catch(function (e) {
                                console.warn('Could not fetch updated Thuoc:', e);
                                // fallback: reload to ensure consistency
                                window.location.reload();
                            });
                        return;
                    }
                    var msg = 'Không rõ';
                    if (result.body && result.body.message) msg = result.body.message;
                    else if (result.text) msg = result.text;
                    else if (result.body && result.body.errors) msg = JSON.stringify(result.body.errors);
                    alert('Lưu thất bại: ' + msg);
                    console.error('PUT /api/Thuoc error:', result);
                }).catch(function (e) { console.error(e); alert('Lỗi khi lưu: ' + (e && e.message ? e.message : e)); });
            }
            
            // If upload mode: either upload the selected file into product now,
            // or finalize a previously uploaded temp file. Otherwise proceed.
            var fileInputLocal = modal.querySelector('.edit-urlanh-file');
            var fileLocal = fileInputLocal && fileInputLocal.files ? fileInputLocal.files[0] : null;

            if (chosenMode === 'upload') {
                if (fileLocal) {
                    // auto-upload selected file directly into product folder
                    var fdUp = new FormData(); fdUp.append('file', fileLocal);
                    fetch('https://localhost:7283/api/Images/UploadToProduct', { method: 'POST', body: fdUp })
                        .then(function (r) { if (!r.ok) throw new Error('UploadToProduct failed'); return r.json(); })
                        .then(function (json) {
                            var fn = (json && json.data) ? (json.data.fileName || json.data) : (json && (json.fileName || null));
                            if (!fn && typeof json === 'string') fn = json;
                            if (!fn) throw new Error('Upload returned no filename');
                            if (modal) {
                                var hid = modal.querySelector('.edit-urlanh'); if (hid) hid.value = fn;
                                modal.dataset.uploadType = 'product';
                                var imgEl = modal.querySelector('.detail-img'); if (imgEl) { imgEl.src = getImageUrl(fn); imgEl.style.display = 'block'; }
                            }
                            proceedWithSave();
                        }).catch(function (e) { console.error('Auto-upload failed:', e); alert('Lỗi khi upload ảnh tự động: ' + (e && e.message ? e.message : e)); });
                    return;
                }
                // If no file selected but there is a temp uploaded filename, finalize it
                if (uploadedFileName && uploadedFileName.trim() !== '') {
                    console.log('Finalizing uploaded temp image:', uploadedFileName);
                    fetch('https://localhost:7283/api/Images/FinalizeImage', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileName: uploadedFileName })
                    }).then(function (res) {
                        if (res.ok) return res.json();
                        throw new Error('FinalizeImage failed: ' + res.statusText);
                    }).then(function (resp) {
                        console.log('Image finalized:', resp);
                        proceedWithSave();
                    }).catch(function (e) {
                        console.error('Error finalizing image:', e);
                        alert('Lỗi khi finalize ảnh: ' + e.message);
                    });
                    return;
                }
                // nothing to upload/finalize, proceed
                proceedWithSave();
            } else {
                // No upload mode: proceed directly with save
                proceedWithSave();
            }
        });
    }

    // Layout split: top section (image + basic info) and bottom section (descriptive fields).
    // No manual JS adjustment is required because the bottom section naturally flows below the top section.

    // image preview when UrlAnh input changed (if user types new name)
    var urlAnhInput = document.getElementById('UrlAnhInput');
    if (urlAnhInput) {
        urlAnhInput.addEventListener('input', function () {
            var fileName = urlAnhInput.value.trim();
            var imagePreview = document.getElementById('ImagePreview');
            if (fileName && imagePreview) { imagePreview.src = getImageUrl(fileName); imagePreview.style.display = 'block'; }
            else if (imagePreview) { imagePreview.style.display = 'none'; }
        });
    }

    // Not using DataTables on this page to avoid relying on jQuery/assets that may fail to load.
    // We'll perform simple DOM-based filtering + client-side pagination (10 items per page).
    var dataTable = null;
    var pageSize = 10;
    var currentPage = 1;
    var filteredRows = []; // array of TR elements that match current filter

    function renderPager(totalPages) {
        var pager = document.getElementById('thuocPager');
        if (!pager) return;
        pager.innerHTML = '';
        if (totalPages <= 1) {
            // hide pager nav if single page
            document.getElementById('thuocPagerNav').style.display = 'none';
            return;
        }
        document.getElementById('thuocPagerNav').style.display = '';

        // prev
        var liPrev = document.createElement('li'); liPrev.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
        var aPrev = document.createElement('a'); aPrev.className = 'page-link'; aPrev.href = '#'; aPrev.innerText = '‹';
        aPrev.addEventListener('click', function (e) { e.preventDefault(); if (currentPage > 1) showPage(currentPage - 1); });
        liPrev.appendChild(aPrev); pager.appendChild(liPrev);

        // pages (show up to 7 page buttons: first/last + neighbors)
        var start = Math.max(1, currentPage - 3);
        var end = Math.min(totalPages, currentPage + 3);
        for (var p = start; p <= end; p++) {
            var li = document.createElement('li'); li.className = 'page-item' + (p === currentPage ? ' active' : '');
            var a = document.createElement('a'); a.className = 'page-link'; a.href = '#'; a.innerText = p;
            (function (pageNum) { a.addEventListener('click', function (e) { e.preventDefault(); showPage(pageNum); }); })(p);
            li.appendChild(a); pager.appendChild(li);
        }

        // next
        var liNext = document.createElement('li'); liNext.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
        var aNext = document.createElement('a'); aNext.className = 'page-link'; aNext.href = '#'; aNext.innerText = '›';
        aNext.addEventListener('click', function (e) { e.preventDefault(); if (currentPage < totalPages) showPage(currentPage + 1); });
        liNext.appendChild(aNext); pager.appendChild(liNext);
    }

    function showPage(page) {
        if (!filteredRows) return;
        var rows = Array.from(document.querySelectorAll('#thuocTable tbody tr'));
        var total = filteredRows.length;
        var totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (page < 1) page = 1; if (page > totalPages) page = totalPages;
        currentPage = page;

        // hide all rows first
        rows.forEach(function (r) { r.style.display = 'none'; });

        // compute slice of rows to show
        var start = (currentPage - 1) * pageSize;
        var end = start + pageSize;
        var slice = filteredRows.slice(start, end);
        slice.forEach(function (r) { r.style.display = ''; });

        renderPager(totalPages);
    }

    // applyFilters reads elements at call time and uses DOM-only filtering (no DataTables)
    function applyFilters() {
        var q = (document.getElementById('thuocSearch').value || '').trim().toLowerCase();
        var loai = (document.getElementById('thuocLoaiFilter').value || '').trim().toLowerCase();

        var rows = Array.from(document.querySelectorAll('#thuocTable tbody tr'));
        var visibleItems = [];
        filteredRows = rows.filter(function (tr) {
            var ma = (tr.children[0] && tr.children[0].textContent || '').trim().toLowerCase();
            var ten = (tr.children[2] && tr.children[2].textContent || '').trim().toLowerCase();
            var mota = (tr.children[5] && tr.children[5].textContent || '').trim().toLowerCase();
            var combined = (ma + ' ' + ten + ' ' + mota);
            var rowMaloai = (tr.getAttribute('data-maloai') || '').toString().trim().toLowerCase();
            var matchQ = !q || combined.indexOf(q) !== -1;
            var matchLoai = !loai || (rowMaloai && rowMaloai === loai) || ((tr.children[1] && tr.children[1].textContent || '').trim().toLowerCase() === loai);
            var show = matchQ && matchLoai;
            if (show) visibleItems.push({ Ma: tr.getAttribute('data-mathuoc'), Ten: (tr.children[2] && tr.children[2].textContent || '').trim() });
            return show;
        });

        // update debug output if present (harmless if removed)
        var debugOutput = document.getElementById('thuocDebugOutput');
        if (debugOutput) debugOutput.innerHTML = '<div>Matched: ' + filteredRows.length + ' / ' + rows.length + '</div>' + (visibleItems.length ? '<pre>' + JSON.stringify(visibleItems, null, 2) + '</pre>' : '');

        // show first page
        currentPage = 1;
        showPage(1);
        // after rendering page, truncate long descriptions on visible rows
        truncateDescriptions();
    }

    // Truncate description cell (6th column) to maxWords words and set full text as title
    function truncateDescriptions(maxWords) {
        maxWords = maxWords || 15;
        var rows = Array.from(document.querySelectorAll('#thuocTable tbody tr'));
        rows.forEach(function (tr) {
            var td = tr.children[5];
            if (!td) return;
            var full = td.getAttribute('data-full-desc') || td.textContent || '';
            // store original full text in data attribute once
            if (!td.getAttribute('data-full-desc')) td.setAttribute('data-full-desc', full.trim());
            full = td.getAttribute('data-full-desc');
            var words = full.split(/\s+/).filter(Boolean);
            if (words.length > maxWords) {
                var shortText = words.slice(0, maxWords).join(' ') + '...';
                td.textContent = shortText;
                td.title = full;
            } else {
                td.textContent = full;
                td.title = '';
            }
        });
    }

    // wire listeners
    var searchInput = document.getElementById('thuocSearch');
    if (searchInput) searchInput.addEventListener('input', applyFilters);
    var loaiFilter = document.getElementById('thuocLoaiFilter');
    if (loaiFilter) loaiFilter.addEventListener('change', applyFilters);
    var applyBtn = document.getElementById('applySearchBtn');
    if (applyBtn) applyBtn.addEventListener('click', applyFilters);
    // expose and also add debug button listener
    window.applyFilters = applyFilters;
    var debugBtn = document.getElementById('debugCheckBtn');
    var debugPanel = document.getElementById('thuocDebugPanel');
    var debugOutput = document.getElementById('thuocDebugOutput');
    if (debugBtn) debugBtn.addEventListener('click', function () {
        applyFilters();
        // show debug panel and print matched items
        var rows = document.querySelectorAll('#thuocTable tbody tr');
        var q = (document.getElementById('thuocSearch')?.value || '').trim().toLowerCase();
        var loai = (document.getElementById('thuocLoaiFilter')?.value || '').trim();
        var matched = [];
        rows.forEach(function (tr) {
            var text = (tr.textContent || '').toLowerCase();
            var matchQ = (!q) || (text.indexOf(q) !== -1);
            var matchLoai = true;
            if (loai) { var loaiText = (tr.children[1] && tr.children[1].textContent || '').trim(); matchLoai = loaiText === loai; }
            if (matchQ && matchLoai) matched.push({ Ma: tr.getAttribute('data-mathuoc') || (tr.children[0] && tr.children[0].textContent || '').trim(), Ten: (tr.children[2] && tr.children[2].textContent || '').trim() });
        });
        if (debugPanel) debugPanel.style.display = matched.length ? 'block' : 'none';
        if (debugOutput) debugOutput.innerHTML = matched.length ? '<pre>' + JSON.stringify(matched, null, 2) + '</pre>' : '<em>No matches</em>';
    });

    // initial filter (no-op if empty)
    applyFilters();

    // Handle "Add new medication" button
    var addThuocBtn = document.getElementById('addThuocBtn');
    if (addThuocBtn) {
        addThuocBtn.addEventListener('click', function () {
            // Initialize add modal with default values
            openAddModal();
        });
    }

    // Function to open add medication modal
            function openAddModal() {
                var modal = document.getElementById('thuocAddModal');
                if (!modal) return;

                // Reset form fields
                modal.querySelector('.add-ma').value = '';
                modal.querySelector('.add-ten').value = '';
                modal.querySelector('.add-loai').value = '';
                modal.querySelector('.add-maloaidonvi').value = '';
                modal.querySelector('.add-gia').value = '';
                modal.querySelector('.add-gia-le').value = '';
                modal.querySelector('.add-soluong').value = '';
                modal.querySelector('.add-ncc').value = '';
                modal.querySelector('.add-thanhphan').value = '';
                modal.querySelector('.add-congdung').value = '';
                modal.querySelector('.add-cachdung').value = '';
                modal.querySelector('.add-luuy').value = '';
                modal.querySelector('.add-mota').value = '';

                // Reset preview image
                var previewImg = modal.querySelector('.add-preview-img');
                var previewContainer = modal.querySelector('.add-preview-img-container');
                if (previewImg) previewImg.src = '';
                if (previewContainer) previewContainer.classList.remove('show');

                // Load dropdowns
                loadLoaiDropdown('.add-loai');
                loadLoaiDonViDropdown('.add-maloaidonvi');
                loadNCCDropdown('.add-ncc');

                // Generate next medication ID
                generateNextMaThuoc();

                // Initialize image upload area
                initializeAddImageArea();

                // Show modal
                var bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            }

    // Function to generate next medication ID
    function generateNextMaThuoc() {
        fetch('https://localhost:7283/api/Thuoc')
            .then(function (r) { if (!r.ok) throw new Error('Fetch Thuoc list failed'); return r.json(); })
            .then(function (json) {
                var arr = (json && json.data) ? json.data : json;
                if (!Array.isArray(arr)) arr = [];
                
                // Find maximum numeric part from existing codes
                var maxNum = 0;
                for (var i = 0; i < arr.length; i++) {
                    var code = arr[i].maThuoc || arr[i].MaThuoc || '';
                    var numPart = parseInt(code.replace(/\D/g, '')) || 0;
                    if (numPart > maxNum) maxNum = numPart;
                }
                
                var nextMa = 'T' + String(maxNum + 1).padStart(3, '0');
                var maInput = document.querySelector('#thuocAddModal .add-ma');
                if (maInput) maInput.value = nextMa;
            })
            .catch(function (e) { 
                console.error('Error generating MaThuoc:', e);
                var maInput = document.querySelector('#thuocAddModal .add-ma');
                if (maInput) maInput.value = 'T001';
            });
    }

    // Helper functions to load dropdowns
    function loadLoaiDropdown(selector) {
        var input = document.querySelector('#thuocAddModal ' + selector);
        if (!input) return;
        
        fetch('https://localhost:7283/api/Thuoc/LoaiThuoc')
            .then(function (r) { if (!r.ok) throw new Error(); return r.json(); })
            .then(function (json) {
                var arr = (json && json.data) ? json.data : json;
                if (!Array.isArray(arr)) arr = [];
                
                var datalist = document.querySelector('#loaiList');
                if (datalist) {
                    datalist.innerHTML = '';
                    for (var i = 0; i < arr.length; i++) {
                        var opt = document.createElement('option');
                        var maLoai = arr[i].maLoaiThuoc || arr[i].MaLoaiThuoc || '';
                        var tenLoai = arr[i].tenLoaiThuoc || arr[i].TenLoaiThuoc || maLoai;
                        opt.value = tenLoai + ' (' + maLoai + ')';
                        datalist.appendChild(opt);
                    }
                }
            })
            .catch(function (e) { console.error('Error loading Loai:', e); });
    }

    function loadLoaiDonViDropdown(selector) {
        var select = document.querySelector('#thuocAddModal ' + selector);
        if (!select) return;
        
        fetch('https://localhost:7283/api/Thuoc/LoaiDonVi')
            .then(function (r) { if (!r.ok) throw new Error(); return r.json(); })
            .then(function (json) {
                var arr = (json && json.data) ? json.data : json;
                if (!Array.isArray(arr)) arr = [];
                
                select.innerHTML = '<option value="">-- Chọn đơn vị --</option>';
                for (var i = 0; i < arr.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = arr[i].maLoaiDonVi || arr[i].MaLoaiDonVi || '';
                    opt.textContent = arr[i].tenLoaiDonVi || arr[i].TenLoaiDonVi || opt.value;
                    select.appendChild(opt);
                }
            })
            .catch(function (e) { console.error('Error loading LoaiDonVi:', e); });
    }

    function loadNCCDropdown(selector) {
        var select = document.querySelector('#thuocAddModal ' + selector);
        if (!select) return;
        
        fetch('https://localhost:7283/api/NhaCungCap')
            .then(function (r) { if (!r.ok) throw new Error(); return r.json(); })
            .then(function (json) {
                var arr = (json && json.data) ? json.data : json;
                if (!Array.isArray(arr)) arr = [];
                
                select.innerHTML = '<option value="">-- Chọn nhà cung cấp --</option>';
                for (var i = 0; i < arr.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = arr[i].maNCC || arr[i].MaNCC || '';
                    opt.textContent = arr[i].tenNCC || arr[i].TenNCC || opt.value;
                    select.appendChild(opt);
                }
            })
            .catch(function (e) { console.error('Error loading NCC:', e); });
    }

    // Initialize image upload area for add modal
                 // Initialize image upload area for add modal
        function initializeAddImageArea() {
            var modal = document.getElementById('thuocAddModal');
            if (!modal) return;

            var imageArea = modal.querySelector('.add-image-area');
            if (!imageArea) return;

            // Build HTML
            var imageHtml = '';
            imageHtml += '<div class="d-flex align-items-center gap-3 mb-2">';
            imageHtml += '  <div class="form-check form-check-inline">';
            imageHtml += '    <input class="form-check-input add-img-choice" type="radio" name="addImgChoice" id="addImgChoiceExisting" value="existing" />';
            imageHtml += '    <label class="form-check-label small" for="addImgChoiceExisting">Ảnh đã có</label>';
            imageHtml += '  </div>';
            imageHtml += '  <div class="form-check form-check-inline">';
            imageHtml += '    <input class="form-check-input add-img-choice" type="radio" name="addImgChoice" id="addImgChoiceUpload" value="upload" checked />';
            imageHtml += '    <label class="form-check-label small" for="addImgChoiceUpload">Upload ảnh</label>';
            imageHtml += '  </div>';
            imageHtml += '  <div class="form-check form-check-inline">';
            imageHtml += '    <input class="form-check-input add-img-choice" type="radio" name="addImgChoice" id="addImgChoiceUrl" value="url" />';
            imageHtml += '    <label class="form-check-label small" for="addImgChoiceUrl">Nhập URL ảnh</label>';
            imageHtml += '  </div>';
            imageHtml += '</div>';

            // Existing images area
            imageHtml += '<div class="add-existing-area mb-1" style="display:none;">';
            imageHtml += '  <select class="form-select form-select-sm add-img-select" style="max-width:260px;">';
            imageHtml += '    <option value="">(Chọn ảnh)</option>';
            imageHtml += '  </select>';
            imageHtml += '</div>';

            // Upload area (file input only). Upload will happen when user clicks Save.
            imageHtml += '<div class="add-upload-area mb-1" style="display:block;">';
            imageHtml += '  <label class="form-label small mb-1">Chọn file ảnh (tối đa 5MB):</label>';
            imageHtml += '  <div class="d-flex gap-2 align-items-center">';
            imageHtml += '    <input type="file" accept="image/*" class="form-control form-control-sm add-img-file" style="max-width:260px;" />';
            imageHtml += '  </div>';
            imageHtml += '</div>';
            
            // URL input area: allow entering an external image URL (no upload / no saving)
            imageHtml += '<div class="add-url-area mb-1" style="display:none;">';
            imageHtml += '  <input type="text" class="form-control form-control-sm add-img-url" placeholder="Nhập đường link ảnh (http://... hoặc https://...)" style="max-width:100%;" />';
            imageHtml += '</div>';

            // Hidden UrlAnh
            imageHtml += '<input type="hidden" class="add-urlanh" />';

            imageArea.innerHTML = imageHtml;

            // Elements
            var fileInput = modal.querySelector('.add-img-file');
            var uploadBtn = modal.querySelector('.add-img-upload-btn');
            var previewImg = modal.querySelector('.add-preview-img');
            var previewContainer = modal.querySelector('.add-preview-img-container');
            var urlAnhHidden = modal.querySelector('.add-urlanh');
            var existingArea = modal.querySelector('.add-existing-area');
            var uploadArea = modal.querySelector('.add-upload-area');
            var urlArea = modal.querySelector('.add-url-area');
            var urlInput = modal.querySelector('.add-img-url');
            var select = modal.querySelector('.add-img-select');
            var radioButtons = modal.querySelectorAll('.add-img-choice');

            // Local preview on file select
            if (fileInput) {
                fileInput.addEventListener('change', function (event) {
                    var file = event.target.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            if (previewImg) previewImg.src = e.target.result;
                            if (previewContainer) previewContainer.classList.add('show');
                        };
                        reader.readAsDataURL(file);
                        // Clear hidden UrlAnh so backend knows a new file is provided
                        if (urlAnhHidden) urlAnhHidden.value = '';
                    } else {
                        if (previewImg) previewImg.src = '';
                        if (previewContainer) previewContainer.classList.remove('show');
                    }
                });
            }

            // No explicit upload button: uploading occurs when user clicks Save.

            // When select changes (existing image chosen)
            if (select) {
                select.addEventListener('change', function () {
                    var fileName = this.value;
                    if (urlAnhHidden) urlAnhHidden.value = fileName;
                    if (modal) modal.dataset.uploadType = 'product';

                    if (fileName) {
                        var imgUrl = getImageUrl(fileName);
                        if (previewImg) previewImg.src = imgUrl;
                        if (previewContainer) previewContainer.classList.add('show');
                    } else {
                        if (previewImg) previewImg.src = '';
                        if (previewContainer) previewContainer.classList.remove('show');
                    }
                });
            }

            // Toggle existing/upload radio
            radioButtons.forEach(function (radio) {
                radio.addEventListener('change', function () {
                    if (this.value === 'existing') {
                        if (existingArea) existingArea.style.display = 'block';
                        if (uploadArea) uploadArea.style.display = 'none';
                        if (urlArea) urlArea.style.display = 'none';

                        if (fileInput) fileInput.value = '';
                        if (select) select.dispatchEvent(new Event('change'));
                        if (modal) modal.dataset.uploadType = 'product';
                    } else if (this.value === 'upload') {
                        if (existingArea) existingArea.style.display = 'none';
                        if (uploadArea) uploadArea.style.display = 'block';
                        if (urlArea) urlArea.style.display = 'none';
                        if (urlAnhHidden) urlAnhHidden.value = '';
                        if (previewImg) previewImg.src = '';
                        if (previewContainer) previewContainer.classList.remove('show');
                        if (modal) modal.dataset.uploadType = 'temp';
                    } else if (this.value === 'url') {
                        if (existingArea) existingArea.style.display = 'none';
                        if (uploadArea) uploadArea.style.display = 'none';
                        if (urlArea) urlArea.style.display = 'block';
                        // keep hidden in sync
                        if (urlInput) urlAnhHidden.value = (urlInput.value || '').trim();
                        if (urlInput && urlInput.value) { if (previewImg) previewImg.src = urlInput.value; if (previewContainer) previewContainer.classList.add('show'); }
                        if (modal) modal.dataset.uploadType = 'url';
                    }
                });
            });

            // Keep hidden UrlAnh and preview in sync when user types URL
            if (urlInput) {
                urlInput.addEventListener('input', function () {
                    var v = (this.value || '').trim();
                    if (urlAnhHidden) urlAnhHidden.value = v;
                    if (v) { if (previewImg) previewImg.src = v; if (previewContainer) previewContainer.classList.add('show'); }
                    else { if (previewImg) previewImg.src = ''; if (previewContainer) previewContainer.classList.remove('show'); }
                });
            }

            // Load existing images list from backend
            fetch('https://localhost:7283/api/Images/List')
                .then(function (r) { if (!r.ok) throw new Error('List failed'); return r.json(); })
                .then(function (json) {
                    var arr = (json && json.data) ? json.data : json;
                    if (!Array.isArray(arr)) arr = [];

                    if (select && arr.length > 0) {
                        arr.forEach(function (name) {
                            var opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            select.appendChild(opt);
                        });
                    }
                })
                .catch(function (e) { console.error('Error loading images:', e); });

            // Ensure hidden UrlAnh is empty initially
            if (urlAnhHidden) urlAnhHidden.value = '';
        }

                // Attach upload handler
        

    // Handle save for add modal
            // Handle save for add modal
                var addSaveBtn = document.getElementById('thuocAddSaveBtn');
            if (addSaveBtn) {
                addSaveBtn.addEventListener('click', function () {
                    var modal = document.getElementById('thuocAddModal');
                    if (!modal) return;

                    // 1. Trích xuất dữ liệu form
                    var maThuoc = modal.querySelector('.add-ma')?.value || '';
                    var tenThuoc = modal.querySelector('.add-ten')?.value || '';
                    var loaiInput = modal.querySelector('.add-loai')?.value || '';
                    var maLoaiThuoc = loaiInput.match(/\(([^)]+)\)$/) ? loaiInput.match(/\(([^)]+)\)$/)[1] : loaiInput;
                    var maLoaiDonVi = modal.querySelector('.add-maloaidonvi')?.value || '';
                    var donGiaSi = (modal.querySelector('.add-gia')?.value || '0').toString().replace(/,/g, '');
                    var donGiaLe = (modal.querySelector('.add-gia-le')?.value || '0').toString().replace(/,/g, '');
                    var soLuong = modal.querySelector('.add-soluong')?.value || '0';
                    var maNCC = modal.querySelector('.add-ncc')?.value || '';
                    var thanhPhan = modal.querySelector('.add-thanhphan')?.value || '';
                    var congDung = modal.querySelector('.add-congdung')?.value || '';
                    var cachDung = modal.querySelector('.add-cachdung')?.value || '';
                    var luuY = modal.querySelector('.add-luuy')?.value || '';
                    var moTa = modal.querySelector('.add-mota')?.value || '';

                    var fileInput = modal.querySelector('.add-img-file');
                    var file = fileInput.files && fileInput.files[0];
                    var urlAnhHidden = modal.querySelector('.add-urlanh');

                    var imgChoice = modal.querySelector('.add-img-choice:checked')?.value || 'upload';
                    // Re-read select/hidden/right-now url input to avoid stale value
                    var selectEl = modal.querySelector('.add-img-select');
                    var selectedVal = '';
                    if (selectEl) {
                        selectedVal = selectEl.value || (selectEl.options && selectEl.selectedIndex >= 0 ? (selectEl.options[selectEl.selectedIndex].value || '') : '');
                    }
                    var urlInputEl = modal.querySelector('.add-img-url');
                    var urlAnh = '';
                    if (imgChoice === 'existing') {
                        urlAnh = (urlAnhHidden && urlAnhHidden.value) ? urlAnhHidden.value : (selectedVal || '');
                    } else if (imgChoice === 'url') {
                        urlAnh = (urlInputEl && (urlInputEl.value || '').trim()) ? urlInputEl.value.trim() : '';
                    } else {
                        urlAnh = '';
                    }

                    // 2. Validation cơ bản (client-side) — ensure required fields exist before sending
                    if (!tenThuoc || tenThuoc.trim() === '') {
                        alert('Tên thuốc là bắt buộc.');
                        return;
                    }
                    if (!maLoaiDonVi || maLoaiDonVi.trim() === '') {
                        alert('Vui lòng chọn đơn vị.');
                        return;
                    }
                    // Ensure MaThuoc has been generated (generateNextMaThuoc is async)
                    if (!maThuoc || maThuoc.trim() === '') {
                        // try to regenerate and instruct user to retry
                        generateNextMaThuoc();
                        alert('Mã thuốc chưa sẵn sàng. Vui lòng chờ vài giây rồi thử lại.');
                        return;
                    }
                    // Ensure loại thuốc code is present (the input stores "Ten (Ma)")
                    if (!maLoaiThuoc || maLoaiThuoc.trim() === '') {
                        alert('Vui lòng chọn hoặc nhập loại thuốc (ví dụ: "Paracetamol (L001)").');
                        return;
                    }
                    // Ensure nhà cung cấp is selected
                    if (!maNCC || maNCC.trim() === '') {
                        alert('Vui lòng chọn nhà cung cấp.');
                        return;
                    }

                    // Kiểm tra: Phải có file mới HOẶC URL cũ
                    if (!file && !urlAnh) {
                        alert('Vui lòng chọn file ảnh mới (để upload lên Cloudinary) hoặc chọn ảnh đã có.');
                        return;
                    }

                    // 3. Xây dựng FormData
                    var formData = new FormData();

                    // Recompute finalUrl right before send (defensive)
                    var finalUrl = '';
                    try {
                        var modalEl = document.getElementById('thuocAddModal');
                        if (modalEl) {
                            var currentChoice = modalEl.querySelector('.add-img-choice:checked')?.value || 'upload';
                            var sel = modalEl.querySelector('.add-img-select');
                            var hidden = modalEl.querySelector('.add-urlanh');
                            var selVal = '';
                            if (sel) selVal = sel.value || (sel.options && sel.selectedIndex >= 0 ? (sel.options[sel.selectedIndex].value || '') : '');
                            var hidVal = hidden ? (hidden.value || '') : '';
                            if (currentChoice === 'existing') finalUrl = hidVal || selVal || '';
                            else finalUrl = hidVal || '';
                        }
                    } catch (e) { console.warn('Could not recompute finalUrl', e); }

                    // We'll append UrlAnh and FileAnh later, just before sending, to avoid double-uploads.

                    // Warn if user selected existing but finalUrl is empty
                    if (!finalUrl && imgChoice === 'existing') {
                        console.warn('Add modal: existing image selected but UrlAnh is empty. Select value:', selectEl ? selectEl.value : '(no select)');
                    }

                    // Debug: enumerate FormData so developer can confirm UrlAnh is present
                    try {
                        console.log('POST /api/Thuoc FormData entries (add):');
                        for (var pair of formData.entries()) {
                            console.log('  ' + pair[0] + ' = ', pair[1]);
                        }
                    } catch (e) { console.warn('FormData debug failed', e); }

                    // Đính kèm các trường dữ liệu khác
                    formData.append('MaThuoc', maThuoc);
                    formData.append('TenThuoc', tenThuoc);
                    formData.append('MaLoaiThuoc', maLoaiThuoc);
                    formData.append('MaLoaiDonVi', maLoaiDonVi);
                    formData.append('DonGiaSi', donGiaSi);
                    formData.append('DonGiaLe', donGiaLe);
                    formData.append('SoLuong', soLuong);
                    formData.append('MaNCC', maNCC);
                    formData.append('ThanhPhan', thanhPhan);
                    formData.append('CongDung', congDung);
                    formData.append('CachDung', cachDung);
                    formData.append('LuuY', luuY);
                    formData.append('MoTa', moTa);

                    // 4. Gửi Request POST (Backend C# sẽ xử lý Signed Upload Cloudinary)
                    function proceedWithSave() {
                        // Recompute finalUrl now and append to FormData
                        try {
                            var modalEl2 = document.getElementById('thuocAddModal');
                            var currentChoice2 = modalEl2 ? (modalEl2.querySelector('.add-img-choice:checked')?.value || 'upload') : 'upload';
                            var sel2 = modalEl2 ? modalEl2.querySelector('.add-img-select') : null;
                            var hid2 = modalEl2 ? modalEl2.querySelector('.add-urlanh') : null;
                            var selVal2 = '';
                            if (sel2) selVal2 = sel2.value || (sel2.options && sel2.selectedIndex >= 0 ? (sel2.options[sel2.selectedIndex].value || '') : '');
                            var hidVal2 = hid2 ? (hid2.value || '') : '';
                            var urlInput2 = modalEl2 ? modalEl2.querySelector('.add-img-url') : null;
                            var finalUrl2 = '';
                            if (currentChoice2 === 'existing') {
                                finalUrl2 = hidVal2 || selVal2 || '';
                            } else if (currentChoice2 === 'url') {
                                finalUrl2 = (urlInput2 && (urlInput2.value || '').trim()) ? urlInput2.value.trim() : (hidVal2 || '');
                            } else {
                                finalUrl2 = (hidVal2 || '');
                            }
                            // set UrlAnh on formData
                            formData.set('UrlAnh', finalUrl2);

                            // Append FileAnh only if image was NOT already uploaded into product
                            var addModalEl2 = document.getElementById('thuocAddModal');
                            var uploadType2 = addModalEl2 ? (addModalEl2.dataset.uploadType || '') : '';
                            var fileInput2 = addModalEl2 ? addModalEl2.querySelector('.add-img-file') : null;
                            var file2 = fileInput2 && fileInput2.files ? fileInput2.files[0] : null;
                            if (file2 && uploadType2 !== 'product') {
                                formData.set('FileAnh', file2);
                            } else {
                                // ensure FileAnh is not sent if already uploaded to product
                                try { formData.delete && formData.delete('FileAnh'); } catch(e) {}
                            }
                        } catch (e) { console.warn('Could not recompute UrlAnh/FileAnh before send', e); }

                        fetch('https://localhost:7283/api/Thuoc', {
                            method: 'POST',
                            body: formData
                        })
                        .then(function (res) {
                            return res.text().then(function (txt) { return { ok: res.ok, text: txt }; });
                        })
                        .then(function (result) {
                            var jsonBody = null;
                            try { jsonBody = JSON.parse(result.text); } catch (e) { /* ignore */ }

                            if (result.ok && jsonBody && jsonBody.status === 1) {
                                // Nếu có file được upload, save vào IndexedDB (local storage) bên FE
                                if (file) {
                                    console.log('Saving image file to local storage:', file.name);
                                    saveImageToLocalStorage(file, jsonBody.data.imageFileName || file.name);
                                }
                                alert('Thêm thuốc thành công!');
                                var bsModal = bootstrap.Modal.getInstance(modal);
                                if (bsModal) bsModal.hide();

                                location.reload();
                            } else {
                                var msg = jsonBody && jsonBody.message ? jsonBody.message : result.text;
                                alert('Lỗi: ' + (msg || 'Unknown error'));
                                console.error('API Error:', result.text);
                            }
                        })
                        .catch(function (e) {
                            console.error('Network/Save error:', e);
                            alert('Lỗi khi lưu: ' + (e && e.message ? e.message : e));
                        });
                    }

                    // Decide how to finalize/upload image before saving
                    (function decideAndSave() {
                        var addModalEl = document.getElementById('thuocAddModal');
                        var uploadedFileName = addModalEl ? (addModalEl.querySelector('.add-urlanh')?.value || '') : '';
                        var fileInputLocal = addModalEl ? addModalEl.querySelector('.add-img-file') : null;
                        var fileLocal = fileInputLocal && fileInputLocal.files ? fileInputLocal.files[0] : null;

                        // If a new file was selected, upload it now into product folder (backend handles duplicate names)
                        if (fileLocal) {
                            var fd2 = new FormData(); fd2.append('file', fileLocal);
                            fetch('https://localhost:7283/api/Images/UploadToProduct', { method: 'POST', body: fd2 })
                                .then(function (r) { if (!r.ok) throw new Error('UploadToProduct failed'); return r.json(); })
                                .then(function (json) {
                                    var fn = (json && json.data) ? (json.data.fileName || json.data) : (json && (json.fileName || json.fileName === '' ? json.fileName : null));
                                    if (!fn) fn = (json && json.data && typeof json.data === 'string') ? json.data : null;
                                    if (fn) {
                                        if (addModalEl) addModalEl.querySelector('.add-urlanh').value = fn;
                                        // mark that the file was stored into product folder so we don't send the binary again
                                        if (addModalEl) addModalEl.dataset.uploadType = 'product';
                                    }
                                    proceedWithSave();
                                }).catch(function (e) {
                                    console.error('Auto-upload failed:', e);
                                    alert('Lỗi khi upload ảnh tự động: ' + (e && e.message ? e.message : e));
                                });
                            return;
                        }

                        // No new file selected: if an existing image name is set, just proceed, otherwise proceed without image
                        proceedWithSave();
                    })();
                });
            }

            // Hàm lưu ảnh vào IndexedDB (local storage)
            function saveImageToLocalStorage(file, fileName) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var db = indexedDB.open('ThuocImages', 1);
                    db.onupgradeneeded = function(event) {
                        var store = event.target.result.createObjectStore('images', { keyPath: 'fileName' });
                    };
                    db.onsuccess = function(event) {
                        var database = event.target.result;
                        var tx = database.transaction('images', 'readwrite');
                        var store = tx.objectStore('images');
                        store.put({ fileName: fileName, data: e.target.result });
                        console.log('Image saved to IndexedDB:', fileName);
                    };
                };
                reader.readAsArrayBuffer(file);
            }

            // Hàm lấy ảnh từ IndexedDB để hiển thị
            function getImageFromLocalStorage(fileName) {
                return new Promise(function(resolve, reject) {
                    var db = indexedDB.open('ThuocImages', 1);
                    db.onsuccess = function(event) {
                        var database = event.target.result;
                        var tx = database.transaction('images', 'readonly');
                        var store = tx.objectStore('images');
                        var request = store.get(fileName);
                        request.onsuccess = function() {
                            if (request.result) {
                                var blob = new Blob([request.result.data], { type: 'image/jpeg' });
                                resolve(URL.createObjectURL(blob));
                            } else {
                                resolve(null);
                            }
                        };
                        request.onerror = function() {
                            reject(request.error);
                        };
                    };
                });
            }
    
    // DEBUG: Catch any page reload attempts to see what triggers it
    window.addEventListener('beforeunload', function(e) {
        console.log('beforeunload event fired - page is about to reload/unload');
        console.trace();
    });
    
    // Override location.reload to see who calls it
    var _origReload = window.location.reload.bind(window.location);
    window.location.reload = function() {
        console.error('window.location.reload() called!');
        console.trace();
        return _origReload();
    };
});
</script>
}
