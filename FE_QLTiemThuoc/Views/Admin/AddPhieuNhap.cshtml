@model FE_QLTiemThuoc.Models.PhieuNhapDto
@{
	ViewData["Title"] = "Thêm phiếu nhập";
}

<style>
/* Bright tweaks scoped to this view */
.add-phieu .card-header { background: #f6fbff !important; color: #0b3d91 !important; border: none; }
.add-phieu .card { background: #fff; }
.add-phieu .bg-dark { background: linear-gradient(90deg,#eef6ff,#ffffff) !important; color: #0b3d91 !important; }
.add-phieu .total-box { min-height:56px; display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-radius:6px; background:linear-gradient(90deg,#f1fbf8,#fff); color:#0b7f66; font-weight:700 }
.add-phieu .col-md-6 { display:flex; flex-direction:column; }
.add-phieu .col-md-6 .form-label { margin-bottom:6px }
.add-phieu .col-md-6 .form-control { flex:0 0 auto }
.add-phieu .table thead th { background:#f6fbff !important; color:#0b3d91 !important }
.add-phieu .table td, .add-phieu .table th { vertical-align:middle }
.add-phieu .remove-row { display:inline-flex; align-items:center; justify-content:center; height:38px; padding:6px 12px }
.add-phieu .remove-row .bi { margin-right:6px }
.add-phieu .form-control, .add-phieu .form-select { background:#fff }
.add-phieu .btn-primary { background:#0bb199; border-color:#0bb199 }
.add-phieu .row.g-3.mt-2 > .col-md-6 .form-control { min-height:56px }
</style>

<div class="container-fluid py-4 add-phieu">
	<div class="card shadow border-0">
		<div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
			<h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Thêm phiếu nhập</h5>
			<button class="btn btn-outline-light btn-sm" id="btnBackList"><i class="bi bi-list-ul me-1"></i>Danh sách phiếu</button>
		</div>
		<div class="card-body">
			<div id="formAlert"></div>
			<form id="phieuNhapForm" novalidate>
				<input type="hidden" asp-for="MaPN" id="MaPNHidden" />
				<div class="row g-3">
					<div class="col-md-4">
						<label class="form-label">Ngày nhập</label>
						<input asp-for="NgayNhap" class="form-control" type="datetime-local" value="@(ViewBag.DefaultNgayNhap ?? DateTime.Now.ToString("yyyy-MM-ddTHH:mm"))" />
					</div>
					<div class="col-md-4">
						<label class="form-label">Nhà cung cấp</label>
						<input class="form-control" id="nccNameInput" list="nccOptions" placeholder="-- Chọn nhà cung cấp --" autocomplete="off" />
						<datalist id="nccOptions"></datalist>
						<input asp-for="MaNCC" type="hidden" id="MaNCCHidden" />
						<small><a href="/Admin/QuanLyNCC" class="text-muted">Quản lý nhà cung cấp</a></small>
					</div>
					<div class="col-md-4">
						<label class="form-label">Nhân viên</label>
						<input class="form-control" value="@(ViewBag.TenNV ?? ViewBag.MaNV ?? string.Empty)" readonly />
						<input asp-for="MaNV" type="hidden" value="@(ViewBag.MaNV ?? string.Empty)" />
					</div>
				</div>

				<div class="row g-3 mt-2">
					<div class="col-md-6">
						<label class="form-label">Tổng tiền</label>
						<div class="bg-dark text-white rounded p-3 d-flex justify-content-between align-items-center total-box">
							<span>Tổng tiền</span>
							<strong id="TongTienDisplay">0</strong>
							<input asp-for="TongTien" type="hidden" id="TongTien" value="0" />
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label">Ghi chú</label>
						<input asp-for="GhiChu" class="form-control" placeholder="Ghi chú (không bắt buộc)" />
					</div>
				</div>

				<hr />
				<div class="d-flex justify-content-between align-items-center mb-2">
					<h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Chi tiết phiếu nhập</h6>
					<button class="btn btn-outline-primary btn-sm" type="button" id="addChiTiet"><i class="bi bi-plus-circle me-1"></i>Thêm dòng</button>
				</div>
				<div class="table-responsive">
					<table class="table table-bordered align-middle" id="chiTietTable">
						<thead class="table-dark">
							<tr>
								<th style="width:16%">Thuốc</th>
								<th style="width:9%">Số lượng</th>
								<th style="width:11%">Đơn giá</th>
								<th style="width:11%">Thành tiền</th>
								<th style="width:14%">Ghi chú</th>
								<th style="width:13%">Hạn dùng</th>
								<th style="width:14%">Đơn vị tồn kho</th>
								<th style="width:8%"></th>
							</tr>
						</thead>
						<tbody id="chiTietBody"></tbody>
					</table>
				</div>

				<div class="mt-3 text-center">
					<button type="submit" class="btn btn-primary me-2" id="btnSubmit"><i class="bi bi-save me-1"></i>Lưu &amp; cập nhật tồn kho</button>
					<button type="button" class="btn btn-secondary" id="btnReset"><i class="bi bi-arrow-clockwise me-1"></i>Làm mới</button>
				</div>
			</form>

			<div class="mt-4 text-center" id="postSaveActions" style="display:none">
				<button class="btn btn-success me-2" id="btnNhapTiep"><i class="bi bi-plus-circle me-1"></i>Thêm phiếu khác</button>
				<button class="btn btn-outline-primary me-2" id="btnPrint"><i class="bi bi-printer me-1"></i>In phiếu</button>
				<a class="btn btn-outline-secondary" href="/Admin/NhapThuocList"><i class="bi bi-arrow-left-circle me-1"></i>Về danh sách</a>
			</div>
		</div>
	</div>
</div>

<div id="addPhieuDebug" style="position:fixed; right:12px; bottom:12px; background:#fff; border:1px solid #ddd; padding:8px 10px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.06); font-size:12px; z-index:9999; max-width:320px;">
	<strong>Debug</strong>
	<div id="dbg_lastMatched">last: -</div>
	<div id="dbg_lastUnit">unit: -</div>
</div>

<datalist id="thuocOptions"></datalist>

@section Scripts {
<script>
(function(){
	const apiBaseRaw = '@(ViewBag.ApiBase ?? "/api")';
	const apiBase = (typeof apiBaseRaw === 'string' ? apiBaseRaw : '/api').replace(/\/+$/, '');
	const PRINTED_BY = '@(ViewBag.TenNV ?? "")';
	console.debug && console.debug('Api base for AddPhieuNhap:', apiBase);

	const NCC_PRELOAD = (function(){
		try {
			const encoded = '@System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(System.Text.Json.JsonSerializer.Serialize(ViewBag.NCCList ?? new List<FE_QLTiemThuoc.Models.NhaCungCap>())))';
			return JSON.parse(atob(encoded));
		} catch { return []; }
	})();
	const THUOC_PRELOAD = (function(){
		try {
			const encoded = '@System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(System.Text.Json.JsonSerializer.Serialize(ViewBag.ThuocList ?? new List<FE_QLTiemThuoc.Models.ThuocViewModel>())))';
			return JSON.parse(atob(encoded));
		} catch { return []; }
	})();

	const form = document.getElementById('phieuNhapForm');
	const chiBody = document.getElementById('chiTietBody');
	const totalField = document.getElementById('TongTien');
	const totalDisplay = document.getElementById('TongTienDisplay');
	const btnSubmit = document.getElementById('btnSubmit');
	const btnReset = document.getElementById('btnReset');
	const btnBackList = document.getElementById('btnBackList');
	const btnPrint = document.getElementById('btnPrint');
	const btnNhapTiep = document.getElementById('btnNhapTiep');
	const postActions = document.getElementById('postSaveActions');
	const nccNameInput = document.getElementById('nccNameInput');
	const nccHidden = document.getElementById('MaNCCHidden');
	const nccOptions = document.getElementById('nccOptions');

	const state = {
		suppliers: [],
		supplierMap: {},
		drugs: [],
		drugLookup: {},
		drugUnits: {},
		drugRaw: {},
		unitList: [],
		savedMaPN: null
	};

	function normalize(text){
		if (!text) return '';
		try { return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
		catch { return text.toLowerCase(); }
	}

	function showAlert(type, message){
		const box = document.getElementById('formAlert');
		if (!box) return;
		const cls = type === 'success' ? 'alert-success' : 'alert-danger';
		box.innerHTML = `<div class="alert ${cls} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
		box.scrollIntoView({ behavior: 'smooth', block: 'center' });
	}

	btnBackList?.addEventListener('click', () => window.location.href = '/Admin/NhapThuocList');

	function renderSupplierOptions(query){
		const normalized = normalize(query);
		const ranked = state.suppliers.slice().sort((a,b) => {
			const ra = supplierRank(normalized, a.norm), rb = supplierRank(normalized, b.norm);
			if (ra.tier !== rb.tier) return ra.tier - rb.tier;
			if (ra.dist !== rb.dist) return ra.dist - rb.dist;
			return a.name.localeCompare(b.name);
		}).slice(0, 20);
		nccOptions.innerHTML = '';
		ranked.forEach(item => {
			const opt = document.createElement('option');
			opt.value = item.name;
			nccOptions.appendChild(opt);
		});
	}

	function supplierRank(q, name){
		if (!q) return { tier: 0, dist: name.length };
		const idx = name.indexOf(q);
		if (idx === 0) return { tier: 0, dist: Math.abs(name.length - q.length) };
		if (name.split(/\s+/).some(word => word.startsWith(q))) return { tier: 1, dist: 0 };
		if (idx > 0) return { tier: 2, dist: idx };
		return { tier: 3, dist: levenshtein(q, name) };
	}

	function levenshtein(a, b){
		const m = a.length, n = b.length;
		if (!m) return n;
		if (!n) return m;
		const dp = Array.from({ length: m + 1 }, () => new Array(n + 1));
		for (let i = 0; i <= m; i++) dp[i][0] = i;
		for (let j = 0; j <= n; j++) dp[0][j] = j;
		for (let i = 1; i <= m; i++){
			for (let j = 1; j <= n; j++){
				const cost = a[i-1] === b[j-1] ? 0 : 1;
				dp[i][j] = Math.min(
					dp[i-1][j] + 1,
					dp[i][j-1] + 1,
					dp[i-1][j-1] + cost
				);
			}
		}
		return dp[m][n];
	}

	function loadSupplierData(list){
		state.suppliers = (list || []).map(item => {
			const name = (item.TenNCC ?? item.tenNCC ?? '').trim();
			const code = (item.MaNCC ?? item.maNCC ?? '').trim();
			if (!name) return null;
			state.supplierMap[name] = code;
			return { name, code, norm: normalize(name) };
		}).filter(Boolean);
		renderSupplierOptions(nccNameInput?.value || '');
	}

	function syncSupplier(){
		const raw = (nccNameInput?.value || '').trim();
		if (!raw) { nccHidden.value = ''; return; }
		// direct exact match from prebuilt map
		if (state.supplierMap[raw]) {
			nccHidden.value = state.supplierMap[raw];
			return;
		}
		// try normalized matching (best-effort)
		const q = normalize(raw);
		let found = state.suppliers.find(s => s.norm === q);
		if (!found) {
			// startsWith or contains
			found = state.suppliers.find(s => s.norm.startsWith(q) || s.norm.includes(q));
		}
		if (found) {
			nccHidden.value = found.code || '';
			return;
		}
		// fallback: try case-insensitive exact on displayed name
		found = state.suppliers.find(s => s.name.toLowerCase() === raw.toLowerCase());
		if (found) {
			nccHidden.value = found.code || '';
			return;
		}
		// not found -> clear hidden so backend won't receive stale value
		nccHidden.value = '';
	}

	async function ensureSuppliers(){
		if (state.suppliers.length) return;
		loadSupplierData(NCC_PRELOAD);
		if (state.suppliers.length) return;
		try {
			const res = await fetch(`${apiBase}/NhaCungCap`);
			if (!res.ok) throw new Error(res.statusText);
			const json = await res.json();
			const data = json?.data ?? json ?? [];
			loadSupplierData(Array.isArray(data) ? data : []);
		} catch (err) {
			console.warn('Load NCC thất bại', err);
		}
	}

	function renderThuocOptions(query){
		const dl = document.getElementById('thuocOptions');
		if (!dl) return;
		dl.innerHTML = '';
		const normalized = normalize(query);
		let count = 0;
		state.drugs.forEach(item => {
			if (!normalized || item.normName.includes(normalized) || item.normCode.includes(normalized)){
				const opt = document.createElement('option');
				opt.value = `${item.code} - ${item.name}`;
				dl.appendChild(opt);
				if (++count >= 200) return;
			}
		});
	}

	function loadDrugData(list){
		const data = list || [];
		state.drugs = [];
		state.drugLookup = {};
		state.drugUnits = {};
		state.drugRaw = {};
		data.forEach(item => {
			const code = (item.MaThuoc ?? item.maThuoc ?? '').trim();
			const name = (item.TenThuoc ?? item.tenThuoc ?? '').trim();
			if (!code && !name) return; // nothing useful
			// skip registering entries that lack a code to avoid creating a "" key in drugUnits/drugRaw
			if (!code) return;
			const maLDV = (item.MaLoaiDonVi ?? item.maLoaiDonVi ?? '').trim();
			const tenLDV = (item.TenLoaiDonVi ?? item.tenLoaiDonVi ?? maLDV) || '';
			state.drugs.push({ code, name, normCode: normalize(code), normName: normalize(name) });
			state.drugLookup[`${code} - ${name}`] = code;
			state.drugLookup[`${name} - ${code}`] = code;
			state.drugLookup[code] = code;
			state.drugUnits[code] = { code: maLDV, name: tenLDV };
			state.drugRaw[code] = item;
		});
		console.debug && console.debug('Loaded drugs:', state.drugs.length, 'units:', Object.keys(state.drugUnits).length);
		renderThuocOptions('');
	}

	function findDrugCode(input){
		if (!input) return '';
		const v = input.trim();
		// exact lookup
		if (state.drugLookup[v]) return state.drugLookup[v];
		// if user typed 'CODE - NAME' take the left part
		if (v.indexOf(' - ') > -1) return v.split(' - ')[0];
		// normalized search: match by code or name contains
		const nv = normalize(v);
		for (const d of state.drugs){
			if (d.normCode === nv || d.normName === nv) return d.code;
			if (d.normCode.includes(nv) || d.normName.includes(nv)) return d.code;
		}
		return '';
	}

	async function ensureDrugs(){
		if (state.drugs.length) return;
		loadDrugData(THUOC_PRELOAD);
		if (state.drugs.length) return;
		try {
			const res = await fetch(`${apiBase}/Thuoc/ListThuocDetail`);
			if (!res.ok) throw new Error(res.statusText);
			const json = await res.json();
			const data = json?.data ?? json ?? [];
			loadDrugData(Array.isArray(data) ? data : []);
		} catch (err) {
			console.warn('Load thuốc thất bại', err);
		}
	}

	async function loadUnitList(){
		if (state.unitList.length) return state.unitList;
		try {
			const res = await fetch(`${apiBase}/Thuoc/LoaiDonVi`);
			if (!res.ok) throw new Error(res.statusText);
			const json = await res.json();
			const data = json?.data ?? json ?? [];
			if (Array.isArray(data)) state.unitList = data;
		} catch (err) {
			console.warn('Load đơn vị thất bại', err);
		}
		return state.unitList;
	}

	function createRow(){
		const idx = chiBody.querySelectorAll('tr').length;
		const tr = document.createElement('tr');
		tr.className = 'chi-item';
		tr.innerHTML = `
			<td>
				<input class="form-control form-control-sm ma-thuoc-display" list="thuocOptions" placeholder="Mã / Tên thuốc" autocomplete="off" />
				<input type="hidden" name="ChiTietPhieuNhaps[${idx}].MaThuoc" class="ma-thuoc-hidden" />
			</td>
			<td><input class="form-control form-control-sm so-luong" name="ChiTietPhieuNhaps[${idx}].SoLuong" type="number" min="1" value="1" /></td>
			<td><input class="form-control form-control-sm don-gia" name="ChiTietPhieuNhaps[${idx}].DonGia" type="number" min="0" step="0.01" value="0" /></td>
			<td><input class="form-control form-control-sm thanh-tien" name="ChiTietPhieuNhaps[${idx}].ThanhTien" type="number" step="0.01" value="0" readonly /></td>
				<td><input class="form-control form-control-sm ghi-chu" name="ChiTietPhieuNhaps[${idx}].GhiChu" type="text" placeholder="Ghi chú (không bắt buộc)" /></td>
				<td><input class="form-control form-control-sm han-su-dung" name="ChiTietPhieuNhaps[${idx}].HanSuDung" type="date" /></td>
			<td>
				<select class="form-select form-select-sm don-vi-select" name="ChiTietPhieuNhaps[${idx}].MaLoaiDonViNhap">
					<option value="">-- Đơn vị tồn kho --</option>
				</select>
			</td>
			<td class="text-center"><button class="btn btn-outline-danger btn-sm remove-row" type="button" title="Xóa dòng"><i class="bi bi-x-lg"></i> <span class="d-none d-sm-inline">Xóa</span></button></td>
		`;
		chiBody.appendChild(tr);
		attachRowHandlers(tr);
		// focus the new drug input so user can continue typing quickly
		try {
			const newDisp = tr.querySelector('.ma-thuoc-display');
			if (newDisp) setTimeout(() => { try { newDisp.focus(); } catch(e){} }, 30);
		} catch(e) { /* ignore focus failures */ }
		return tr;
	}

	function attachRowHandlers(row){
		const disp = row.querySelector('.ma-thuoc-display');
		const hidden = row.querySelector('.ma-thuoc-hidden');
		const qty = row.querySelector('.so-luong');
		const price = row.querySelector('.don-gia');
		const amount = row.querySelector('.thanh-tien');
		const unitSelect = row.querySelector('.don-vi-select');

		// when user types, show suggestions and if they type a recognized code/value,
		// immediately set the hidden code and lock the unit select to the drug's default unit
		disp?.addEventListener('input', async () => {
			renderThuocOptions(disp.value || '');
			const val = (disp.value || '').trim();
			if (!val) return;
			// ensure drug & unit metadata are loaded before attempting to lock/select unit
			await ensureDrugs();
			await loadUnitList();
			const matched = findDrugCode(val);
			if (matched) {
				hidden.value = matched;
				console.log && console.log('Matched drug for input', val, '->', matched, state.drugUnits[matched]);
				// update on-screen debug
				document.getElementById('dbg_lastMatched').textContent = 'last: ' + val + ' -> ' + matched;
				// if we don't have unit info for this drug (missing code or empty), try reloading full detail once
				const unitEntry = state.drugUnits[matched];
				if (!unitEntry || !unitEntry.code) {
					console.log && console.log('No unit code for', matched, '-> reloading ListThuocDetail');
					try{
						const r = await fetch(`${apiBase}/Thuoc/ListThuocDetail`);
						if (r.ok){
							const j = await r.json();
							const data = j?.data ?? j ?? [];
							loadDrugData(Array.isArray(data) ? data : []);
							console.log && console.log('After reload, unit for', matched, '->', state.drugUnits[matched]);
						}
					} catch(e){ console.warn('Reload thuốc failed', e); }
				}
				lockUnitByDrug(unitSelect, hidden.value);
			}
		});

		// when input receives focus ensure options are ready and render suggestions
		disp?.addEventListener('focus', async () => {
			try {
				await ensureDrugs();
				renderThuocOptions(disp.value || '');
			} catch(e) { /* ignore */ }
		});

		// also on blur ensure final selection is applied (covers pick-from-datalist)
		disp?.addEventListener('blur', async () => {
			const value = (disp.value || '').trim();
			await ensureDrugs();
			await loadUnitList();
			const code = findDrugCode(value);
			hidden.value = code;
			console.log && console.log('Blur drug input', value, '->', code);
			document.getElementById('dbg_lastMatched').textContent = 'last (blur): ' + value + ' -> ' + code;
			lockUnitByDrug(unitSelect, hidden.value);
		});

		// datalist selection can also trigger change event - handle it immediately
		disp?.addEventListener('change', async () => {
			const value = (disp.value || '').trim();
			if (!value) return;
			await ensureDrugs();
			await loadUnitList();
			const code = findDrugCode(value);
			hidden.value = code;
			console.log && console.log('Change drug input', value, '->', code);
			document.getElementById('dbg_lastMatched').textContent = 'last (change): ' + value + ' -> ' + code;
			lockUnitByDrug(unitSelect, hidden.value);
		});

		row.querySelector('.remove-row')?.addEventListener('click', () => {
			row.remove();
			renumberRows();
			recalcTotal();
		});

		const onChange = () => {
			const sl = parseFloat(qty.value) || 0;
			const dg = parseFloat(price.value) || 0;
			const tt = sl * dg;
			amount.value = tt.toFixed(2);
			recalcTotal();
		};
		qty?.addEventListener('input', onChange);
		price?.addEventListener('input', onChange);

		// ensure unit options are present; populate with known units and try to preselect
		loadUnitList().then(() => populateUnitSelect(unitSelect));
	}

	function renumberRows(){
		chiBody.querySelectorAll('.chi-item').forEach((row, index) => {
			row.querySelectorAll('input, select').forEach(el => {
				const name = el.getAttribute('name');
				if (!name) return;
				el.setAttribute('name', name.replace(/ChiTietPhieuNhaps\[\d+\]/, `ChiTietPhieuNhaps[${index}]`));
			});
		});
	}

	function recalcTotal(){
		let sum = 0;
		chiBody.querySelectorAll('.thanh-tien').forEach(inp => {
			sum += parseFloat(inp.value) || 0;
		});
		totalField.value = sum.toFixed(2);
		totalDisplay.textContent = sum.toLocaleString('vi-VN');
	}

	function populateUnitSelect(select){
		if (!select) return;
		select.innerHTML = '<option value="">-- Đơn vị tồn kho --</option>';
		state.unitList.forEach(item => {
			const code = (item.MaLoaiDonVi ?? item.maLoaiDonVi ?? '').trim();
			const name = (item.TenLoaiDonVi ?? item.tenLoaiDonVi ?? code) || '';
			if (!code) return;
			const opt = document.createElement('option');
			opt.value = code;
			opt.textContent = name;
			select.appendChild(opt);
		});
		// if the row already has a MaThuoc, try to preselect its unit (but don't disable here)
		try {
			const tr = select.closest('tr');
			const hidden = tr?.querySelector('.ma-thuoc-hidden');
			const drugCode = hidden?.value || '';
			if (drugCode) {
				const info = state.drugUnits[drugCode];
				if (info && info.code) {
					// if option exists, select it; otherwise append then select
					let found = Array.from(select.options).find(o => o.value === info.code);
					if (!found) {
						const opt = document.createElement('option');
						opt.value = info.code;
						opt.textContent = info.name || info.code;
						select.appendChild(opt);
					}
					select.value = info.code;
				}
			}
		} catch (e) { /* ignore */ }
		select.disabled = false;
	}

	function lockUnitByDrug(select, drugCode){
		if (!select) return;
		const info = state.drugUnits[drugCode];
		// if info missing or has empty code, try extracting from raw payload
		let unitInfo = info && info.code ? info : null;
		if ((!unitInfo || !unitInfo.code) && state.drugRaw[drugCode]){
			const raw = state.drugRaw[drugCode];
			const ma = (raw.MaLoaiDonVi ?? raw.maLoaiDonVi ?? raw.maLoaiDonViId ?? raw.maLoaiDonViNhap ?? '').trim();
			const ten = (raw.TenLoaiDonVi ?? raw.tenLoaiDonVi ?? raw.tenDonVi ?? raw.tenLoaiDonViNhap ?? '').trim();
			if (ma) {
				unitInfo = { code: ma, name: ten || ma };
				state.drugUnits[drugCode] = unitInfo; // cache it
				console.debug && console.debug('Recovered unit from raw for', drugCode, unitInfo);
			}
		}
		// populate the select with available units then pre-select the drug's default unit
		populateUnitSelect(select);
		try {
			const codeToSelect = (unitInfo && unitInfo.code) || '';
			if (codeToSelect) {
				let found = Array.from(select.options).find(o => o.value === codeToSelect);
				if (!found) {
					const opt = document.createElement('option');
					opt.value = codeToSelect;
					opt.textContent = (unitInfo && unitInfo.name) || codeToSelect;
					select.appendChild(opt);
				}
				select.value = codeToSelect;
				// update debug panel and log raw object for diagnosis
				document.getElementById('dbg_lastUnit').textContent = 'unit: ' + codeToSelect + ' (' + ((unitInfo && unitInfo.name) || '') + ')';
				console.log && console.log('lockUnitByDrug: raw=', state.drugRaw[drugCode], 'unitInfo=', unitInfo, 'unitListLen=', state.unitList.length);
			}
			// leave select enabled so user can change unit if desired
			select.disabled = false;
		} catch (e) { console.warn('lockUnitByDrug error', e); }
	}

	btnReset?.addEventListener('click', () => {
		form.reset();
		nccHidden.value = '';
		chiBody.innerHTML = '';
		createRow();
		recalcTotal();
		showAlert('success', 'Đã làm mới biểu mẫu.');
	});

	nccNameInput?.addEventListener('input', () => {
		renderSupplierOptions(nccNameInput.value || '');
	});
	nccNameInput?.addEventListener('blur', syncSupplier);
	nccNameInput?.addEventListener('change', syncSupplier);

	document.getElementById('addChiTiet')?.addEventListener('click', () => {
		createRow();
	});

	form?.addEventListener('submit', async (ev) => {
		ev.preventDefault();
		await ensureSuppliers();
		await ensureDrugs();
		await loadUnitList();
		syncSupplier();

		const errors = [];
		const chiTiet = [];
		chiBody.querySelectorAll('.chi-item').forEach((row, index) => {
			const maThuoc = (row.querySelector('.ma-thuoc-hidden')?.value || '').trim();
			const soLuong = parseFloat(row.querySelector('.so-luong')?.value) || 0;
			const donGia = parseFloat(row.querySelector('.don-gia')?.value) || 0;
			const thanhTien = parseFloat(row.querySelector('.thanh-tien')?.value) || 0;
			const hanSuDung = (row.querySelector('.han-su-dung')?.value || '').trim();
			const ghiChuItem = (row.querySelector('.ghi-chu')?.value || '').trim();
			const donVi = (row.querySelector('.don-vi-select')?.value || '').trim();
			const rowLabel = index + 1;
			if (!maThuoc) errors.push(`Dòng ${rowLabel}: chưa chọn thuốc.`);
			if (!hanSuDung) errors.push(`Dòng ${rowLabel}: chưa nhập hạn sử dụng.`);
			if (!donVi) errors.push(`Dòng ${rowLabel}: chưa chọn đơn vị tồn kho.`);
			if (soLuong <= 0) errors.push(`Dòng ${rowLabel}: số lượng phải lớn hơn 0.`);
			chiTiet.push({
				MaThuoc: maThuoc,
				SoLuong: soLuong,
				DonGia: donGia,
				ThanhTien: thanhTien,
				HanSuDung: hanSuDung || null,
				GhiChu: ghiChuItem || null,
				MaLoaiDonViNhap: donVi || null
			});
		});

		if (!chiTiet.length) errors.push('Phiếu nhập phải có ít nhất một dòng chi tiết.');
		if (errors.length){
			showAlert('error', errors.join('<br/>'));
			return;
		}

		const payload = {
			MaPN: document.getElementById('MaPNHidden').value || undefined,
			NgayNhap: document.querySelector('input[name="NgayNhap"]').value || new Date().toISOString(),
			MaNCC: nccHidden.value || null,
			MaNV: document.querySelector('input[name="MaNV"]').value || null,
			TongTien: parseFloat(totalField.value) || 0,
			GhiChu: document.querySelector('input[name="GhiChu"]').value || '',
			ChiTietPhieuNhaps: chiTiet
		};

		btnSubmit.disabled = true;
		btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Đang lưu...';

		try {
			const res = await fetch(`${apiBase}/PhieuNhap/AddPhieuNhap`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			if (!res.ok) throw new Error(await res.text());
			const json = await res.json();
			const message = json?.message || 'Lưu phiếu nhập thành công.';
			const maPN = json?.data || payload.MaPN || null;
			state.savedMaPN = maPN;
			showAlert('success', `${message}${maPN ? ` (Mã: ${maPN})` : ''}`);
			// disable inputs and selects to prevent edits after save
			form.querySelectorAll('input, select').forEach(el => el.disabled = true);
			// hide the primary action buttons (Lưu & Làm mới) temporarily
			try {
				if (btnSubmit) btnSubmit.style.display = 'none';
				if (btnReset) btnReset.style.display = 'none';
			} catch(e) { /* ignore */ }
			// also disable other buttons except Back to list and post-save actions
			form.querySelectorAll('button').forEach(el => {
				if (['btnBackList','btnNhapTiep','btnPrint'].includes(el.id)) return;
				if (el !== btnSubmit && el !== btnReset) el.disabled = true;
			});
			postActions.style.display = '';
		} catch (err) {
			console.error('Save failed', err);
			showAlert('error', `Lưu thất bại: ${err.message || err}`);
		} finally {
			btnSubmit.disabled = false;
			btnSubmit.innerHTML = '<i class="bi bi-save me-1"></i>Lưu &amp; cập nhật tồn kho';
		}
	});

	btnNhapTiep?.addEventListener('click', () => {
			// restore buttons and re-enable inputs
			form.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
			if (btnSubmit) { btnSubmit.style.display = ''; btnSubmit.disabled = false; }
			if (btnReset) { btnReset.style.display = ''; btnReset.disabled = false; }
			form.reset();
			nccHidden.value = '';
			chiBody.innerHTML = '';
			createRow();
			recalcTotal();
			postActions.style.display = 'none';
			state.savedMaPN = null;
	});

	btnPrint?.addEventListener('click', async () => {
		if (!state.savedMaPN){
			showAlert('error', 'Chưa có mã phiếu để in.');
			return;
		}
		try {
			const res = await fetch(`${apiBase}/PhieuNhap/GetChiTietPhieuNhapByMaPN?maPN=${encodeURIComponent(state.savedMaPN)}`);
			if (!res.ok) throw new Error(res.statusText);
			const json = await res.json();
			openPrintWindow(json?.data ?? json, state.savedMaPN);
		} catch (err){
			showAlert('error', `Không thể tải dữ liệu in: ${err.message || err}`);
		}
	});

	function openPrintWindow(payload, maPN){
		if (!payload) return;
		const phieu = payload.phieuNhap ?? payload.PhieuNhap ?? payload;
		const items = payload.chiTiet ?? payload.ChiTiet ?? payload.items ?? payload;
		let total = phieu?.TongTien ?? phieu?.tongTien ?? 0;
		if (!total && Array.isArray(items)){
			total = items.reduce((sum, item) => sum + (item.ThanhTien ?? item.thanhTien ?? 0), 0);
		}
		const rows = Array.isArray(items) ? items.map((item, idx) => {
			const ten = item.TenThuoc ?? item.tenThuoc ?? '';
			const ma = item.MaThuoc ?? item.maThuoc ?? '';
			const so = item.SoLuong ?? item.soLuong ?? 0;
			const donGia = item.DonGia ?? item.donGia ?? 0;
			const thanhTien = item.ThanhTien ?? item.thanhTien ?? 0;
			const hsd = item.HanSuDung ?? item.hanSuDung ?? '';
			const hsdDisplay = hsd ? new Date(hsd).toLocaleDateString('vi-VN') : '';
			return `<tr><td>${idx + 1}</td><td>${ma}</td><td>${ten}</td><td>${so}</td><td>${donGia.toLocaleString('vi-VN')}</td><td>${thanhTien.toLocaleString('vi-VN')}</td><td>${hsdDisplay}</td></tr>`;
		}).join('') : '<tr><td colspan="7" class="text-center">Không có chi tiết</td></tr>';

		function numberToVietnameseWords(n){
			if (n === 0) return 'Không đồng';
			const chuSo = ['không','một','hai','ba','bốn','năm','sáu','bảy','tám','chín'];
			const tien = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];
			function read3Digits(num){
				let tram = Math.floor(num/100);
				let chuc = Math.floor((num%100)/10);
				let donvi = num%10;
				let str = '';
				if (tram>0) str += chuSo[tram] + ' trăm';
				if (chuc>1) {
					str += (str? ' ' : '') + chuSo[chuc] + ' mươi';
					if (donvi===1) str += ' mốt';
					else if (donvi===5) str += ' lăm';
					else if (donvi>0) str += ' ' + chuSo[donvi];
				} else if (chuc===1) {
					str += (str? ' ' : '') + 'mười';
					if (donvi===1) str += ' một';
					else if (donvi===5) str += ' lăm';
					else if (donvi>0) str += ' ' + chuSo[donvi];
				} else if (chuc===0) {
					if (donvi>0) str += (str? ' lẻ ' : '') + chuSo[donvi];
				}
				return str;
			}
			let i = 0; let words = [];
			while (n>0){
				const part = n % 1000;
				if (part>0){
					const partWords = read3Digits(part);
					words.unshift(partWords + (tien[i]? ' ' + tien[i] : ''));
				}
				n = Math.floor(n/1000);
				i++;
			}
			let result = words.join(' ').replace(/\s+/g,' ').trim();
			// capitalize first letter
			result = result.charAt(0).toUpperCase() + result.slice(1) + ' đồng';
			return result;
		}

	const printedAt = new Date().toLocaleString('vi-VN');
	const printedBy = PRINTED_BY || phieu?.TenNV || phieu?.tenNV || '';
		const html = `
			<html><head><meta charset="utf-8" />
				<title>Phiếu nhập ${maPN || ''}</title>
				<style>
					@@page { size: A4; margin: 1.5cm; }
					body { font-family: 'Times New Roman', serif; font-size: 13pt; line-height: 1.3; color: #000; margin: 0; }
					.header { text-align: center; margin-bottom: 20px; }
					.company { font-size: 14pt; font-weight: bold; text-transform: uppercase; }
					.company-info { font-size: 11pt; }
					.title { font-size: 18pt; font-weight: bold; text-transform: uppercase; margin: 20px 0; }
					.receipt-no { font-style: italic; }
					.info-section { margin: 15px 0; }
					.info-row { display: flex; margin: 5px 0; }
					.info-label { width: 120px; }
					table { width: 100%; border-collapse: collapse; margin: 20px 0; }
					th, td { border: 1px solid #000; padding: 8px; }
					th { background: #f8f8f8; text-align: center; }
					td { vertical-align: middle; }
					.text-center { text-align: center; }
					.text-right { text-align: right; }
					.summary { margin: 15px 0; }
					.total-text { margin-top: 5px; font-style: italic; }
					.signature-section { display: flex; justify-content: space-between; margin-top: 40px; }
					.signature-block { flex: 1; text-align: center; max-width: 200px; }
					.signature-title { font-weight: bold; margin-bottom: 80px; }
					.signature-name { margin-top: 5px; }
					.footer { position: fixed; bottom: 20px; left: 0; right: 0; text-align: center; font-size: 11pt; }
					.no-break { page-break-inside: avoid; }
				</style>
			</head>
			<body>
				<div class="header">
					<div class="company">NHÀ THUỐC MELON</div>
					<div class="company-info">Địa chỉ: 140 Lê Trọng Tấn, Tân Phú, TP. Đà Nẵng</div>
					<div class="company-info">Điện thoại: (0236) 3 888 999 - MST: 0123456789</div>
					
					<div class="title">PHIẾU NHẬP KHO</div>
					<div class="receipt-no">Số: ${maPN || phieu?.MaPN || phieu?.maPN || ''}</div>
				</div>

				<div class="info-section">
					<div class="info-row">
						<span class="info-label">Ngày nhập:</span>
						<span>${(phieu?.NgayNhap ?? phieu?.ngayNhap) ? new Date(phieu?.NgayNhap ?? phieu?.ngayNhap).toLocaleString('vi-VN', {
							year: 'numeric',
							month: 'numeric',
							day: 'numeric',
							hour: '2-digit',
							minute: '2-digit'
						}) : ''}</span>
					</div>
					<div class="info-row">
						<span class="info-label">Nhà cung cấp:</span>
						<span>${phieu?.TenNCC ?? phieu?.tenNCC ?? ''}</span>
					</div>
					<div class="info-row">
						<span class="info-label">Người lập:</span>
						<span>${phieu?.TenNV ?? phieu?.tenNV ?? ''}</span>
					</div>
					${(phieu?.GhiChu ?? phieu?.ghiChu) ? `
					<div class="info-row">
						<span class="info-label">Ghi chú:</span>
						<span>${phieu?.GhiChu ?? phieu?.ghiChu}</span>
					</div>
					` : ''}
				</div>
				
				<div class="no-break">
				<table>
					<thead>
						<tr>
							<th style="width:40px">STT</th>
							<th style="width:80px">Mã thuốc</th>
							<th>Tên thuốc</th>
							<th style="width:80px">Số lượng</th>
							<th style="width:100px">Đơn giá<br/><span style="font-size:9pt">(VNĐ)</span></th>
							<th style="width:120px">Thành tiền<br/><span style="font-size:9pt">(VNĐ)</span></th>
							<th style="width:100px">Hạn dùng</th>
						</tr>
					</thead>
					<tbody>${rows}</tbody>
				</table>

				<div class="summary">
					<div style="font-weight:bold">Tổng tiền: ${Number(total || 0).toLocaleString('vi-VN')} VNĐ</div>
					<div class="total-text">Bằng chữ: ${numberToVietnameseWords(Math.round(total) || 0)}</div>
				</div>
				</div>

				<div class="signature-section">
					<div class="signature-block">
						<div class="signature-title">Người giao hàng</div>
						<div class="signature-name">(Ký, họ tên)</div>
					</div>
					<div class="signature-block">
						<div class="signature-title">Người lập phiếu</div>
						<div class="signature-name">${phieu?.TenNV ?? phieu?.tenNV ?? ''}</div>
					</div>
					<div class="signature-block">
						<div class="signature-title">Thủ kho</div>
						<div class="signature-name">(Ký, họ tên)</div>
					</div>
					<div class="signature-block">
						<div class="signature-title">Kế toán</div>
						<div class="signature-name">(Ký, họ tên)</div>
					</div>
				</div>

				<div class="footer">
					<div>In lúc: ${printedAt} - Người in: ${printedBy}</div>
				</div>
			</body></html>`;

		const win = window.open('', '_blank', 'width=1024,height=700');
		if (!win) {
			alert('Trình duyệt chặn cửa sổ in. Vui lòng cho phép popup.');
			return;
		}
		win.document.write(html);
		win.document.close();
		setTimeout(() => {
			try { win.focus(); win.print(); } catch {}
		}, 600);
	}

	Promise.all([ensureSuppliers(), ensureDrugs(), loadUnitList()]).then(() => {
		if (!chiBody.querySelector('.chi-item')) createRow();
	});

})();
</script>
}


