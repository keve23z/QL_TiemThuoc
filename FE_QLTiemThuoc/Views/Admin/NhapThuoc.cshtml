@{
	ViewData["Title"] = "Nhập thuốc";
}

<div class="container-fluid mt-3">
	<div class="card mb-3">
		<div class="card-body">
			<div class="row align-items-end gx-2">
				<div class="col-auto">
					<label class="form-label small mb-1">Từ ngày</label>
					<input type="date" id="filterFrom" class="form-control form-control-sm" value="@(ViewBag.DefaultFrom ?? DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd"))" />
				</div>
				<div class="col-auto">
					<label class="form-label small mb-1">Đến ngày</label>
					<input type="date" id="filterTo" class="form-control form-control-sm" value="@(ViewBag.DefaultTo ?? DateTime.Now.ToString("yyyy-MM-dd"))" />
				</div>
				<div class="col-md-4">
					<label class="form-label small mb-1">Tìm kiếm</label>
					<input type="text" id="filterSearch" class="form-control form-control-sm" placeholder="Số CT / Ghi chú / từ khóa" />
				</div>

				<div class="col text-end">
					<div class="btn-group" role="group" aria-label="Actions">
						<button id="btnAddNew" class="btn btn-success btn-sm" type="button">Thêm mới</button>
						<button id="btnPrint" class="btn btn-outline-secondary btn-sm" type="button">In</button>
						<button id="btnExport" class="btn btn-outline-primary btn-sm" type="button">Xuất Excel</button>
					</div>
				</div>
			</div>

					<!-- Inline Add PhieuNhap removed: Add button now redirects to separate Add page -->
		</div>
	</div>

	<!-- placeholder for results / table -->
	<div class="card">
		<div class="card-header">
			<strong>Danh sách phiếu nhập</strong>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-hover">
					<thead>
						<tr>
							<th style="width:120px">Mã PN</th>
							<th>Ngày</th>
							<th>Nhà cung cấp</th>
							<th>Ghi chú</th>
							<th style="width:120px" class="text-end">Tổng tiền</th>
							<th style="width:120px">Thao tác</th>
						</tr>
					</thead>
					<tbody id="nhapThuocTableBody">
						<tr><td colspan="6" class="text-center text-muted">Chưa có dữ liệu — chọn khoảng thời gian và nhấn Tìm kiếm</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

@section Scripts {
<script>
	document.addEventListener('DOMContentLoaded', function () {
		var btnAdd = document.getElementById('btnAddNew');
		var btnPrint = document.getElementById('btnPrint');
		var btnExport = document.getElementById('btnExport');

		// Toggle inline Add form (show/hide)
		btnAdd && btnAdd.addEventListener('click', function () {
			// navigate to FE AddPhieuNhap page (running on localhost:5064)
			window.location.href = 'http://localhost:5064/admin/AddPhieuNhap';
		});

		btnPrint && btnPrint.addEventListener('click', function () {
			window.print();
		});

		btnExport && btnExport.addEventListener('click', function () {
			alert('Xuất Excel - implement export logic');
		});

		var searchEl = document.getElementById('filterSearch');
		if (searchEl) {
			searchEl.addEventListener('keypress', function (e) {
				if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
			});
		}

		document.getElementById('filterFrom').addEventListener('change', doSearch);
		document.getElementById('filterTo').addEventListener('change', doSearch);

		// Inline add was removed; Add button navigates to separate Add page.

	// api base from server (falls back to /api)
	// Use JSON serialization to safely emit the string and avoid accidental 'undefined' values
	var apiBase = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ApiBase ?? "/api/"));
	if (typeof apiBase !== 'string' || !apiBase) apiBase = '/api';
	apiBase = apiBase.replace(/\/$/, '');

	// helper to read either PascalCase or camelCase properties (shared)
	function getProp(obj /*, keys... */) {
		for (var i = 1; i < arguments.length; i++) {
			var k = arguments[i];
			if (obj == null) continue;
			if (obj[k] !== undefined && obj[k] !== null) return obj[k];
		}
		return null;
	}

	// call on initial load (after apiBase is ready)
	doSearch();

	async function doSearch() {
			var from = document.getElementById('filterFrom').value;
			var to = document.getElementById('filterTo').value;
			var q = document.getElementById('filterSearch').value;
			var tbody = document.getElementById('nhapThuocTableBody');

			if (!from || !to) {
				tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Chưa chọn đủ khoảng thời gian</td></tr>';
				return;
			}

			if (new Date(from) > new Date(to)) {
				tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc</td></tr>';
				return;
			}

			tbody.innerHTML = '<tr><td colspan="6" class="text-center">Đang tải...</td></tr>';

			try {
				var url = apiBase + `/PhieuNhap/GetByDateRange?startDate=${encodeURIComponent(from)}&endDate=${encodeURIComponent(to)}`;
				var res = await fetch(url);
				if (!res.ok) {
					tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Lỗi khi gọi API: ${res.status} ${res.statusText}</td></tr>`;
					return;
				}
				var json = await res.json();
				// Api may wrap data in { status, message, data }
				var data = json.data ?? json.Data ?? json;
				if (!data || data.length === 0) {
					tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Không có dữ liệu</td></tr>';
					return;
				}

				// optionally filter by search q (Số CT / Ghi chú / từ khóa)
				if (q && q.trim() !== '') {
					var qLower = q.trim().toLowerCase();
					data = data.filter(function (r) {
						return (r.MaPN && r.MaPN.toLowerCase().includes(qLower)) ||
							(r.GhiChu && r.GhiChu.toLowerCase().includes(qLower));
					});
				}

				tbody.innerHTML = data.map(function (pn) {
					var ngayRaw = getProp(pn, 'NgayNhap', 'ngayNhap');
					var ngay = ngayRaw ? (new Date(ngayRaw)).toLocaleDateString() : '';
					var tenNCC = getProp(pn, 'TenNCC', 'tenNCC') || '';
					var ghi = getProp(pn, 'GhiChu', 'ghiChu') || '';
					var tongVal = getProp(pn, 'TongTien', 'tongTien');
					var tong = tongVal != null ? Number(tongVal).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) : '';
					var maPN = getProp(pn, 'MaPN', 'maPN') || '';
					return `<tr>
						<td>${maPN}</td>
						<td>${ngay}</td>
						<td>${tenNCC}</td>
						<td>${ghi}</td>
						<td class="text-end">${tong}</td>
						<td><button type="button" class="btn btn-sm btn-outline-primary" data-mapn="${maPN}">Chi tiết</button></td>
					</tr>`;
				}).join('');

				// attach detail handlers
				tbody.querySelectorAll('button[data-mapn]').forEach(function (btn) {
					btn.addEventListener('click', function () {
						var ma = this.getAttribute('data-mapn');
						showChiTiet(ma);
					});
				});

			} catch (err) {
				console.error(err);
				tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Lỗi: ${err && err.message ? err.message : err}</td></tr>`;
			}
		}

		async function showChiTiet(maPN) {
			if (!maPN) return;
			try {
				var res = await fetch(apiBase + `/PhieuNhap/GetChiTietPhieuNhapByMaPN?maPN=${encodeURIComponent(maPN)}`);
				if (!res.ok) {
					alert('Không thể tải chi tiết: ' + res.statusText);
					return;
				}
				var json = await res.json();
				var payload = json.data ?? json.Data ?? json;
				// payload may be { phieuNhap: {...}, chiTiet: [...] } or directly an object/array
				var phieu = payload && (payload.phieuNhap || payload.PhieuNhap) ? (payload.phieuNhap || payload.PhieuNhap) : null;
				var chi = payload && (payload.chiTiet || payload.ChiTiet) ? (payload.chiTiet || payload.ChiTiet) : (Array.isArray(payload) ? payload : []);

				var html = '';
				if (!phieu && (!chi || chi.length === 0)) {
					html = '<div class="text-muted">Không có chi tiết</div>';
				} else {
					// build header with main phieuNhap info if present
					if (phieu) {
						var ma = getProp(phieu, 'MaPN', 'maPN') || '';
						var ngayRaw = getProp(phieu, 'NgayNhap', 'ngayNhap');
						var ngay = ngayRaw ? (new Date(ngayRaw)).toLocaleDateString() : '';
						var ncc = getProp(phieu, 'TenNCC', 'tenNCC') || '';
						var nv = getProp(phieu, 'TenNV', 'tenNV') || '';
						var tongVal = getProp(phieu, 'TongTien', 'tongTien');
						var tong = tongVal != null ? Number(tongVal).toLocaleString() : '';
						var ghi = getProp(phieu, 'GhiChu', 'ghiChu') || '';
						html += `<div class="mb-3">
						<div class="row">
							<div class="col-md-4"><strong>Mã PN:</strong> ${ma}</div>
							<div class="col-md-4"><strong>Ngày:</strong> ${ngay}</div>
							<div class="col-md-4"><strong>Nhà cung cấp:</strong> ${ncc}</div>
						</div>
						<div class="row mt-2">
							<div class="col-md-4"><strong>Nhân viên:</strong> ${nv}</div>
							<div class="col-md-4"><strong>Tổng tiền:</strong> ${tong}</div>
							<div class="col-md-4"><strong>Ghi chú:</strong> ${ghi}</div>
						</div>
						</div>`;
					}

					// build chi tiết table
					html += '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Mã CTPN</th><th>Mã thuốc</th><th>Tên thuốc</th><th class="text-end">Số lượng</th><th class="text-end">Đơn giá</th><th class="text-end">Thành tiền</th></tr></thead><tbody>' +
						(chi || []).map(function (r) {
							var maCT = getProp(r, 'MaCTPN', 'maCTPN') || '';
							var maThu = getProp(r, 'MaThuoc', 'maThuoc') || '';
							var tenThu = getProp(r, 'TenThuoc', 'tenThuoc') || '';
							var soLuong = getProp(r, 'SoLuong', 'soLuong') || '';
							var donGiaVal = getProp(r, 'DonGia', 'donGia');
							var donGia = donGiaVal != null ? Number(donGiaVal).toLocaleString() : '';
							var thanhVal = getProp(r, 'ThanhTien', 'thanhTien');
							var thanh = thanhVal != null ? Number(thanhVal).toLocaleString() : '';
							return `<tr><td>${maCT}</td><td>${maThu}</td><td>${tenThu}</td><td class="text-end">${soLuong}</td><td class="text-end">${donGia}</td><td class="text-end">${thanh}</td></tr>`;
						}).join('') + '</tbody></table></div>';
				}

				var modalContent = document.getElementById('chiTietContent');
				if (modalContent) {
					modalContent.innerHTML = html;
					if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
						var modalEl = document.getElementById('chiTietModal');
						var modal = new bootstrap.Modal(modalEl);
						modal.show();
					} else {
						alert('Chi tiết:\n' + JSON.stringify(payload, null, 2));
					}
				} else {
					alert(JSON.stringify(payload, null, 2));
				}

			} catch (err) {
				console.error(err);
				alert('Lỗi khi tải chi tiết: ' + (err.message || err));
			}
		}
	});
</script>

<!-- Modal for chi tiết -->
<div class="modal fade" id="chiTietModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
	<div class="modal-content">
	  <div class="modal-header">
		<h5 class="modal-title">Chi tiết phiếu nhập</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	  </div>
	  <div class="modal-body" id="chiTietContent">
		<!-- populated dynamically -->
	  </div>
	  <div class="modal-footer">
		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
	  </div>
	</div>
  </div>
</div>
}

