@{
    ViewData["Title"] = "Kho - Thuốc";
}

<script>
    // expose ApiBase provided by controller to client JS
    window.apiBase = '@(ViewBag.ApiBase ?? "/api")';
</script>

<style>
    /* Make batch modal wider on large screens */
    #batchModal .modal-dialog { max-width: 1400px; }
    /* Ensure the batch table scrolls horizontally if needed */
    #batchModal .table-responsive { overflow-x: auto; }
    /* typeahead suggestions */
    .tt-suggestions { max-height: 240px; overflow: auto; }
    .tt-item { padding: 6px 8px; cursor: pointer; }
    .tt-item.active, .tt-item:hover { background: #f1f1f1; }
</style>

<!-- Quick convert modal -->
<div class="modal fade" id="quickModal" tabindex="-1" aria-labelledby="quickModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickModalLabel">Đổi nhanh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="quickMaThuoc" />
                <div class="mb-2">Thuốc: <strong id="quickTenThuoc"></strong></div>
                <div class="mb-2">
                    <label class="form-label">Đổi sang đơn vị</label>
                    <select id="quickDonVi" class="form-select">
                        <option value="">Đang tải danh sách...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button id="quickConfirmBtn" type="button" class="btn btn-primary" onclick="performQuickByMa()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch convert modal (Đổi nhiều) -->
<div class="modal fade" id="batchModal" tabindex="-1" aria-labelledby="batchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchModalLabel">Đổi nhiều - Tạo phiếu quy đổi hàng loạt</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Người thao tác</label>
                        <!-- show current employee name, not editable -->
                        <input id="batchMaNV" type="hidden" value="@(ViewBag.MaNV ?? "")" />
                        <input class="form-control" value="@(ViewBag.TenNV ?? "")" disabled />
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Ghi chú phiếu</label>
                        <input id="batchGhiChu" class="form-control" placeholder="Ghi chú chung cho phiếu (tùy chọn)" />
                    </div>
                </div>

                <div class="mb-2 d-flex justify-content-between align-items-center">
                    <h6>Danh sách mục quy đổi</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="addBatchItemRow()">Thêm mục</button>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th style="width:260px">Tên thuốc (gõ để tìm)</th>
                                <th style="width:120px">Đơn vị hiện tại</th>
                                <th style="width:120px">Số lượng còn lại</th>
                                <th style="width:120px">Số lượng gốc</th>
                                <th style="width:200px">Số lượng quy đổi</th>
                                <th>Đổi sang đơn vị</th>
                                <th>Ghi chú</th>
                                <th style="width:80px">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="batch-items"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button id="batchSubmitBtn" type="button" class="btn btn-success" onclick="submitBatchCreate()">Tạo phiếu</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4 px-4">
    <div class="d-flex align-items-center justify-content-between">
        <h2 class="mb-0">Kho - Thuốc</h2>
        <div>
            <button id="btnBatch" type="button" class="btn btn-success" onclick="openBatchModal()">Đổi nhiều</button>
        </div>
    </div>

    <ul class="nav nav-tabs mt-3" id="tabList" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="chua-tab" data-bs-toggle="tab" data-bs-target="#chua" type="button" role="tab">Chưa tách lẻ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="da-tab" data-bs-toggle="tab" data-bs-target="#da" type="button" role="tab">Đã tách lẻ</button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="chua" role="tabpanel">
            <div id="loading-chua" class="text-muted">Đang tải...</div>
            <div class="table-responsive" id="table-chua" style="display:none">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Mã lô</th>
                            <th>Mã thuốc</th>
                            <th>Tên thuốc</th>
                            <th>Số lượng quy đổi</th>
                            <th>Đơn vị gốc</th>
                            <th>Số lượng còn</th>
                            <th>Hạn sử dụng</th>
                            <th>Ghi chú</th>
                            <th style="min-width:120px">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-chua"></tbody>
                </table>
                <div id="pagination-chua" class="mt-2"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="da" role="tabpanel">
            <div id="loading-da" class="text-muted">Đang tải...</div>
            <div class="table-responsive" id="table-da" style="display:none">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Mã lô</th>
                            <th>Mã thuốc</th>
                            <th>Tên thuốc</th>
                            <th>Số lượng quy đổi</th>
                            <th>Đơn vị lẻ</th>
                            <th>Số lượng còn lẻ</th>
                            <th>Hạn sử dụng</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-da"></tbody>
                </table>
                <div id="pagination-da" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // API endpoints
    const apiChua = (window['apiBase'] || '') + '/api/ThuocView/ChuaTachLe';
    const apiDa = (window['apiBase'] || '') + '/api/ThuocView/DaTachLe';
    const apiLoaiDonVi = (window['apiBase'] || '') + '/api/Thuoc/LoaiDonVi';
    const apiTongSoLuong = (window['apiBase'] || '') + '/api/ThuocView/TongSoLuongCon';

    const PAGE_SIZE = 10;

    function fmtDate(d) { if (!d) return ''; try { return new Date(d).toLocaleDateString(); } catch { return d; } }

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    async function loadChua() {
        document.getElementById('loading-chua').style.display = 'block';
        document.getElementById('table-chua').style.display = 'none';
        try {
            const res = await fetch(apiChua);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const list = await res.json();
            renderTableWithPagination(list, 'tbody-chua', 'pagination-chua', renderChuaRow);
            document.getElementById('table-chua').style.display = '';
        } catch (e) {
            document.getElementById('tbody-chua').innerHTML = `<tr><td colspan="8" class="text-danger">Lỗi tải dữ liệu: ${e.message}</td></tr>`;
            document.getElementById('table-chua').style.display = '';
        } finally {
            document.getElementById('loading-chua').style.display = 'none';
        }
    }

    async function loadDa() {
        document.getElementById('loading-da').style.display = 'block';
        document.getElementById('table-da').style.display = 'none';
        try {
            const res = await fetch(apiDa);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const list = await res.json();
            renderTableWithPagination(list, 'tbody-da', 'pagination-da', renderDaRow);
            document.getElementById('table-da').style.display = '';
        } catch (e) {
            document.getElementById('tbody-da').innerHTML = `<tr><td colspan="8" class="text-danger">Lỗi tải dữ liệu: ${e.message}</td></tr>`;
            document.getElementById('table-da').style.display = '';
        } finally {
            document.getElementById('loading-da').style.display = 'none';
        }
    }

    function renderChuaRow(it) {
        const ma = escapeHtml(it.maThuoc ?? it.MaThuoc ?? '');
        const ten = escapeHtml(it.tenThuoc ?? it.TenThuoc ?? '');
        const dv = escapeHtml(it.donViGoc ?? it.DonViGoc ?? 'Viên');
        return `
            <td>${it.maLo ?? it.MaLo ?? ''}</td>
            <td>${ma}</td>
            <td>${ten}</td>
            <td>${it.soLuong ?? it.SoLuong ?? ''}</td>
            <td>${dv}</td>
            <td>${it.soLuongCon ?? it.SoLuongCon ?? ''}</td>
            <td>${fmtDate(it.hanSuDung ?? it.HanSuDung)}</td>
            <td>${it.ghiChu ?? it.GhiChu ?? ''}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openQuickModal('${ma}','${ten}','${dv}')">Đổi nhanh</button>
            </td>
        `;
    }

    function renderDaRow(it) {
        const ma = escapeHtml(it.maThuoc ?? it.MaThuoc ?? '');
        const ten = escapeHtml(it.tenThuoc ?? it.TenThuoc ?? '');
        const dv = escapeHtml(it.donViLe ?? it.DonViLe ?? 'Viên');
        return `
            <td>${it.maLo ?? it.MaLo ?? ''}</td>
            <td>${ma}</td>
            <td>${ten}</td>
            <td>${it.soLuong ?? it.SoLuong ?? ''}</td>
            <td>${dv}</td>
            <td>${it.soLuongConLe ?? it.SoLuongConLe ?? ''}</td>
            <td>${fmtDate(it.hanSuDung ?? it.HanSuDung)}</td>
            <td>${it.ghiChu ?? it.GhiChu ?? ''}</td>
        `;
    }

    // Quick modal
    function openQuickModal(maThuoc, tenThuoc, defaultDonVi) {
        const modal = document.getElementById('quickModal');
        document.getElementById('quickMaThuoc').value = maThuoc;
        document.getElementById('quickTenThuoc').textContent = tenThuoc;
        document.getElementById('quickDonVi').value = defaultDonVi || 'Viên';
        try { new bootstrap.Modal(modal).show(); } catch { modal.style.display = 'block'; }
    }

    async function performQuickByMa() {
        const btn = document.getElementById('quickConfirmBtn');
        const ma = document.getElementById('quickMaThuoc').value;
        const donVi = document.getElementById('quickDonVi').value;
        btn.disabled = true; btn.textContent = 'Đang thực hiện...';
        try {
            const api = (window['apiBase'] || '') + '/api/PhieuQuyDoi/QuickByMa';
            const res = await fetch(api, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ MaThuoc: ma, DonViMoi: donVi }) });
            const payload = await res.json();
            if (!res.ok || payload?.status === -1) alert('Thao tác thất bại: ' + (payload?.message || res.statusText));
            else { alert('Đổi nhanh thành công.'); try { bootstrap.Modal.getInstance(document.getElementById('quickModal')).hide(); } catch {} loadChua(); loadDa(); }
        } catch (e) { alert('Lỗi khi gọi API: ' + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Xác nhận'; }
    }

    // Batch modal helpers
    function openBatchModal() {
        const modalEl = document.getElementById('batchModal');
        const tbody = document.getElementById('batch-items');
        if (!modalEl) return; if (tbody) tbody.innerHTML = '';
        addBatchItemRow();
        try { new bootstrap.Modal(modalEl, { backdrop: true }).show(); } catch { modalEl.classList.add('show'); modalEl.style.display = 'block'; }
    }

    function addBatchItemRow(data) {
        const tbody = document.getElementById('batch-items'); if (!tbody) return;
        const tr = document.createElement('tr');
        const ten = (data?.tenThuoc) ?? '';
        const so = (data?.soLuongGoc) ?? '';
        const up = (data?.unitsPerPackage) ?? '';
        const dv = (data?.donViMoi) ?? '';
        const gh = (data?.ghiChu) ?? '';
        // ten input + hidden ma
        tr.innerHTML = `
            <td style="position:relative">
                <input class="form-control form-control-sm bi-tenThuoc" value="${escapeHtml(ten)}" placeholder="Gõ tên thuốc..." autocomplete="off" />
                <input type="hidden" class="bi-maThuocHidden" value="" />
                <div class="tt-suggestions position-absolute border bg-white" style="display:none; left:0; right:0; z-index:2050"></div>
            </td>
            <td><span class="form-control form-control-sm bi-donViHienTai" style="background:#f8f9fa"></span></td>
            <td><span class="form-control form-control-sm bi-soLuongConHienTai" style="background:#f8f9fa"></span></td>
            <td><input type="number" min="0" class="form-control form-control-sm bi-soLuongGoc" value="${escapeHtml(so)}" /></td>
            <td><input type="number" min="0" class="form-control form-control-sm bi-soLuongQuyDoi" value="" /></td>
            <td><select class="form-select form-select-sm bi-donVi">${getDonViOptionsHtml(dv)}</select></td>
            <td><input class="form-control form-control-sm bi-ghiChu" value="${escapeHtml(gh)}" /></td>
            <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Xóa</button></td>
        `;
        tbody.appendChild(tr);
        const tenInput = tr.querySelector('.bi-tenThuoc');
        if (tenInput) {
            tenInput.addEventListener('input', (e) => onTenInput(e, tr));
            tenInput.addEventListener('keydown', (e) => onTenKeyDown(e, tr));
            tenInput.addEventListener('blur', () => setTimeout(() => hideTypeahead(tr), 150));
        }
    // the final converted quantity is editable directly by the user
        // if initial data provided with ten or ma, attempt to resolve
    if (ten) onTenThuocChange(tr, ten);
    }

    // when user types/selects a drug name, resolve to MaThuoc and populate unit, qty, default converted
    function onTenThuocChange(tr, tenValue) {
        const hiddenMa = tr.querySelector('.bi-maThuocHidden');
        const donViEl = tr.querySelector('.bi-donViHienTai');
        const soEl = tr.querySelector('.bi-soLuongConHienTai');
        const convertedInput = tr.querySelector('.bi-soLuongQuyDoi');
        if (!tenValue) {
            if (hiddenMa) hiddenMa.value = '';
            if (donViEl) donViEl.textContent = '';
            if (soEl) soEl.textContent = '';
            if (convertedInput) convertedInput.value = '';
            return;
        }
        // ensure availableSummary loaded
        const list = window.availableList || [];
        // try match by name (exact) or by ma
        let found = list.find(i => (i.tenThuoc ?? i.ten)?.toString().toLowerCase() === tenValue.toLowerCase());
        if (!found) found = list.find(i => (i.maThuoc ?? i.MaThuoc)?.toString().toLowerCase() === tenValue.toLowerCase());
        if (!found) {
            // try partial match first item
            found = list.find(i => ((i.tenThuoc ?? i.ten) || '').toString().toLowerCase().includes(tenValue.toLowerCase()));
        }
        if (found) {
            if (hiddenMa) hiddenMa.value = found.maThuoc ?? found.MaThuoc ?? '';
            if (donViEl) donViEl.textContent = found.donViTinh ?? found.DonViTinh ?? '';
            if (soEl) soEl.textContent = (found.tongSoLuongCon ?? found.TongSoLuongCon ?? found.tongSoLuongCon ?? 0).toString();
            // set editable converted qty input to Thuoc.SoLuong by default only if user didn't fill it
            const convertedInputEl = tr.querySelector('.bi-soLuongQuyDoi');
            if (convertedInputEl && (!convertedInputEl.value || convertedInputEl.value === '')) convertedInputEl.value = (found.soLuong ?? found.SoLuong ?? '').toString();
            // also update default if other heuristics apply
            try { updateRowDefault(tr); } catch (e) { /* ignore */ }
        } else {
            if (hiddenMa) hiddenMa.value = '';
            if (donViEl) donViEl.textContent = '';
            if (soEl) soEl.textContent = '';
            if (dst) dst.textContent = '';
        }
    }

    // --- Typeahead helpers ---
    function onTenInput(e, tr) {
        const q = (e.target.value || '').trim();
        const suggestionsEl = tr.querySelector('.tt-suggestions');
        if (!suggestionsEl) return;
        if (!q) { hideTypeahead(tr); return; }
        const list = window.availableList || [];
        const ql = q.toLowerCase();
        const matches = list.filter(i => ((i.tenThuoc ?? i.ten) || '').toString().toLowerCase().includes(ql) || ((i.maThuoc ?? i.MaThuoc)||'').toString().toLowerCase().includes(ql));
        renderTypeaheadMatches(tr, matches.slice(0, 20));
    }

    function onTenKeyDown(e, tr) {
        const suggestionsEl = tr.querySelector('.tt-suggestions');
        if (!suggestionsEl || suggestionsEl.style.display === 'none') return;
        const items = Array.from(suggestionsEl.querySelectorAll('.tt-item'));
        const activeIndex = items.findIndex(it => it.classList.contains('active'));
        if (e.key === 'ArrowDown') { e.preventDefault(); const next = Math.min(items.length - 1, Math.max(0, activeIndex + 1)); setActive(items, next); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); const prev = Math.min(items.length - 1, Math.max(0, activeIndex - 1)); setActive(items, prev); }
        else if (e.key === 'Enter') { e.preventDefault(); if (activeIndex >= 0 && items[activeIndex]) { items[activeIndex].click(); } else { // try accept first
                if (items[0]) items[0].click(); } }
        else if (e.key === 'Escape') { hideTypeahead(tr); }
    }

    function renderTypeaheadMatches(tr, matches) {
        const el = tr.querySelector('.tt-suggestions');
        if (!el) return; el.innerHTML = '';
        if (!matches || matches.length === 0) { hideTypeahead(tr); return; }
        for (const m of matches) {
            const div = document.createElement('div'); div.className = 'tt-item'; div.dataset.ma = m.maThuoc ?? m.MaThuoc ?? ''; div.dataset.ten = m.tenThuoc ?? m.ten ?? ''; div.innerHTML = `<div style="font-weight:600">${escapeHtml(m.tenThuoc ?? m.ten ?? '')}</div><div style="font-size:12px;color:#666">${escapeHtml(m.maThuoc ?? m.MaThuoc ?? '')} · ${escapeHtml(m.donViTinh ?? m.DonViTinh ?? '')} · SL:${(m.tongSoLuongCon ?? m.TongSoLuongCon ?? m.tongSoLuongCon ?? 0)}</div>`;
            div.addEventListener('click', () => { selectSuggestion(tr, m); });
            el.appendChild(div);
        }
        el.style.display = '';
    }

    function hideTypeahead(tr) {
        const el = tr.querySelector('.tt-suggestions'); if (el) el.style.display = 'none';
    }

    function setActive(items, idx) {
        items.forEach((it, i) => { if (i === idx) it.classList.add('active'); else it.classList.remove('active'); });
        if (idx >= 0 && items[idx]) items[idx].scrollIntoView({ block: 'nearest' });
    }

    function selectSuggestion(tr, item) {
        // item can be object or DOM dataset
        const ma = item.maThuoc ?? item.MaThuoc ?? item.ma ?? '';
        const ten = item.tenThuoc ?? item.ten ?? item.dataset?.ten ?? '';
        const donVi = item.donViTinh ?? item.DonViTinh ?? (item.dataset ? item.dataset.donvi : '') ?? '';
        const tong = (item.tongSoLuongCon ?? item.TongSoLuongCon ?? item.tongSoLuongCon ?? item.soLuong ?? item.SoLuong ?? 0);
        const hidden = tr.querySelector('.bi-maThuocHidden'); if (hidden) hidden.value = ma;
        const tenInput = tr.querySelector('.bi-tenThuoc'); if (tenInput) tenInput.value = ten;
        const donViEl = tr.querySelector('.bi-donViHienTai'); if (donViEl) donViEl.textContent = donVi;
        const soEl = tr.querySelector('.bi-soLuongConHienTai'); if (soEl) soEl.textContent = (item.tongSoLuongCon ?? item.TongSoLuongCon ?? item.tongSoLuongCon ?? 0).toString();
        const convertedInputEl = tr.querySelector('.bi-soLuongQuyDoi');
        // only set converted qty if user hasn't entered a value yet
        if (convertedInputEl && (!convertedInputEl.value || convertedInputEl.value === '')) convertedInputEl.value = (item.soLuong ?? item.SoLuong ?? item.soLuong ?? '').toString();
        hideTypeahead(tr);
    }

    async function submitBatchCreate() {
        const btn = document.getElementById('batchSubmitBtn'); btn.disabled = true; btn.textContent = 'Đang gửi...';
        try {
            const maNV = document.getElementById('batchMaNV')?.value;
            const ghiChu = document.getElementById('batchGhiChu')?.value;
            const items = [];
            const rows = Array.from(document.querySelectorAll('#batch-items tr'));
            for (const r of rows) {
                const maHidden = r.querySelector('.bi-maThuocHidden')?.value?.trim();
                const ten = r.querySelector('.bi-tenThuoc')?.value?.trim();
                const so = parseInt(r.querySelector('.bi-soLuongGoc')?.value || '0');
                const up = parseInt(r.querySelector('.bi-unitsPerPackage')?.value || '0');
                const dv = r.querySelector('.bi-donVi')?.value || '';
                const gh = r.querySelector('.bi-ghiChu')?.value || '';
                if (!maHidden && !ten) continue; // skip empty
                const converted = parseInt(r.querySelector('.bi-soLuongQuyDoi')?.value || '') || null;
                items.push({ maThuoc: maHidden || null, tenThuoc: ten || null, soLuongGoc: isNaN(so) ? 0 : so, soLuongQuyDoi: converted, donViMoi: dv, ghiChu: gh });
            }
            if (items.length === 0) { alert('Vui lòng thêm ít nhất 1 mục hợp lệ (tên thuốc + số lượng).'); return; }
            const body = { items, maNV: maNV || null, ghiChu: ghiChu || null };
            const api = (window['apiBase'] || '') + '/api/PhieuQuyDoi/Create';
            const res = await fetch(api, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const payload = await res.json();
            if (!res.ok || payload?.status === -1) alert('Tạo phiếu thất bại: ' + (payload?.message || res.statusText));
            else { alert('Đổi nhiều thành công.'); try { bootstrap.Modal.getInstance(document.getElementById('batchModal')).hide(); } catch {} loadChua(); loadDa(); }
        } catch (e) { alert('Lỗi khi gửi yêu cầu: ' + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Tạo phiếu'; }
    }

    // available summary loader - cache list and map
    async function loadAvailableSummary() {
        try {
            const res = await fetch(apiTongSoLuong);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const payload = await res.json();
            let list = [];
            if (Array.isArray(payload)) list = payload;
            else if (Array.isArray(payload?.data)) list = payload.data;
            else if (Array.isArray(payload?.Data)) list = payload.Data;
            // store both list and map
            window.availableList = list || [];
            const map = {};
            for (const it of (list || [])) { const key = (it.MaThuoc ?? it.maThuoc ?? '').toString(); map[key] = it; }
            window.availableSummary = map;
            return { list: window.availableList, map: window.availableSummary };
        } catch (e) { console.warn('Could not load available summary', e); window.availableList = window.availableList || []; window.availableSummary = window.availableSummary || {}; return { list: window.availableList, map: window.availableSummary }; }
    }

    function updateRowAvailable(tr, ma) {
        // keep for API compatibility: fill donVi and soLuongCon if ma provided
        const donViEl = tr.querySelector('.bi-donViHienTai');
        const soEl = tr.querySelector('.bi-soLuongConHienTai');
        if (!ma) { if (donViEl) donViEl.textContent = ''; if (soEl) soEl.textContent = ''; try { updateRowDefault(tr); } catch {} return; }
        const map = window.availableSummary || {};
        const item = map[ma] || null;
        if (item) { if (donViEl) donViEl.textContent = item.donViTinh ?? item.DonViTinh ?? ''; if (soEl) soEl.textContent = (item.tongSoLuongCon ?? item.TongSoLuongCon ?? item.tongSoLuongCon ?? 0).toString(); try { updateRowDefault(tr); } catch {} }
        else { loadAvailableSummary().then(() => { const it2 = (window.availableSummary || {})[ma]; if (donViEl) donViEl.textContent = it2 ? (it2.donViTinh ?? it2.DonViTinh ?? '') : ''; if (soEl) soEl.textContent = it2 ? ((it2.tongSoLuongCon ?? it2.TongSoLuongCon ?? it2.tongSoLuongCon ?? 0).toString()) : ''; try { updateRowDefault(tr); } catch {} }).catch(() => { if (donViEl) donViEl.textContent = ''; if (soEl) soEl.textContent = ''; try { updateRowDefault(tr); } catch {} }); }
    }

    function updateRowDefault(tr) {
        if (!tr) return;
        const maHidden = tr.querySelector('.bi-maThuocHidden');
        const tenInput = tr.querySelector('.bi-tenThuoc');
        const convertedInput = tr.querySelector('.bi-soLuongQuyDoi');
        let defaultQty = '';
        const ma = maHidden ? (maHidden.value || '').trim() : '';
        // prefer lookup by ma
        if (ma) {
            const map = window.availableSummary || {};
            const it = map[ma];
            const soLuong = it ? (it.soLuong ?? it.SoLuong ?? it.tongSoLuongCon ?? it.TongSoLuongCon ?? 0) : 0;
            if (soLuong) defaultQty = soLuong.toString();
        }
        // fallback: if ma not present but ten given, try to resolve name from list
        if (!defaultQty && tenInput) {
            const name = tenInput.value?.trim();
            if (name) {
                const list = window.availableList || [];
                const it = list.find(i => ((i.tenThuoc ?? i.ten) || '').toString().toLowerCase() === name.toLowerCase()) || list.find(i => ((i.tenThuoc ?? i.ten) || '').toString().toLowerCase().includes(name.toLowerCase()));
                if (it) defaultQty = (it.soLuong ?? it.SoLuong ?? it.tongSoLuongCon ?? it.TongSoLuongCon ?? '').toString();
            }
        }
        // set only when user hasn't provided a value yet
        if (convertedInput && (!convertedInput.value || convertedInput.value === '')) convertedInput.value = defaultQty;
    }

    async function loadLoaiDonVi() {
        const sel = document.getElementById('quickDonVi'); if (!sel) return;
        try { const res = await fetch(apiLoaiDonVi); if (!res.ok) throw new Error('HTTP ' + res.status); const payload = await res.json(); const list = payload?.data ?? []; window.loaiDonViOptions = list; sel.innerHTML = ''; if (!Array.isArray(list) || list.length === 0) { const o = document.createElement('option'); o.value = ''; o.textContent = 'Không có đơn vị'; sel.appendChild(o); return; } for (const it of list) { const o = document.createElement('option'); o.value = it.tenLoaiDonVi ?? it.ten ?? it.maLoaiDonVi ?? it.ma ?? ''; o.textContent = it.tenLoaiDonVi ?? it.ten ?? o.value; sel.appendChild(o); } }
        catch (e) { sel.innerHTML = ''; const o = document.createElement('option'); o.value = ''; o.textContent = 'Lỗi tải đơn vị'; sel.appendChild(o); }
    }

    function getDonViOptionsHtml(selected) {
        const list = window.loaiDonViOptions ?? []; if (!Array.isArray(list) || list.length === 0) return '<option value="">(không có)</option>';
        return list.map(it => { const val = (it.tenLoaiDonVi ?? it.ten ?? it.maLoaiDonVi ?? it.ma ?? '').replace(/"/g,'&quot;'); const sel = val === (selected ?? '') ? ' selected' : ''; return `<option value="${val}"${sel}>${it.tenLoaiDonVi ?? it.ten ?? val}</option>`; }).join('');
    }

    function renderTableWithPagination(list, tbodyId, paginationId, rowRenderer) {
        const tbody = document.getElementById(tbodyId); const pagination = document.getElementById(paginationId); if (!tbody) return; if (!Array.isArray(list)) list = [];
        const total = list.length; const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        function showPage(page) { tbody.innerHTML = ''; const start = (page - 1) * PAGE_SIZE; const slice = list.slice(start, start + PAGE_SIZE); for (const it of slice) { const tr = document.createElement('tr'); tr.innerHTML = rowRenderer(it); tbody.appendChild(tr); } renderPaginationControls(pagination, totalPages, page, (p) => showPage(p)); }
        if (total <= PAGE_SIZE) { pagination.innerHTML = ''; showPage(1); } else { showPage(1); }
    }

    function renderPaginationControls(container, totalPages, currentPage, onPage) {
        if (!container) return; container.innerHTML = ''; const ul = document.createElement('ul'); ul.className = 'pagination';
        function makeLi(label, page, disabled, active) { const li = document.createElement('li'); li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : ''); const a = document.createElement('a'); a.className = 'page-link'; a.href = '#'; a.textContent = label; a.onclick = (e) => { e.preventDefault(); if (!disabled) onPage(page); }; li.appendChild(a); return li; }
        ul.appendChild(makeLi('«', Math.max(1, currentPage - 1), currentPage === 1, false));
        const maxButtons = 7; let start = Math.max(1, currentPage - Math.floor(maxButtons / 2)); let end = Math.min(totalPages, start + maxButtons - 1); if (end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);
        for (let p = start; p <= end; p++) ul.appendChild(makeLi(p.toString(), p, false, p === currentPage));
        ul.appendChild(makeLi('»', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false)); container.appendChild(ul);
    }

    // hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
        document.querySelectorAll('.tt-suggestions').forEach(el => {
            if (!el.contains(e.target) && !el.previousElementSibling?.contains(e.target)) el.style.display = 'none';
        });
    });

    document.addEventListener('DOMContentLoaded', () => { loadLoaiDonVi(); loadChua(); loadDa(); loadAvailableSummary(); try { const btn = document.getElementById('btnBatch'); if (btn) btn.addEventListener('click', openBatchModal); } catch (e) { console.warn('Could not attach btnBatch listener', e); } });
</script>
